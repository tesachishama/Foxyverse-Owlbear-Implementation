(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();var L=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class Jt{constructor(e){this.messageBus=e}get id(){if(!this.messageBus.userId)throw Error("Unable to get user ID: not ready");return this.messageBus.userId}getSelection(){return L(this,void 0,void 0,function*(){const{selection:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SELECTION",{});return e})}select(e,n){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:e,replace:n})})}deselect(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_DESELECT",{items:e})})}getName(){return L(this,void 0,void 0,function*(){const{name:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_NAME",{});return e})}setName(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_NAME",{name:e})})}getColor(){return L(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_COLOR",{});return e})}setColor(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_COLOR",{color:e})})}getSyncView(){return L(this,void 0,void 0,function*(){const{syncView:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SYNC_VIEW",{});return e})}setSyncView(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_SYNC_VIEW",{syncView:e})})}getId(){return L(this,void 0,void 0,function*(){const{id:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ID",{});return e})}getRole(){return L(this,void 0,void 0,function*(){const{role:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ROLE",{});return e})}getMetadata(){return L(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_METADATA",{});return e})}setMetadata(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_METADATA",{update:e})})}hasPermission(e){return L(this,void 0,void 0,function*(){if((yield this.getRole())==="GM")return!0;const{permissions:s}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return s.indexOf(e)>-1})}getConnectionId(){return L(this,void 0,void 0,function*(){const{connectionId:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_CONNECTION_ID",{});return e})}onChange(e){const n=s=>{e(s.player)};return this.messageBus.send("OBR_PLAYER_SUBSCRIBE",{}),this.messageBus.on("OBR_PLAYER_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PLAYER_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PLAYER_EVENT_CHANGE",n)}}}var H=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class Xt{constructor(e){this.messageBus=e}reset(){return H(this,void 0,void 0,function*(){const{transform:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_RESET",{});return e})}animateTo(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO",{transform:e})})}animateToBounds(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO_BOUNDS",{bounds:e})})}getPosition(){return H(this,void 0,void 0,function*(){const{position:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_POSITION",{});return e})}setPosition(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_POSITION",{position:e})})}getScale(){return H(this,void 0,void 0,function*(){const{scale:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_SCALE",{});return e})}setScale(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_SCALE",{scale:e})})}getWidth(){return H(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_WIDTH",{});return e})}getHeight(){return H(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_HEIGHT",{});return e})}transformPoint(e){return H(this,void 0,void 0,function*(){const{point:n}=yield this.messageBus.sendAsync("OBR_VIEWPORT_TRANSFORM_POINT",{point:e});return n})}inverseTransformPoint(e){return H(this,void 0,void 0,function*(){const{point:n}=yield this.messageBus.sendAsync("OBR_VIEWPORT_INVERSE_TRANSFORM_POINT",{point:e});return n})}}function Zt(t){return typeof t.id=="string"}var We={exports:{}},te=typeof Reflect=="object"?Reflect:null,at=te&&typeof te.apply=="function"?te.apply:function(e,n,s){return Function.prototype.apply.call(e,n,s)},me;te&&typeof te.ownKeys=="function"?me=te.ownKeys:Object.getOwnPropertySymbols?me=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:me=function(e){return Object.getOwnPropertyNames(e)};function Qt(t){console&&console.warn&&console.warn(t)}var Bt=Number.isNaN||function(e){return e!==e};function A(){A.init.call(this)}We.exports=A;We.exports.once=sn;A.EventEmitter=A;A.prototype._events=void 0;A.prototype._eventsCount=0;A.prototype._maxListeners=void 0;var rt=10;function Oe(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(A,"defaultMaxListeners",{enumerable:!0,get:function(){return rt},set:function(t){if(typeof t!="number"||t<0||Bt(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");rt=t}});A.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};A.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Bt(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Rt(t){return t._maxListeners===void 0?A.defaultMaxListeners:t._maxListeners}A.prototype.getMaxListeners=function(){return Rt(this)};A.prototype.emit=function(e){for(var n=[],s=1;s<arguments.length;s++)n.push(arguments[s]);var o=e==="error",i=this._events;if(i!==void 0)o=o&&i.error===void 0;else if(!o)return!1;if(o){var r;if(n.length>0&&(r=n[0]),r instanceof Error)throw r;var u=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw u.context=r,u}var d=i[e];if(d===void 0)return!1;if(typeof d=="function")at(d,this,n);else for(var c=d.length,a=wt(d,c),s=0;s<c;++s)at(a[s],this,n);return!0};function St(t,e,n,s){var o,i,r;if(Oe(n),i=t._events,i===void 0?(i=t._events=Object.create(null),t._eventsCount=0):(i.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),i=t._events),r=i[e]),r===void 0)r=i[e]=n,++t._eventsCount;else if(typeof r=="function"?r=i[e]=s?[n,r]:[r,n]:s?r.unshift(n):r.push(n),o=Rt(t),o>0&&r.length>o&&!r.warned){r.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=r.length,Qt(u)}return t}A.prototype.addListener=function(e,n){return St(this,e,n,!1)};A.prototype.on=A.prototype.addListener;A.prototype.prependListener=function(e,n){return St(this,e,n,!0)};function en(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ct(t,e,n){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},o=en.bind(s);return o.listener=n,s.wrapFn=o,o}A.prototype.once=function(e,n){return Oe(n),this.on(e,Ct(this,e,n)),this};A.prototype.prependOnceListener=function(e,n){return Oe(n),this.prependListener(e,Ct(this,e,n)),this};A.prototype.removeListener=function(e,n){var s,o,i,r,u;if(Oe(n),o=this._events,o===void 0)return this;if(s=o[e],s===void 0)return this;if(s===n||s.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,s.listener||n));else if(typeof s!="function"){for(i=-1,r=s.length-1;r>=0;r--)if(s[r]===n||s[r].listener===n){u=s[r].listener,i=r;break}if(i<0)return this;i===0?s.shift():tn(s,i),s.length===1&&(o[e]=s[0]),o.removeListener!==void 0&&this.emit("removeListener",e,u||n)}return this};A.prototype.off=A.prototype.removeListener;A.prototype.removeAllListeners=function(e){var n,s,o;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var i=Object.keys(s),r;for(o=0;o<i.length;++o)r=i[o],r!=="removeListener"&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=s[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(o=n.length-1;o>=0;o--)this.removeListener(e,n[o]);return this};function It(t,e,n){var s=t._events;if(s===void 0)return[];var o=s[e];return o===void 0?[]:typeof o=="function"?n?[o.listener||o]:[o]:n?nn(o):wt(o,o.length)}A.prototype.listeners=function(e){return It(this,e,!0)};A.prototype.rawListeners=function(e){return It(this,e,!1)};A.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):Nt.call(t,e)};A.prototype.listenerCount=Nt;function Nt(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}A.prototype.eventNames=function(){return this._eventsCount>0?me(this._events):[]};function wt(t,e){for(var n=new Array(e),s=0;s<e;++s)n[s]=t[s];return n}function tn(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function nn(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function sn(t,e){return new Promise(function(n,s){function o(r){t.removeListener(e,i),s(r)}function i(){typeof t.removeListener=="function"&&t.removeListener("error",o),n([].slice.call(arguments))}Mt(t,e,i,{once:!0}),e!=="error"&&on(t,o,{once:!0})})}function on(t,e,n){typeof t.on=="function"&&Mt(t,"error",e,n)}function Mt(t,e,n,s){if(typeof t.on=="function")s.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function o(i){s.once&&t.removeEventListener(e,o),n(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}var an=We.exports;let ue;const rn=new Uint8Array(16);function ln(){if(!ue&&(ue=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ue))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ue(rn)}const I=[];for(let t=0;t<256;++t)I.push((t+256).toString(16).slice(1));function cn(t,e=0){return I[t[e+0]]+I[t[e+1]]+I[t[e+2]]+I[t[e+3]]+"-"+I[t[e+4]]+I[t[e+5]]+"-"+I[t[e+6]]+I[t[e+7]]+"-"+I[t[e+8]]+I[t[e+9]]+"-"+I[t[e+10]]+I[t[e+11]]+I[t[e+12]]+I[t[e+13]]+I[t[e+14]]+I[t[e+15]]}const dn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),lt={randomUUID:dn};function un(t,e,n){if(lt.randomUUID&&!t)return lt.randomUUID();t=t||{};const s=t.random||(t.rng||ln)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,cn(s)}class fn extends an.EventEmitter{constructor(e,n){super(),this.ready=!1,this.userId=null,this.ref=null,this.handleMessage=s=>{const o=s.data;if(s.origin===this.targetOrigin&&Zt(o)){if(o.id==="OBR_READY"){this.ready=!0;const i=o.data;this.ref=i.ref,this.userId=i.userId}this.emit(o.id,o.data)}},this.send=(s,o,i)=>{var r;if(!this.ref)throw Error("Unable to send message: not ready");(r=window.parent)===null||r===void 0||r.postMessage({id:s,data:o,ref:this.ref,nonce:i},this.targetOrigin)},this.sendAsync=(s,o,i=5e3)=>{const r=`_${un()}`;return this.send(s,o,r),Promise.race([new Promise((u,d)=>{const c=this;function a(v){c.off(`${s}_RESPONSE${r}`,a),c.off(`${s}_ERROR${r}`,f),u(v)}function f(v){c.off(`${s}_RESPONSE${r}`,a),c.off(`${s}_ERROR${r}`,f),d(v)}this.on(`${s}_RESPONSE${r}`,a),this.on(`${s}_ERROR${r}`,f)}),new Promise((u,d)=>window.setTimeout(()=>d(new Error(`Message ${s} took longer than ${i}ms to get a result`)),i))])},this.roomId=n,this.targetOrigin=e,window.addEventListener("message",this.handleMessage),this.setMaxListeners(100)}destroy(){window.removeEventListener("message",this.handleMessage)}}var ct=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class hn{constructor(e){this.messageBus=e}show(e,n){return ct(this,void 0,void 0,function*(){const{id:s}=yield this.messageBus.sendAsync("OBR_NOTIFICATION_SHOW",{message:e,variant:n});return s})}close(e){return ct(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_NOTIFICATION_CLOSE",{id:e})})}}var X=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class pn{constructor(e){this.messageBus=e}getColor(){return X(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_COLOR",{});return e})}setColor(e){return X(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_COLOR",{color:e})})}getStrokeWidth(){return X(this,void 0,void 0,function*(){const{strokeWidth:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_STROKE_WIDTH",{});return e})}setStrokeWidth(e){return X(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_STROKE_WIDTH",{strokeWidth:e})})}getFilled(){return X(this,void 0,void 0,function*(){const{filled:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_FILLED",{});return e})}setFilled(e){return X(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_FILLED",{filled:e})})}onChange(e){const n=s=>{e(s.fog)};return this.messageBus.send("OBR_SCENE_FOG_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_FOG_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_FOG_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_FOG_EVENT_CHANGE",n)}}}var $=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class mn{constructor(e){this.messageBus=e}getDpi(){return $(this,void 0,void 0,function*(){const{dpi:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DPI",{});return e})}getScale(){return $(this,void 0,void 0,function*(){return yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_SCALE",{})})}setScale(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_SCALE",{scale:e})})}getColor(){return $(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_COLOR",{});return e})}setColor(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_COLOR",{color:e})})}getOpacity(){return $(this,void 0,void 0,function*(){const{opacity:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_OPACITY",{});return e})}setOpacity(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_OPACITY",{opacity:e})})}getType(){return $(this,void 0,void 0,function*(){const{type:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_TYPE",{});return e})}setType(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_TYPE",{type:e})})}getLineType(){return $(this,void 0,void 0,function*(){const{lineType:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_LINE_TYPE",{});return e})}setLineType(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_LINE_TYPE",{lineType:e})})}getMeasurement(){return $(this,void 0,void 0,function*(){const{measurement:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_MEASUREMENT",{});return e})}setMeasurement(e){return $(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_MEASUREMENT",{measurement:e})})}snapPosition(e,n,s){return $(this,void 0,void 0,function*(){const{position:o}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_SNAP_POSITION",{position:e,snappingSensitivity:n,useCorners:s});return o})}getDistance(e,n){return $(this,void 0,void 0,function*(){const{distance:s}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DISTANCE",{from:e,to:n});return s})}onChange(e){const n=s=>{e(s.grid)};return this.messageBus.send("OBR_SCENE_GRID_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_GRID_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_GRID_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_GRID_EVENT_CHANGE",n)}}}var fe=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class yn{constructor(e){this.messageBus=e}undo(){return fe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_UNDO",{})})}redo(){return fe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_REDO",{})})}canUndo(){return fe(this,void 0,void 0,function*(){const{canUndo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_UNDO",{});return e})}canRedo(){return fe(this,void 0,void 0,function*(){const{canRedo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_REDO",{});return e})}}function w(t){for(var e=arguments.length,n=Array(e>1?e-1:0),s=1;s<e;s++)n[s-1]=arguments[s];throw Error("[Immer] minified error nr: "+t+(n.length?" "+n.map(function(o){return"'"+o+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function J(t){return!!t&&!!t[D]}function q(t){var e;return!!t&&(function(n){if(!n||typeof n!="object")return!1;var s=Object.getPrototypeOf(n);if(s===null)return!0;var o=Object.hasOwnProperty.call(s,"constructor")&&s.constructor;return o===Object||typeof o=="function"&&Function.toString.call(o)===bn}(t)||Array.isArray(t)||!!t[ie]||!!(!((e=t.constructor)===null||e===void 0)&&e[ie])||Te(t)||Ae(t))}function ne(t,e,n){n===void 0&&(n=!1),W(t)===0?(n?Object.keys:Qe)(t).forEach(function(s){n&&typeof s=="symbol"||e(s,t[s],t)}):t.forEach(function(s,o){return e(o,s,t)})}function W(t){var e=t[D];return e?e.i>3?e.i-4:e.i:Array.isArray(t)?1:Te(t)?2:Ae(t)?3:0}function le(t,e){return W(t)===2?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function ye(t,e){return W(t)===2?t.get(e):t[e]}function Lt(t,e,n){var s=W(t);s===2?t.set(e,n):s===3?t.add(n):t[e]=n}function vn(t,e){return t===e?t!==0||1/t==1/e:t!=t&&e!=e}function Te(t){return Tn&&t instanceof Map}function Ae(t){return An&&t instanceof Set}function K(t){return t.o||t.t}function Ye(t){if(Array.isArray(t))return Array.prototype.slice.call(t);var e=Bn(t);delete e[D];for(var n=Qe(e),s=0;s<n.length;s++){var o=n[s],i=e[o];i.writable===!1&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(e[o]={configurable:!0,writable:!0,enumerable:i.enumerable,value:t[o]})}return Object.create(Object.getPrototypeOf(t),e)}function Ke(t,e){return e===void 0&&(e=!1),ze(t)||J(t)||!q(t)||(W(t)>1&&(t.set=t.add=t.clear=t.delete=_n),Object.freeze(t),e&&ne(t,function(n,s){return Ke(s,!0)},!0)),t}function _n(){w(2)}function ze(t){return t==null||typeof t!="object"||Object.isFrozen(t)}function F(t){var e=De[t];return e||w(18,t),e}function gn(t,e){De[t]||(De[t]=e)}function dt(){return ce}function Re(t,e){e&&(F("Patches"),t.u=[],t.s=[],t.v=e)}function _e(t){$e(t),t.p.forEach(En),t.p=null}function $e(t){t===ce&&(ce=t.l)}function ut(t){return ce={p:[],l:ce,h:t,m:!0,_:0}}function En(t){var e=t[D];e.i===0||e.i===1?e.j():e.g=!0}function Se(t,e){e._=e.p.length;var n=e.p[0],s=t!==void 0&&t!==n;return e.h.O||F("ES5").S(e,t,s),s?(n[D].P&&(_e(e),w(4)),q(t)&&(t=ge(e,t),e.l||Ee(e,t)),e.u&&F("Patches").M(n[D].t,t,e.u,e.s)):t=ge(e,n,[]),_e(e),e.u&&e.v(e.u,e.s),t!==Ze?t:void 0}function ge(t,e,n){if(ze(e))return e;var s=e[D];if(!s)return ne(e,function(u,d){return ft(t,s,e,u,d,n)},!0),e;if(s.A!==t)return e;if(!s.P)return Ee(t,s.t,!0),s.t;if(!s.I){s.I=!0,s.A._--;var o=s.i===4||s.i===5?s.o=Ye(s.k):s.o,i=o,r=!1;s.i===3&&(i=new Set(o),o.clear(),r=!0),ne(i,function(u,d){return ft(t,s,o,u,d,n,r)}),Ee(t,o,!1),n&&t.u&&F("Patches").N(s,n,t.u,t.s)}return s.o}function ft(t,e,n,s,o,i,r){if(J(o)){var u=ge(t,o,i&&e&&e.i!==3&&!le(e.R,s)?i.concat(s):void 0);if(Lt(n,s,u),!J(u))return;t.m=!1}else r&&n.add(o);if(q(o)&&!ze(o)){if(!t.h.D&&t._<1)return;ge(t,o),e&&e.A.l||Ee(t,o)}}function Ee(t,e,n){n===void 0&&(n=!1),!t.l&&t.h.D&&t.m&&Ke(e,n)}function Ce(t,e){var n=t[D];return(n?K(n):t)[e]}function ht(t,e){if(e in t)for(var n=Object.getPrototypeOf(t);n;){var s=Object.getOwnPropertyDescriptor(n,e);if(s)return s;n=Object.getPrototypeOf(n)}}function Pe(t){t.P||(t.P=!0,t.l&&Pe(t.l))}function Ie(t){t.o||(t.o=Ye(t.t))}function xe(t,e,n){var s=Te(e)?F("MapSet").F(e,n):Ae(e)?F("MapSet").T(e,n):t.O?function(o,i){var r=Array.isArray(o),u={i:r?1:0,A:i?i.A:dt(),P:!1,I:!1,R:{},l:i,t:o,k:null,o:null,j:null,C:!1},d=u,c=ke;r&&(d=[u],c=oe);var a=Proxy.revocable(d,c),f=a.revoke,v=a.proxy;return u.k=v,u.j=f,v}(e,n):F("ES5").J(e,n);return(n?n.A:dt()).p.push(s),s}function On(t){return J(t)||w(22,t),function e(n){if(!q(n))return n;var s,o=n[D],i=W(n);if(o){if(!o.P&&(o.i<4||!F("ES5").K(o)))return o.t;o.I=!0,s=pt(n,i),o.I=!1}else s=pt(n,i);return ne(s,function(r,u){o&&ye(o.t,r)===u||Lt(s,r,e(u))}),i===3?new Set(s):s}(t)}function pt(t,e){switch(e){case 2:return new Map(t);case 3:return Array.from(t)}return Ye(t)}function Je(){function t(s){if(!q(s))return s;if(Array.isArray(s))return s.map(t);if(Te(s))return new Map(Array.from(s.entries()).map(function(r){return[r[0],t(r[1])]}));if(Ae(s))return new Set(Array.from(s).map(t));var o=Object.create(Object.getPrototypeOf(s));for(var i in s)o[i]=t(s[i]);return le(s,ie)&&(o[ie]=s[ie]),o}function e(s){return J(s)?t(s):s}var n="add";gn("Patches",{$:function(s,o){return o.forEach(function(i){for(var r=i.path,u=i.op,d=s,c=0;c<r.length-1;c++){var a=W(d),f=r[c];typeof f!="string"&&typeof f!="number"&&(f=""+f),a!==0&&a!==1||f!=="__proto__"&&f!=="constructor"||w(24),typeof d=="function"&&f==="prototype"&&w(24),typeof(d=ye(d,f))!="object"&&w(15,r.join("/"))}var v=W(d),E=t(i.value),O=r[r.length-1];switch(u){case"replace":switch(v){case 2:return d.set(O,E);case 3:w(16);default:return d[O]=E}case n:switch(v){case 1:return O==="-"?d.push(E):d.splice(O,0,E);case 2:return d.set(O,E);case 3:return d.add(E);default:return d[O]=E}case"remove":switch(v){case 1:return d.splice(O,1);case 2:return d.delete(O);case 3:return d.delete(i.value);default:return delete d[O]}default:w(17,u)}}),s},N:function(s,o,i,r){switch(s.i){case 0:case 4:case 2:return function(u,d,c,a){var f=u.t,v=u.o;ne(u.R,function(E,O){var b=ye(f,E),N=ye(v,E),h=O?le(f,E)?"replace":n:"remove";if(b!==N||h!=="replace"){var p=d.concat(E);c.push(h==="remove"?{op:h,path:p}:{op:h,path:p,value:N}),a.push(h===n?{op:"remove",path:p}:h==="remove"?{op:n,path:p,value:e(b)}:{op:"replace",path:p,value:e(b)})}})}(s,o,i,r);case 5:case 1:return function(u,d,c,a){var f=u.t,v=u.R,E=u.o;if(E.length<f.length){var O=[E,f];f=O[0],E=O[1];var b=[a,c];c=b[0],a=b[1]}for(var N=0;N<f.length;N++)if(v[N]&&E[N]!==f[N]){var h=d.concat([N]);c.push({op:"replace",path:h,value:e(E[N])}),a.push({op:"replace",path:h,value:e(f[N])})}for(var p=f.length;p<E.length;p++){var y=d.concat([p]);c.push({op:n,path:y,value:e(E[p])})}f.length<E.length&&a.push({op:"replace",path:d.concat(["length"]),value:f.length})}(s,o,i,r);case 3:return function(u,d,c,a){var f=u.t,v=u.o,E=0;f.forEach(function(O){if(!v.has(O)){var b=d.concat([E]);c.push({op:"remove",path:b,value:O}),a.unshift({op:n,path:b,value:O})}E++}),E=0,v.forEach(function(O){if(!f.has(O)){var b=d.concat([E]);c.push({op:n,path:b,value:O}),a.unshift({op:"remove",path:b,value:O})}E++})}(s,o,i,r)}},M:function(s,o,i,r){i.push({op:"replace",path:[],value:o===Ze?void 0:o}),r.push({op:"replace",path:[],value:s})}})}var mt,ce,Xe=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",Tn=typeof Map<"u",An=typeof Set<"u",yt=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",Ze=Xe?Symbol.for("immer-nothing"):((mt={})["immer-nothing"]=!0,mt),ie=Xe?Symbol.for("immer-draftable"):"__$immer_draftable",D=Xe?Symbol.for("immer-state"):"__$immer_state",bn=""+Object.prototype.constructor,Qe=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Object.getOwnPropertyNames,Bn=Object.getOwnPropertyDescriptors||function(t){var e={};return Qe(t).forEach(function(n){e[n]=Object.getOwnPropertyDescriptor(t,n)}),e},De={},ke={get:function(t,e){if(e===D)return t;var n=K(t);if(!le(n,e))return function(o,i,r){var u,d=ht(i,r);return d?"value"in d?d.value:(u=d.get)===null||u===void 0?void 0:u.call(o.k):void 0}(t,n,e);var s=n[e];return t.I||!q(s)?s:s===Ce(t.t,e)?(Ie(t),t.o[e]=xe(t.A.h,s,t)):s},has:function(t,e){return e in K(t)},ownKeys:function(t){return Reflect.ownKeys(K(t))},set:function(t,e,n){var s=ht(K(t),e);if(s!=null&&s.set)return s.set.call(t.k,n),!0;if(!t.P){var o=Ce(K(t),e),i=o==null?void 0:o[D];if(i&&i.t===n)return t.o[e]=n,t.R[e]=!1,!0;if(vn(n,o)&&(n!==void 0||le(t.t,e)))return!0;Ie(t),Pe(t)}return t.o[e]===n&&(n!==void 0||e in t.o)||Number.isNaN(n)&&Number.isNaN(t.o[e])||(t.o[e]=n,t.R[e]=!0),!0},deleteProperty:function(t,e){return Ce(t.t,e)!==void 0||e in t.t?(t.R[e]=!1,Ie(t),Pe(t)):delete t.R[e],t.o&&delete t.o[e],!0},getOwnPropertyDescriptor:function(t,e){var n=K(t),s=Reflect.getOwnPropertyDescriptor(n,e);return s&&{writable:!0,configurable:t.i!==1||e!=="length",enumerable:s.enumerable,value:n[e]}},defineProperty:function(){w(11)},getPrototypeOf:function(t){return Object.getPrototypeOf(t.t)},setPrototypeOf:function(){w(12)}},oe={};ne(ke,function(t,e){oe[t]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),oe.deleteProperty=function(t,e){return oe.set.call(this,t,e,void 0)},oe.set=function(t,e,n){return ke.set.call(this,t[0],e,n,t[0])};var Rn=function(){function t(n){var s=this;this.O=yt,this.D=!0,this.produce=function(o,i,r){if(typeof o=="function"&&typeof i!="function"){var u=i;i=o;var d=s;return function(b){var N=this;b===void 0&&(b=u);for(var h=arguments.length,p=Array(h>1?h-1:0),y=1;y<h;y++)p[y-1]=arguments[y];return d.produce(b,function(g){var _;return(_=i).call.apply(_,[N,g].concat(p))})}}var c;if(typeof i!="function"&&w(6),r!==void 0&&typeof r!="function"&&w(7),q(o)){var a=ut(s),f=xe(s,o,void 0),v=!0;try{c=i(f),v=!1}finally{v?_e(a):$e(a)}return typeof Promise<"u"&&c instanceof Promise?c.then(function(b){return Re(a,r),Se(b,a)},function(b){throw _e(a),b}):(Re(a,r),Se(c,a))}if(!o||typeof o!="object"){if((c=i(o))===void 0&&(c=o),c===Ze&&(c=void 0),s.D&&Ke(c,!0),r){var E=[],O=[];F("Patches").M(o,c,E,O),r(E,O)}return c}w(21,o)},this.produceWithPatches=function(o,i){if(typeof o=="function")return function(c){for(var a=arguments.length,f=Array(a>1?a-1:0),v=1;v<a;v++)f[v-1]=arguments[v];return s.produceWithPatches(c,function(E){return o.apply(void 0,[E].concat(f))})};var r,u,d=s.produce(o,i,function(c,a){r=c,u=a});return typeof Promise<"u"&&d instanceof Promise?d.then(function(c){return[c,r,u]}):[d,r,u]},typeof(n==null?void 0:n.useProxies)=="boolean"&&this.setUseProxies(n.useProxies),typeof(n==null?void 0:n.autoFreeze)=="boolean"&&this.setAutoFreeze(n.autoFreeze)}var e=t.prototype;return e.createDraft=function(n){q(n)||w(8),J(n)&&(n=On(n));var s=ut(this),o=xe(this,n,void 0);return o[D].C=!0,$e(s),o},e.finishDraft=function(n,s){var o=n&&n[D],i=o.A;return Re(i,s),Se(void 0,i)},e.setAutoFreeze=function(n){this.D=n},e.setUseProxies=function(n){n&&!yt&&w(20),this.O=n},e.applyPatches=function(n,s){var o;for(o=s.length-1;o>=0;o--){var i=s[o];if(i.path.length===0&&i.op==="replace"){n=i.value;break}}o>-1&&(s=s.slice(o+1));var r=F("Patches").$;return J(n)?r(n,s):this.produce(n,function(u){return r(u,s)})},t}(),k=new Rn;k.produce;var et=k.produceWithPatches.bind(k);k.setAutoFreeze.bind(k);k.setUseProxies.bind(k);k.applyPatches.bind(k);k.createDraft.bind(k);k.finishDraft.bind(k);var Z=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};Je();class Sn{constructor(e){this.messageBus=e}getItems(e){return Z(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEMS",{ids:e});return n}else if(e){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return n.filter(e)}else{const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return n}})}isItemArray(e){return Array.isArray(e)&&e.every(n=>typeof n!="string")}updateItems(e,n){return Z(this,void 0,void 0,function*(){let s;this.isItemArray(e)?s=e:s=yield this.getItems(e);const[o,i]=et(s,n),r=o.map(u=>({id:u.id,type:u.type}));for(const u of i){const[d,c]=u.path;typeof d=="number"&&typeof c=="string"&&(r[d][c]=o[d][c])}yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_UPDATE_ITEMS",{updates:r})})}addItems(e){return Z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_ADD_ITEMS",{items:e})})}deleteItems(e){return Z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return Z(this,void 0,void 0,function*(){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_ATTACHMENTS",{ids:e});return n})}getItemBounds(e){return Z(this,void 0,void 0,function*(){const{bounds:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_BOUNDS",{ids:e});return n})}onChange(e){const n=s=>{e(s.items)};return this.messageBus.send("OBR_SCENE_ITEMS_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_ITEMS_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_ITEMS_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_ITEMS_EVENT_CHANGE",n)}}}var Q=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};Je();class Cn{constructor(e){this.messageBus=e}getItems(e){return Q(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEMS",{ids:e});return n}else if(e){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return n.filter(e)}else{const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return n}})}updateItems(e,n,s){return Q(this,void 0,void 0,function*(){const o=yield this.getItems(e),[i,r]=et(o,n),u=i.map(d=>({id:d.id,type:d.type}));for(const d of r){const[c,a]=d.path;typeof c=="number"&&typeof a=="string"&&(u[c][a]=i[c][a])}yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_UPDATE_ITEMS",{updates:u,fastUpdate:s})})}addItems(e){return Q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_ADD_ITEMS",{items:e})})}deleteItems(e){return Q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return Q(this,void 0,void 0,function*(){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_ATTACHMENTS",{ids:e});return n})}getItemBounds(e){return Q(this,void 0,void 0,function*(){const{bounds:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_BOUNDS",{ids:e});return n})}onChange(e){const n=s=>{e(s.items)};return this.messageBus.send("OBR_SCENE_LOCAL_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_LOCAL_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_LOCAL_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_LOCAL_EVENT_CHANGE",n)}}}var Ne=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class In{constructor(e){this.messageBus=e,this.grid=new mn(e),this.fog=new pn(e),this.history=new yn(e),this.items=new Sn(e),this.local=new Cn(e)}isReady(){return Ne(this,void 0,void 0,function*(){const{ready:e}=yield this.messageBus.sendAsync("OBR_SCENE_IS_READY",{});return e})}onReadyChange(e){const n=s=>{e(s.ready)};return this.messageBus.send("OBR_SCENE_READY_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_EVENT_READY_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_READY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_EVENT_READY_CHANGE",n)}}getMetadata(){return Ne(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_SCENE_GET_METADATA",{});return e})}setMetadata(e){return Ne(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_SET_METADATA",{update:e})})}onMetadataChange(e){const n=s=>{e(s.metadata)};return this.messageBus.send("OBR_SCENE_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_METADATA_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_METADATA_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_METADATA_EVENT_CHANGE",n)}}}function ae(t){return t.map(e=>Object.assign(Object.assign({},e),{icon:e.icon.startsWith("http")?e.icon:`${window.location.origin}${e.icon}`}))}function $t(t){return Object.assign(Object.assign({},t),{url:t.url.startsWith("http")?t.url:`${window.location.origin}${t.url}`})}var vt=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class Nn{constructor(e){this.contextMenus={},this.handleClick=n=>{const s=this.contextMenus[n.id];s&&s.onClick(n.context,n.elementId)},this.messageBus=e,e.on("OBR_CONTEXT_MENU_EVENT_CLICK",this.handleClick)}create(e){return vt(this,void 0,void 0,function*(){this.messageBus.sendAsync("OBR_CONTEXT_MENU_CREATE",{id:e.id,shortcut:e.shortcut,icons:ae(e.icons)}),this.contextMenus[e.id]=e})}remove(e){return vt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_CONTEXT_MENU_REMOVE",{id:e}),delete this.contextMenus[e]})}}var U=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class wn{constructor(e){this.tools={},this.toolActions={},this.toolModes={},this.handleToolClick=n=>{const s=this.tools[n.id];if(s)if(s.onClick){const o=s.onClick(n.context,n.elementId);Promise.resolve(o).then(i=>{i&&this.messageBus.send("OBR_TOOL_ACTIVATE",{id:n.id})})}else this.messageBus.send("OBR_TOOL_ACTIVATE",{id:n.id})},this.handleToolActionClick=n=>{var s;const o=this.toolActions[n.id];o&&((s=o.onClick)===null||s===void 0||s.call(o,n.context,n.elementId))},this.handleToolModeClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onClick){const o=s.onClick(n.context,n.elementId);Promise.resolve(o).then(i=>{i&&this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:n.context.activeTool,modeId:n.id})})}else this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:n.context.activeTool,modeId:n.id})},this.handleToolModeToolClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onToolClick){const o=s.onToolClick(n.context,n.event);Promise.resolve(o).then(i=>{i&&n.event.target&&!n.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})})}else n.event.target&&!n.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})},this.handleToolModeToolDoubleClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onToolDoubleClick){const o=s.onToolDoubleClick(n.context,n.event);Promise.resolve(o).then(i=>{i&&n.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})})}else n.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})},this.handleToolModeToolDown=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDown)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolMove=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolMove)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolUp=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolUp)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragStart=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragStart)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragMove=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragMove)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragEnd=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragEnd)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragCancel=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragCancel)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeKeyDown=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onKeyDown)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeKeyUp=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onKeyUp)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeActivate=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onActivate)===null||s===void 0||s.call(o,n.context))},this.handleToolModeDeactivate=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onDeactivate)===null||s===void 0||s.call(o,n.context))},this.messageBus=e,e.on("OBR_TOOL_EVENT_CLICK",this.handleToolClick),e.on("OBR_TOOL_ACTION_EVENT_CLICK",this.handleToolActionClick),e.on("OBR_TOOL_MODE_EVENT_CLICK",this.handleToolModeClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_CLICK",this.handleToolModeToolClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOUBLE_CLICK",this.handleToolModeToolDoubleClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOWN",this.handleToolModeToolDown),e.on("OBR_TOOL_MODE_EVENT_TOOL_MOVE",this.handleToolModeToolMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_UP",this.handleToolModeToolUp),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_START",this.handleToolModeToolDragStart),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_MOVE",this.handleToolModeToolDragMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_END",this.handleToolModeToolDragEnd),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_CANCEL",this.handleToolModeToolDragCancel),e.on("OBR_TOOL_MODE_EVENT_KEY_DOWN",this.handleToolModeKeyDown),e.on("OBR_TOOL_MODE_EVENT_KEY_UP",this.handleToolModeKeyUp),e.on("OBR_TOOL_MODE_EVENT_ACTIVATE",this.handleToolModeActivate),e.on("OBR_TOOL_MODE_EVENT_DEACTIVATE",this.handleToolModeDeactivate)}create(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_CREATE",{id:e.id,shortcut:e.shortcut,defaultMode:e.defaultMode,defaultMetadata:e.defaultMetadata,icons:ae(e.icons),disabled:e.disabled}),this.tools[e.id]=e})}remove(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_REMOVE",{id:e}),delete this.tools[e]})}activateTool(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTIVATE",{id:e})})}getMetadata(e){return U(this,void 0,void 0,function*(){const{metadata:n}=yield this.messageBus.sendAsync("OBR_TOOL_GET_METADATA",{id:e});return n})}setMetadata(e,n){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_SET_METADATA",{toolId:e,update:n})})}createAction(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_CREATE",{id:e.id,shortcut:e.shortcut,icons:ae(e.icons),disabled:e.disabled}),this.toolActions[e.id]=e})}removeAction(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_REMOVE",{id:e}),delete this.tools[e]})}createMode(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_CREATE",{id:e.id,shortcut:e.shortcut,icons:ae(e.icons),preventDrag:e.preventDrag,disabled:e.disabled,cursors:e.cursors}),this.toolModes[e.id]=e})}removeMode(e){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_REMOVE",{id:e}),delete this.tools[e]})}activateMode(e,n){return U(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_ACTIVATE",{toolId:e,modeId:n})})}}var ee=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class Mn{constructor(e){this.messageBus=e}open(e){return ee(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_OPEN",Object.assign({},$t(e)))})}close(e){return ee(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_CLOSE",{id:e})})}getWidth(e){return ee(this,void 0,void 0,function*(){const{width:n}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_WIDTH",{id:e});return n})}setWidth(e,n){return ee(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_WIDTH",{id:e,width:n})})}getHeight(e){return ee(this,void 0,void 0,function*(){const{height:n}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_HEIGHT",{id:e});return n})}setHeight(e,n){return ee(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_HEIGHT",{id:e,height:n})})}}var _t=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class Ln{constructor(e){this.messageBus=e}open(e){return _t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_OPEN",Object.assign({},$t(e)))})}close(e){return _t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_CLOSE",{id:e})})}}var P=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class $n{constructor(e){this.messageBus=e}getWidth(){return P(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_WIDTH",{});return e})}setWidth(e){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_WIDTH",{width:e})})}getHeight(){return P(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_HEIGHT",{});return e})}setHeight(e){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_HEIGHT",{height:e})})}getBadgeText(){return P(this,void 0,void 0,function*(){const{badgeText:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_TEXT",{});return e})}setBadgeText(e){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_TEXT",{badgeText:e})})}getBadgeBackgroundColor(){return P(this,void 0,void 0,function*(){const{badgeBackgroundColor:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_BACKGROUND_COLOR",{});return e})}setBadgeBackgroundColor(e){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_BACKGROUND_COLOR",{badgeBackgroundColor:e})})}getIcon(){return P(this,void 0,void 0,function*(){const{icon:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_ICON",{});return e})}setIcon(e){return P(this,void 0,void 0,function*(){const n=ae([{icon:e}]);yield this.messageBus.sendAsync("OBR_ACTION_SET_ICON",{icon:n[0].icon})})}getTitle(){return P(this,void 0,void 0,function*(){const{title:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_TITLE",{});return e})}setTitle(e){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_TITLE",{title:e})})}isOpen(){return P(this,void 0,void 0,function*(){const{isOpen:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_IS_OPEN",{});return e})}open(){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_OPEN",{})})}close(){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_CLOSE",{})})}onOpenChange(e){const n=s=>{e(s.isOpen)};return this.messageBus.send("OBR_ACTION_IS_OPEN_SUBSCRIBE",{}),this.messageBus.on("OBR_ACTION_IS_OPEN_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_IS_OPEN_ACTION_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ACTION_IS_OPEN_EVENT_CHANGE",n)}}}var Pn=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};Je();class xn{constructor(e){this.messageBus=e}startItemInteraction(e){return Pn(this,void 0,void 0,function*(){const{id:n}=yield this.messageBus.sendAsync("OBR_INTERACTION_START_ITEM_INTERACTION",{baseState:e});let s=e;return[r=>{const[u,d]=et(s,r);return s=u,this.messageBus.send("OBR_INTERACTION_UPDATE_ITEM_INTERACTION",{id:n,patches:d}),u},()=>{this.messageBus.send("OBR_INTERACTION_STOP_ITEM_INTERACTION",{id:n})}]})}}var Dn=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class kn{constructor(e){this.messageBus=e}getPlayers(){return Dn(this,void 0,void 0,function*(){const{players:e}=yield this.messageBus.sendAsync("OBR_PARTY_GET_PLAYERS",{});return e})}onChange(e){const n=s=>{e(s.players)};return this.messageBus.send("OBR_PARTY_SUBSCRIBE",{}),this.messageBus.on("OBR_PARTY_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PARTY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PARTY_EVENT_CHANGE",n)}}}var we=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class Hn{constructor(e){this.messageBus=e}get id(){return this.messageBus.roomId}getPermissions(){return we(this,void 0,void 0,function*(){const{permissions:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return e})}getMetadata(){return we(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_METADATA",{});return e})}setMetadata(e){return we(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ROOM_SET_METADATA",{update:e})})}onMetadataChange(e){const n=s=>{e(s.metadata)};return this.messageBus.send("OBR_ROOM_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_METADATA_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_METADATA_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_METADATA_EVENT_CHANGE",n)}}onPermissionsChange(e){const n=s=>{e(s.permissions)};return this.messageBus.send("OBR_ROOM_PERMISSIONS_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PERMISSIONS_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",n)}}}var Gn=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(r){r(i)})}return new(n||(n=Promise))(function(i,r){function u(a){try{c(s.next(a))}catch(f){r(f)}}function d(a){try{c(s.throw(a))}catch(f){r(f)}}function c(a){a.done?i(a.value):o(a.value).then(u,d)}c((s=s.apply(t,e||[])).next())})};class Un{constructor(e){this.messageBus=e}getTheme(){return Gn(this,void 0,void 0,function*(){const{theme:e}=yield this.messageBus.sendAsync("OBR_THEME_GET_THEME",{});return e})}onChange(e){const n=s=>{e(s.theme)};return this.messageBus.send("OBR_THEME_SUBSCRIBE",{}),this.messageBus.on("OBR_THEME_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_THEME_UNSUBSCRIBE",{}),this.messageBus.off("OBR_THEME_EVENT_CHANGE",n)}}}const tt=typeof Buffer=="function",gt=typeof TextDecoder=="function"?new TextDecoder:void 0;typeof TextEncoder=="function"&&new TextEncoder;const Vn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Fn=Array.prototype.slice.call(Vn),he=(t=>{let e={};return t.forEach((n,s)=>e[n]=s),e})(Fn),jn=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,z=String.fromCharCode.bind(String),Et=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),Pt=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),qn=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Wn=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),n=e-65536;return z((n>>>10)+55296)+z((n&1023)+56320);case 3:return z((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return z((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},Yn=t=>t.replace(qn,Wn),Kn=t=>{if(t=t.replace(/\s+/g,""),!jn.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,n,s,o=[];for(let i=0;i<t.length;)e=he[t.charAt(i++)]<<18|he[t.charAt(i++)]<<12|(n=he[t.charAt(i++)])<<6|(s=he[t.charAt(i++)]),n===64?o.push(z(e>>16&255)):s===64?o.push(z(e>>16&255,e>>8&255)):o.push(z(e>>16&255,e>>8&255,e&255));return o.join("")},xt=typeof atob=="function"?t=>atob(Pt(t)):tt?t=>Buffer.from(t,"base64").toString("binary"):Kn,zn=tt?t=>Et(Buffer.from(t,"base64")):t=>Et(xt(t).split("").map(e=>e.charCodeAt(0))),Jn=tt?t=>Buffer.from(t,"base64").toString("utf8"):gt?t=>gt.decode(zn(t)):t=>Yn(xt(t)),Xn=t=>Pt(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),Zn=t=>Jn(Xn(t));function Qn(){const e=new URLSearchParams(window.location.search).get("obrref");let n="",s="";if(e){const i=Zn(e).split(" ");i.length===2&&(n=i[0],s=i[1])}return{origin:n,roomId:s}}var Ot;(function(t){t[t.MOVE=0]="MOVE",t[t.LINE=1]="LINE",t[t.QUAD=2]="QUAD",t[t.CONIC=3]="CONIC",t[t.CUBIC=4]="CUBIC",t[t.CLOSE=5]="CLOSE"})(Ot||(Ot={}));const He=Qn(),M=new fn(He.origin,He.roomId),es=new Xt(M),ts=new Jt(M),ns=new kn(M),ss=new hn(M),os=new In(M),is=new Nn(M),as=new wn(M),rs=new Mn(M),ls=new Ln(M),cs=new $n(M),ds=new xn(M),us=new Hn(M),fs=new Un(M),C={onReady:t=>{M.ready?t():M.once("OBR_READY",()=>t())},get isReady(){return M.ready},viewport:es,player:ts,party:ns,notification:ss,scene:os,contextMenu:is,tool:as,popover:rs,modal:ls,action:cs,interaction:ds,room:us,theme:fs,isAvailable:!!He.origin},Ge={en:{appTitle:"Foxyverse TTRPG",appSubtitle:"Homebrew system",selectSheet:"Select character sheet",newSheet:"New sheet",noSheet:"No sheet selected",settings:"Settings",permissions:"Permissions",view:"View",edit:"Edit",linkToken:"Link to token",gmOnly:"GM only",tabBio:"Bio",tabStats:"Stats",tabSpells:"Spells",tabInventory:"Inventory",tabChat:"Chat",tabNotes:"Notes",tabSettings:"Settings",name:"Name",surname:"Surname",element:"Element",class:"Class",level:"Level",tempHP:"Temp HP",currentHP:"Current HP",maxHP:"Max HP",currentMP:"Current MP",maxMP:"Max MP",currentFavor:"Current Favor",maxFavor:"Max Favor",action:"Action",actionModifier:"Action modifier",speed:"Speed",speedModifier:"Speed modifier",baseStat:"Base",xpBonus:"XP Bonus",itemBonus:"Item",passiveBonus:"Passive",total:"Total",roll:"Roll",modifier:"Modifier",quickMods:"Quick modifiers",knowledge:"Knowledge",addKnowledge:"Add knowledge",tier:"Tier",tier1:"Tier 1 (+1)",tier2:"Tier 2 (+3)",tier3:"Tier 3 (+5)",tier4:"Tier 4 (+10)",constitution:"Constitution",strength:"Strength",intelligence:"Intelligence",perception:"Perception",social:"Social",agility:"Agility",focus:"Focus",statRoll:"Stat roll",nat1:"Nat 1",nat20:"Nat 20",success:"Success",failure:"Failure",dc:"DC",result:"Result",reroll:"Reroll",rerollCost:"Uses 1 Favor",physicalDamage:"Physical damage",magicDamage:"Magic damage",trueDamage:"True damage",heal:"Heal",overHeal:"Over heal (Temp HP)",otherRoll:"Other roll",applyDamage:"Apply damage",applyHeal:"Apply heal",applyOverHeal:"Apply temp HP",spellName:"Spell name",spellEffect:"Effect",spellCost:"Cost",costHP:"HP",costMP:"MP",deductCost:"Deduct cost",notEnoughMP:"Not enough MP  use HP?",confirmUseHP:"Using HP for MP will drain life. Continue?",equipped:"Equipped",consumables:"Consumables",others:"Others",weapons:"Weapons",armor:"Armor",bags:"Bags",itemName:"Item name",itemType:"Type",itemDescription:"Description",numberOwned:"Qty",weaponSlots:"Weapon slots",defense:"Defense",magicalDefense:"Magical Defense",equippableSlots:"Equippable slots",slotWeapon1:"Weapon 1",slotWeapon2:"Weapon 2",slotWeapon3:"Weapon 3",slotHat:"Hat",slotFace:"Face",slotNecklace:"Necklace",slotPendant1:"Pendant 1",slotPendant2:"Pendant 2",slotPendant3:"Pendant 3",slotTorso:"Torso",slotRightShoulder:"Right shoulder",slotLeftShoulder:"Left shoulder",slotLeftArm:"Left arm",slotRightArm:"Right arm",slotLeftWrist:"Left wrist",slotRightWrist:"Right wrist",slotBelt:"Belt",slotLeftLeg:"Left leg",slotRightLeg:"Right leg",slotLeftAnkle:"Left ankle",slotRightAnkle:"Right ankle",slotLeftFoot:"Left foot",slotRightFoot:"Right foot",slotOther:"Other",fingers:"Fingers",leftThumb:"L. thumb",leftIndex:"L. index",leftMiddle:"L. middle",leftRing:"L. ring",leftPinky:"L. pinky",rightThumb:"R. thumb",rightIndex:"R. index",rightMiddle:"R. middle",rightRing:"R. ring",rightPinky:"R. pinky",chatPlaceholder:"Message or /str +5, /pdmg 2d6...",send:"Send",notesPlaceholder:"Notes...",uiColors:"UI colors",color1:"Background",color2:"Surface",color3:"Border",color4:"Text",color5:"Accent",exportSheet:"Export sheet",importSheet:"Import sheet",importFile:"Import from file",add:"Add",remove:"Remove",save:"Save",cancel:"Cancel",close:"Close",confirm:"Confirm",ok:"OK"},fr:{appTitle:"Foxyverse TTRPG",appSubtitle:"Systme homebrew",selectSheet:"Choisir la fiche",newSheet:"Nouvelle fiche",noSheet:"Aucune fiche",settings:"Paramtres",permissions:"Permissions",view:"Voir",edit:"Modifier",linkToken:"Lier au token",gmOnly:"MJ uniquement",tabBio:"Bio",tabStats:"Stats",tabSpells:"Sorts",tabInventory:"Inventaire",tabChat:"Chat",tabNotes:"Notes",tabSettings:"Paramtres",name:"Prnom",surname:"Nom",element:"lment",class:"Classe",level:"Niveau",tempHP:"PV temp",currentHP:"PV actuels",maxHP:"PV max",currentMP:"PM actuels",maxMP:"PM max",currentFavor:"Faveur actuelle",maxFavor:"Faveur max",action:"Action",actionModifier:"Mod. action",speed:"Vitesse",speedModifier:"Mod. vitesse",baseStat:"Base",xpBonus:"Bonus XP",itemBonus:"Objet",passiveBonus:"Passif",total:"Total",roll:"Lancer",modifier:"Modificateur",quickMods:"Mod. rapides",knowledge:"Connaissances",addKnowledge:"Ajouter connaissance",tier:"Niveau",tier1:"Niveau 1 (+1)",tier2:"Niveau 2 (+3)",tier3:"Niveau 3 (+5)",tier4:"Niveau 4 (+10)",constitution:"Constitution",strength:"Force",intelligence:"Intelligence",perception:"Perception",social:"Social",agility:"Agilit",focus:"Focus",statRoll:"Jet de stat",nat1:"Crit 1",nat20:"Crit 20",success:"Russi",failure:"chec",dc:"DD",result:"Rsultat",reroll:"Relancer",rerollCost:"Cote 1 Faveur",physicalDamage:"Dgts physiques",magicDamage:"Dgts magiques",trueDamage:"Dgts bruts",heal:"Soin",overHeal:"Sur-soin (PV temp)",otherRoll:"Autre jet",applyDamage:"Appliquer dgts",applyHeal:"Appliquer soin",applyOverHeal:"Appliquer PV temp",spellName:"Nom du sort",spellEffect:"Effet",spellCost:"Cot",costHP:"PV",costMP:"PM",deductCost:"Dduire cot",notEnoughMP:"Pas assez de PM  utiliser les PV ?",confirmUseHP:"Utiliser les PV  la place des PM va vous blesser. Continuer ?",equipped:"quip",consumables:"Consommables",others:"Autres",weapons:"Armes",armor:"Armure",bags:"Sacs",itemName:"Nom",itemType:"Type",itemDescription:"Description",numberOwned:"Qt",weaponSlots:"Emplacements arme",defense:"Dfense",magicalDefense:"Dfense magique",equippableSlots:"Emplacements quipables",slotWeapon1:"Arme 1",slotWeapon2:"Arme 2",slotWeapon3:"Arme 3",slotHat:"Chapeau",slotFace:"Visage",slotNecklace:"Collier",slotPendant1:"Pendentif 1",slotPendant2:"Pendentif 2",slotPendant3:"Pendentif 3",slotTorso:"Torse",slotRightShoulder:"paule droite",slotLeftShoulder:"paule gauche",slotLeftArm:"Bras gauche",slotRightArm:"Bras droit",slotLeftWrist:"Poignet gauche",slotRightWrist:"Poignet droit",slotBelt:"Ceinture",slotLeftLeg:"Jambe gauche",slotRightLeg:"Jambe droite",slotLeftAnkle:"Cheville gauche",slotRightAnkle:"Cheville droite",slotLeftFoot:"Pied gauche",slotRightFoot:"Pied droit",slotOther:"Autre",fingers:"Doigts",leftThumb:"Pouce G",leftIndex:"Index G",leftMiddle:"Majeur G",leftRing:"Annulaire G",leftPinky:"Auriculaire G",rightThumb:"Pouce D",rightIndex:"Index D",rightMiddle:"Majeur D",rightRing:"Annulaire D",rightPinky:"Auriculaire D",chatPlaceholder:"Message ou /str +5, /pdmg 2d6...",send:"Envoyer",notesPlaceholder:"Notes...",uiColors:"Couleurs de l'interface",color1:"Fond",color2:"Surface",color3:"Bordure",color4:"Texte",color5:"Accent",exportSheet:"Exporter la fiche",importSheet:"Importer la fiche",importFile:"Importer un fichier",add:"Ajouter",remove:"Retirer",save:"Enregistrer",cancel:"Annuler",close:"Fermer",confirm:"Confirmer",ok:"OK"}};let Ue="en";function Dt(t){return Ge[t]&&(Ue=t),Ue}function m(t){var e;return((e=Ge[Ue])==null?void 0:e[t])??Ge.en[t]??t}const kt=["constitution","strength","intelligence","perception","social","agility","focus"];function hs(){return{base:0,xpBonus:0,itemBonus:0,passiveBonus:0}}function ps(){const t={};return kt.forEach(e=>{t[e]=hs()}),t}function Ht(t=crypto.randomUUID()){return{id:t,bio:{name:"",surname:"",element:"",class:"",level:1},stats:ps(),knowledge:[],tempHP:0,currentHP:0,currentMP:0,currentFavor:0,actionFormula:"",actionModifier:"",speedModifier:"",spells:[],equipped:{},consumables:[],others:[],weapons:[],armor:[],bags:[],notes:"",createdAt:Date.now(),updatedAt:Date.now()}}function Gt(t){const e=Y(t,"constitution");return Math.max(0,e*2)}function ms(t){const e=Y(t,"intelligence"),n=Y(t,"focus");return Math.round((e+n)*.75)}function ys(t){var n;const e=Number((n=t.bio)==null?void 0:n.level)||1;return Math.ceil((e+1)/3)}function vs(t){const e=(t||"").trim();if(!e)return 0;const n=e.match(/^([+\-])\s*(\d+)$/);return n?n[1]==="-"?-parseInt(n[2],10):parseInt(n[2],10):0}function _s(t){var o;const e=Y(t,"agility"),n=Number((o=t.bio)==null?void 0:o.level)||1;return Math.floor(e/10)+Math.floor(n/5)+vs(t.actionModifier)}function gs(t){const e=Y(t,"agility"),n=(t.speedModifier||"").trim();return n?`(${e}/4 + 1d6) ${n}`:`${e}/4 + 1d6`}function Y(t,e){var u;const n=(u=t.stats)==null?void 0:u[e];if(!n)return 0;const s=Number(n.base)||0,o=Number(n.xpBonus)||0,i=Number(n.itemBonus)||0,r=Number(n.passiveBonus)||0;return s+o+i+r}function ve(t){var s,o;const e=((s=t.bio)==null?void 0:s.name)??"",n=((o=t.bio)==null?void 0:o.surname)??"";return e&&n?`${e} ${n}`:e||n||"Unnamed"}function Ut(t,e){const n=[t.weapons,t.armor,t.consumables,t.others,t.bags].filter(Boolean);for(const s of n){const o=s.find(i=>i.id===e);if(o)return o}return null}function Es(t){let e=0;const n=t.equipped||{};for(const s of Object.values(n)){const o=Ut(t,s);o&&o.defense!=null&&(e+=Number(o.defense)||0)}return e}function Os(t){let e=0;const n=t.equipped||{};for(const s of Object.values(n)){const o=Ut(t,s);o&&o.magicalDefense!=null&&(e+=Number(o.magicalDefense)||0)}return e}const Ve="foxyverse",Ts="foxyverse_sheet_",Me=14e3;async function be(){return(await C.room.getMetadata())[Ve]||{}}async function Be(t){const e=await C.room.getMetadata();await C.room.setMetadata({...e,[Ve]:{...e[Ve]||{},...t}})}async function Fe(){return(await be()).sheetIds||[]}async function je(t,e){const n=await be(),s=n.sheetIds||[];s.includes(t)||await Be({sheetIds:[...s,t],sheetNames:{...n.sheetNames||{},[t]:e||"Unnamed"}})}async function As(t){await Be({permissions:t})}async function Vt(){return C.room.id}function Ft(t,e){return`${Ts}${t}_${e}`}function bs(t,e){try{const n=localStorage.getItem(Ft(t,e));return n?JSON.parse(n):null}catch{return null}}function de(t,e){const n=Ft(t,e.id);e.updatedAt=Date.now(),localStorage.setItem(n,JSON.stringify(e))}const qe="foxyverse",Tt={SHEET_FULL:"sheet_full",SHEET_PART:"sheet_part"};async function Bs(t,e){const n=JSON.stringify(e);if(n.length<=Me){await C.broadcast.sendMessage(qe,{type:Tt.SHEET_FULL,roomId:t,sheet:e});return}const s=[];for(let o=0;o<n.length;o+=Me)s.push(n.slice(o,o+Me));for(let o=0;o<s.length;o++)await C.broadcast.sendMessage(qe,{type:Tt.SHEET_PART,roomId:t,sheetId:e.id,partIndex:o,totalParts:s.length,data:s[o]})}function Rs(t){return C.broadcast.onMessage(qe,t)}async function Ss(){return C.player.id}async function Cs(){return C.player.getRole()}async function Is(){return C.player.getName()}const Ns={str:"strength",con:"constitution",int:"intelligence",per:"perception",soc:"social",agi:"agility",foc:"focus"};function ws(t){const e=(t||"").replace(/\s/g,""),n=[];let s=0;for(;s<e.length;){if(/[0-9]/.test(e[s])){let o="";for(;s<e.length&&/[0-9]/.test(e[s]);)o+=e[s++];n.push({type:"num",value:parseInt(o,10)});continue}if(e[s]==="d"&&s+1<e.length){s++;const i=e.slice(s).match(/^(str|con|int|per|soc|agi|foc)/i);if(i){const u=i[1].toLowerCase();s+=u.length,n.push({type:"diceStat",stat:u});continue}let r="";for(;s<e.length&&/[0-9]/.test(e[s]);)r+=e[s++];n.push({type:"dice",faces:r?parseInt(r,10):20});continue}if(/[a-zA-Z]/.test(e[s])){const i=e.slice(s).match(/^(str|con|int|per|soc|agi|foc)/i);if(i){const r=i[1].toLowerCase();s+=r.length,n.push({type:"stat",value:r});continue}s++;continue}if(e[s]==="("){n.push({type:"("}),s++;continue}if(e[s]===")"){n.push({type:")"}),s++;continue}if(e[s]==="+"){n.push({type:"+"}),s++;continue}if(e[s]==="-"){n.push({type:"-"}),s++;continue}if(e[s]==="*"){n.push({type:"*"}),s++;continue}if(e[s]==="/"){n.push({type:"/"}),s++;continue}s++}return n}function Le(t,e){const n=Ns[t];return e[n]!=null?Number(e[n]):0}function Ms(t,e,n){const s=(u,d)=>{let c=0;const a=[];for(let f=0;f<u;f++){const v=n?n(d):Math.floor(Math.random()*d)+1;a.push(v),c+=v}return{sum:c,rolls:a}};function o(u){var c;if(u>=t.length)return{value:0,next:u,rolls:[]};const d=t[u];if(d.type==="num"){const a=t[u+1];if((a==null?void 0:a.type)==="dice"){const{sum:f,rolls:v}=s(d.value,a.faces);return{value:f,next:u+2,rolls:v}}if((a==null?void 0:a.type)==="diceStat"){const f=Math.max(1,Le(a.stat,e)),{sum:v,rolls:E}=s(d.value,f);return{value:v,next:u+2,rolls:E}}return{value:d.value,next:u+1,rolls:[]}}if(d.type==="stat")return{value:Le(d.value,e),next:u+1,rolls:[]};if(d.type==="dice"){const{sum:a,rolls:f}=s(1,d.faces);return{value:a,next:u+1,rolls:f}}if(d.type==="diceStat"){const a=Math.max(1,Le(d.stat,e)),{sum:f,rolls:v}=s(1,a);return{value:f,next:u+1,rolls:v}}if(d.type==="("){const a=i(u+1),f=((c=t[a.next])==null?void 0:c.type)===")"?a.next+1:a.next;return{value:a.value,next:f,rolls:a.rolls||[]}}return{value:0,next:u+1,rolls:[]}}function i(u){let d=u,c=o(d);d=c.next;const a=c.rolls||[];for(;d<t.length;){const f=t[d];if(f.type===")"||!["+","-","*","/"].includes(f.type))break;d++;const v=o(d);d=v.next,v.rolls&&a.push(...v.rolls);const E=c.value,O=v.value;f.type==="+"?c={value:E+O,next:d}:f.type==="-"?c={value:E-O,next:d}:f.type==="*"?c={value:E*O,next:d}:f.type==="/"&&(c={value:O===0?0:Math.floor(E/O),next:d})}return{value:c.value,next:d,rolls:a}}const r=i(0);return{value:Math.max(0,Math.floor(r.value)),rolls:r.rolls||[]}}function Ls(t,e){const n={};return["constitution","strength","intelligence","perception","social","agility","focus"].forEach(o=>{n[o]=e(t,o)}),n}function $s(t,e={},n=null){const s=ws(t);return Ms(s,e,n)}function Ps(t){const e=(t||"").trim();if(!e)return 0;const n=e.match(/^([+\-*/])\s*(\d+)$/);if(!n)return 0;const s=n[1],o=parseInt(n[2],10);return s==="+"?o:s==="-"?-o:0}function jt(t,e,n=null){const s=n?n(20):Math.floor(Math.random()*20)+1,o=Ps(e),i=s+o,r=s===20?!0:s===1?!1:i<=t;return{roll:s,mod:o,total:i,dc:t,success:r,nat1:s===1,nat20:s===20}}const nt={str:"strength",int:"intelligence",con:"constitution",per:"perception",soc:"social",agi:"agility",foc:"focus"};function xs(t){const e=/\[([^\]:]+):([^\]]*)\]/gi,n=[];let s;for(;(s=e.exec(t))!==null;){const o=(s[1]||"").trim().toLowerCase(),i=(s[2]||"").trim();nt[o]||o==="statroll"?n.push({type:"stat",stat:o==="statroll"?null:o,expr:i,raw:s[0]}):o==="pdmg"?n.push({type:"pdmg",expr:i,raw:s[0]}):o==="mdmg"?n.push({type:"mdmg",expr:i,raw:s[0]}):o==="tdmg"||o==="tdmg"?n.push({type:"tdmg",expr:i,raw:s[0]}):o==="heal"?n.push({type:"heal",expr:i,raw:s[0]}):o==="theal"||o==="theal"?n.push({type:"theal",expr:i,raw:s[0]}):o==="roll"&&n.push({type:"roll",expr:i,raw:s[0]})}return n}function Ds(t){const e=(t||"").trim();if(!e.startsWith("/"))return null;const n=e.slice(1).trim(),s=n.indexOf(" "),o=s>=0?n.slice(0,s).toLowerCase():n,i=s>=0?n.slice(s+1).trim():"";return nt[o]?{type:"stat",stat:o,expr:i||""}:["pdmg","mdmg","tdmg","heal","theal","roll"].includes(o)?{type:o,expr:i}:null}function ks(t){return xs(t||"")}function pe(t,e,n){const s=Ls(e,Y),{type:o,stat:i,expr:r}=t;if(o==="stat"){const a=i?nt[i]:null,f=a?Y(e,a):0,v=jt(f,r);return{kind:"stat",stat:a,dc:v.dc,roll:v.roll,mod:v.mod,total:v.total,success:v.success,nat1:v.nat1,nat20:v.nat20,result:v}}const u=$s(r,s),d=u.value,c=u.rolls||[];return o==="pdmg"?{kind:"pdmg",value:d,rolls:c,canApply:!0}:o==="mdmg"?{kind:"mdmg",value:d,rolls:c,canApply:!0}:o==="tdmg"?{kind:"tdmg",value:d,rolls:c,canApply:!0}:o==="heal"?{kind:"heal",value:d,rolls:c,canApply:!0}:o==="theal"?{kind:"theal",value:d,rolls:c,canApply:!0}:o==="roll"?{kind:"roll",value:d,rolls:c,canApply:!1}:null}function Hs(t,e){const n=Vs(t),s=Math.max(0,(e||0)-n);return st(t,s)}function Gs(t,e){const n=Fs(t),s=Math.max(0,(e||0)-n);return st(t,s)}function Us(t,e){return st(t,e||0)}function Vs(t){return Es(t)}function Fs(t){return Os(t)}function st(t,e){let n=Math.max(0,Number(t.tempHP)||0),s=Math.max(0,Number(t.currentHP)||0),o=e;if(o>0&&n>0){const i=Math.min(n,o);n-=i,o-=i}return o>0&&(s=Math.max(0,s-o)),{tempHP:n,currentHP:s}}function js(t,e,n){const s=Math.max(0,Number(t.currentHP)||0),o=Math.max(0,Number(n)||0);return{currentHP:Math.min(o,s+(e||0))}}function qs(t,e){return{tempHP:Math.max(0,Number(t.tempHP)||0)+(e||0)}}function Ws(t){return t&&["stat","pdmg","mdmg","tdmg","heal","theal","roll"].includes(t.kind)}const qt="app",Ys=["bio","stats","spells","inventory","chat","notes","settings"],l={locale:"en",roomId:null,sheetIds:[],sheetNames:{},permissions:{},tokenToSheet:{},activeSheetId:null,sheet:null,isGM:!1,playerId:null,activeTab:"bio",chatMessages:[],chatHistoryKey:"foxyverse_chat_",lastRoll:null,lastRollPayload:null,colors:{bg:"#1a1b1e",surface:"#25262b",border:"#373a40",text:"#e8e9ed",accent:"#7950f2"}};function Ks(t){if(l.isGM)return!0;const e=l.permissions[l.playerId];return!e||!e.view||e.view.length===0?!0:e.view.includes(t)}function V(t){if(l.isGM)return!0;const e=l.permissions[l.playerId];return!e||!e.edit||e.edit.length===0?!0:e.edit.includes(t)}function Wt(){return l.sheetIds.filter(Ks)}async function At(){l.roomId=await Vt(),l.sheetIds=await Fe();const t=await be();l.sheetNames=t.sheetNames||{},l.permissions=t.permissions||{},l.tokenToSheet=t.tokenToSheet||{},l.isGM=await Cs()==="GM",l.playerId=await Ss();const e=t.locale||localStorage.getItem("foxyverse_locale")||"en";l.locale=e,Dt(e),await Be({locale:l.locale})}async function re(t){if(!t||!l.roomId){l.sheet=null,l.activeSheetId=t;return}let e=bs(l.roomId,t);e||(e=Ht(t),de(l.roomId,e),await je(t,ve(e))),l.sheet=e,l.activeSheetId=t}function B(){!l.sheet||!l.roomId||(de(l.roomId,l.sheet),Bs(l.roomId,l.sheet).catch(()=>{}))}function zs(){const t=Wt(),e=t.map(s=>`<option value="${s}" ${s===l.activeSheetId?"selected":""}>${l.sheetNames[s]||s.slice(0,8)}</option>`).join(""),n=l.isGM||t.length===0;return`
    <header class="app-header">
      <div class="header-row">
        <select id="sheet-select" class="sheet-select" aria-label="${m("selectSheet")}">
          <option value="">${m("noSheet")}</option>
          ${e}
        </select>
        ${n?`<button type="button" id="btn-new-sheet" class="btn-icon" title="${m("newSheet")}">+</button>`:""}
        <div class="lang-flags">
          <button type="button" class="flag ${l.locale==="en"?"active":""}" data-lang="en" title="English" aria-label="English">EN</button>
          <button type="button" class="flag ${l.locale==="fr"?"active":""}" data-lang="fr" title="Franais" aria-label="Franais">FR</button>
        </div>
      </div>
    </header>
  `}function Js(){return`<nav class="tabs">${Ys.map(e=>`<button type="button" class="tab ${l.activeTab===e?"active":""}" data-tab="${e}">${m("tab"+e.charAt(0).toUpperCase()+e.slice(1))}</button>`).join("")}</nav>`}function bt(){const t=l.sheet;if(!t)return`<div class="card"><p>${m("noSheet")}</p></div>`;const e=t.bio||{};return`
    <div class="card">
      <h2>${m("tabBio")}</h2>
      <div class="form-group">
        <label class="label">${m("name")}</label>
        <input type="text" id="bio-name" value="${S(e.name)}" data-field="bio.name" ${V(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${m("surname")}</label>
        <input type="text" id="bio-surname" value="${S(e.surname)}" data-field="bio.surname" ${V(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${m("element")}</label>
        <input type="text" id="bio-element" value="${S(e.element)}" data-field="bio.element" ${V(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${m("class")}</label>
        <input type="text" id="bio-class" value="${S(e.class)}" data-field="bio.class" ${V(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${m("level")}</label>
        <input type="number" min="1" id="bio-level" value="${Number(e.level)||1}" data-field="bio.level" ${V(t.id)?"":"readonly"} />
      </div>
    </div>
  `}function S(t){return t==null?"":String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function Xs(){const t=l.sheet;if(!t)return`<div class="card"><p>${m("noSheet")}</p></div>`;const e=Gt(t),n=ms(t),s=ys(t),o=_s(t),i=gs(t),r=V(t.id);let u=`
    <div class="stat-row">
      <span class="label">${m("tempHP")}</span>
      <input type="number" min="0" value="${t.tempHP??0}" data-field="tempHP" ${r?"":"readonly"} />
    </div>
    <div class="stat-row">
      <span class="label">${m("currentHP")}</span>
      <input type="number" min="0" max="${e}" value="${t.currentHP??0}" data-field="currentHP" ${r?"":"readonly"} />
      <span class="muted">/ ${e}</span>
    </div>
    <div class="stat-row">
      <span class="label">${m("currentMP")}</span>
      <input type="number" min="0" max="${n}" value="${t.currentMP??0}" data-field="currentMP" ${r?"":"readonly"} />
      <span class="muted">/ ${n}</span>
    </div>
    <div class="stat-row">
      <span class="label">${m("currentFavor")}</span>
      <input type="number" min="0" max="${s}" value="${t.currentFavor??0}" data-field="currentFavor" ${r?"":"readonly"} />
      <span class="muted">/ ${s}</span>
    </div>
    <div class="stat-row">
      <span class="label">${m("action")}</span>
      <span>${o}</span>
      ${r?`<input type="text" placeholder="${m("actionModifier")}" value="${S(t.actionModifier)}" data-field="actionModifier" class="short-input" />`:""}
    </div>
    <div class="stat-row">
      <span class="label">${m("speed")}</span>
      <span class="formula">${i}</span>
      ${r?`<input type="text" placeholder="${m("speedModifier")}" value="${S(t.speedModifier)}" data-field="speedModifier" class="short-input" />`:""}
    </div>
  `;const d=(t.knowledge||[]).map((a,f)=>`
    <div class="knowledge-item" data-idx="${f}">
      <input type="text" value="${S(a.name)}" data-knowledge-name="${f}" ${r?"":"readonly"} />
      <select data-knowledge-tier="${f}" ${r?"":"disabled"}>
        ${[1,2,3,4].map(v=>`<option value="${v}" ${a.tier===v?"selected":""}>${m("tier"+v)}</option>`).join("")}
      </select>
      <label><input type="checkbox" data-knowledge-enabled="${f}" ${a.enabled?"checked":""} ${r?"":"disabled"} /> On</label>
      ${r?`<button type="button" class="btn-sm" data-remove-knowledge="${f}">${m("remove")}</button>`:""}
    </div>
  `).join("");let c="";return kt.forEach(a=>{const f=t.stats[a]||{},v=Y(t,a);a.charAt(0).toUpperCase()+a.slice(1);const E=m(a);c+=`
      <tr>
        <td>${E}</td>
        <td><input type="number" data-stat="${a}.base" value="${f.base??0}" ${r?"":"readonly"} /></td>
        <td><input type="number" data-stat="${a}.xpBonus" value="${f.xpBonus??0}" ${r?"":"readonly"} /></td>
        <td><input type="number" data-stat="${a}.itemBonus" value="${f.itemBonus??0}" readonly /></td>
        <td><input type="number" data-stat="${a}.passiveBonus" value="${f.passiveBonus??0}" ${r?"":"readonly"} /></td>
        <td class="total">${v}</td>
        <td>
          <button type="button" class="btn-roll-stat" data-stat="${a}" data-dc="${v}">${m("roll")}</button>
          <div class="quick-mods" data-stat="${a}">
            <button type="button" data-mod="-10">-10</button>
            <button type="button" data-mod="-5">-5</button>
            <button type="button" data-mod="-3">-3</button>
            <button type="button" data-mod="-1">-1</button>
            <button type="button" data-mod="+1">+1</button>
            <button type="button" data-mod="+3">+3</button>
            <button type="button" data-mod="+5">+5</button>
            <button type="button" data-mod="+10">+10</button>
          </div>
        </td>
      </tr>
    `}),`
    <div class="card">
      <h2>${m("tabStats")}</h2>
      <div class="hp-mp-block">${u}</div>
      <h3>${m("knowledge")}</h3>
      <div class="knowledge-list">${d}</div>
      ${r?`<button type="button" id="btn-add-knowledge" class="btn-sm">${m("addKnowledge")}</button>`:""}
      <table class="stats-table">
        <thead><tr><th></th><th>${m("baseStat")}</th><th>${m("xpBonus")}</th><th>${m("itemBonus")}</th><th>${m("passiveBonus")}</th><th>${m("total")}</th><th>${m("roll")}</th></tr></thead>
        <tbody>${c}</tbody>
      </table>
    </div>
    <div id="roll-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="roll-result-title">${m("result")}</h3>
        <p id="roll-result-text"></p>
        <div id="roll-apply-buttons" class="roll-apply-buttons hidden"></div>
        <button type="button" id="roll-reroll-btn" class="hidden">${m("reroll")} (${m("rerollCost")})</button>
        <button type="button" id="roll-close-btn">${m("close")}</button>
      </div>
    </div>
    <div id="stat-roll-modal" class="modal hidden">
      <div class="modal-content">
        <label>${m("modifier")}</label>
        <input type="text" id="stat-roll-modifier" placeholder="+5 or -3" />
        <button type="button" id="stat-roll-do">${m("roll")}</button>
        <button type="button" id="stat-roll-cancel">${m("cancel")}</button>
      </div>
    </div>
  `}function Zs(){const t=l.sheet;if(!t)return`<div class="card"><p>${m("noSheet")}</p></div>`;const e=V(t.id),s=(t.spells||[]).map((o,i)=>`
    <div class="spell-item card" data-idx="${i}">
      <input type="text" class="spell-name" value="${S(o.name)}" data-spell-name="${i}" placeholder="${m("spellName")}" ${e?"":"readonly"} />
      <textarea class="spell-effect" data-spell-effect="${i}" placeholder="${m("spellEffect")}" ${e?"":"readonly"} rows="2">${S(o.effect)}</textarea>
      <div class="spell-cost">
        <input type="number" min="0" value="${o.cost??0}" data-spell-cost="${i}" ${e?"":"readonly"} />
        <label><input type="radio" name="costType-${i}" value="mp" ${(o.costType||"mp")==="mp"?"checked":""} ${e?"":"disabled"} /> ${m("costMP")}</label>
        <label><input type="radio" name="costType-${i}" value="hp" ${o.costType==="hp"?"checked":""} ${e?"":"disabled"} /> ${m("costHP")}</label>
        ${e?`<button type="button" class="btn-deduct-cost" data-idx="${i}">${m("deductCost")}</button>`:""}
      </div>
      ${e?`<button type="button" class="btn-sm" data-remove-spell="${i}">${m("remove")}</button>`:""}
    </div>
  `).join("");return`
    <div class="card">
      <h2>${m("tabSpells")}</h2>
      <div class="spell-list">${s}</div>
      ${e?`<button type="button" id="btn-add-spell">${m("add")}</button>`:""}
    </div>
  `}function Qs(){const t=l.sheet;if(!t)return`<div class="card"><p>${m("noSheet")}</p></div>`;const e=V(t.id),n=[{key:"consumables",label:m("consumables")},{key:"others",label:m("others")},{key:"weapons",label:m("weapons")},{key:"armor",label:m("armor")},{key:"bags",label:m("bags")}];let s=`<div class="card"><h2>${m("tabInventory")}</h2>`;return n.forEach(({key:o,label:i})=>{const r=t[o]||[];s+=`
      <h3>${i}</h3>
      <ul class="item-list" data-section="${o}">
        ${r.map((u,d)=>`
          <li class="item-line" data-section="${o}" data-idx="${d}">
            <input type="text" class="item-name-inp" value="${S(u.name||"")}" data-item-name="${o}-${d}" placeholder="${m("itemName")}" ${e?"":"readonly"} />
            <input type="number" min="0" class="item-count-inp" value="${u.count!=null?u.count:1}" data-item-count="${o}-${d}" ${e?"":"readonly"} />
            <span class="item-toggle" data-toggle-item="${o}-${d}" title="${m("itemDescription")}"></span>
            <div class="item-detail hidden" id="item-detail-${o}-${d}">
              <textarea data-item-desc="${o}-${d}" ${e?"":"readonly"} placeholder="${m("itemDescription")}">${S(u.description)}</textarea>
              ${u.defense!=null?`<span>${m("defense")}: ${u.defense}</span>`:""}
              ${u.magicalDefense!=null?`<span> ${m("magicalDefense")}: ${u.magicalDefense}</span>`:""}
            </div>
            ${e?`<button type="button" class="btn-sm" data-remove-item="${o}-${d}">${m("remove")}</button>`:""}
          </li>
        `).join("")}
      </ul>
      ${e?`<button type="button" class="btn-add-item" data-section="${o}">${m("add")}</button>`:""}
    `}),s+="</div>",s}function eo(){const e=(l.chatMessages||[]).map(n=>`<div class="chat-msg"><strong>${S(n.from)}:</strong> <span class="chat-body">${Yt(n.body)}</span></div>`).join("");return`
    <div class="card chat-card">
      <h2>${m("tabChat")}</h2>
      <div class="chat-messages" id="chat-messages">${e}</div>
      <div class="chat-input-row">
        <input type="text" id="chat-input" placeholder="${m("chatPlaceholder")}" />
        <button type="button" id="chat-send">${m("send")}</button>
      </div>
    </div>
  `}function Yt(t){if(!t)return"";const e=ks(t);let n=S(t);return e.forEach(s=>{const o=(s.stat||"").toString();n=n.replace(s.raw,`<button type="button" class="inline-roll-btn" data-type="${s.type}" data-expr="${S(s.expr)}" data-stat="${S(o)}">${S(s.raw)}</button>`)}),n}function to(){const t=l.sheet,e=(t==null?void 0:t.notes)??"",n=V(l.activeSheetId);return`
    <div class="card">
      <h2>${m("tabNotes")}</h2>
      <textarea id="notes-area" rows="12" placeholder="${m("notesPlaceholder")}" ${n?"":"readonly"}>${S(e)}</textarea>
    </div>
  `}function no(){var s;const t=l.colors,e=V(l.activeSheetId),n=l.isGM&&((s=l.partyPlayers)!=null&&s.length)?`
      <h3>${m("permissions")}</h3>
      <p class="muted small">${m("gmOnly")}</p>
      <div class="permissions-grid" id="permissions-grid">
        ${l.sheetIds.map(o=>`
          <div class="perm-sheet">
            <strong>${S(l.sheetNames[o]||o.slice(0,8))}</strong>
            ${l.partyPlayers.map(i=>{var r,u;return`
              <label><input type="checkbox" data-perm-view="${o}" data-player="${i.id}" ${(((r=l.permissions[i.id])==null?void 0:r.view)||[]).includes(o)?"checked":""} /> ${S(i.name||i.id)} ${m("view")}</label>
              <label><input type="checkbox" data-perm-edit="${o}" data-player="${i.id}" ${(((u=l.permissions[i.id])==null?void 0:u.edit)||[]).includes(o)?"checked":""} /> ${m("edit")}</label>
            `}).join("")}
          </div>
        `).join("")}
      </div>
    `:"";return`
    <div class="card">
      <h2>${m("tabSettings")}</h2>
      <h3>${m("uiColors")}</h3>
      <div class="color-grid">
        <label>${m("color1")}<input type="color" value="${t.bg}" data-color="bg" ${e?"":"disabled"} /></label>
        <label>${m("color2")}<input type="color" value="${t.surface}" data-color="surface" ${e?"":"disabled"} /></label>
        <label>${m("color3")}<input type="color" value="${t.border}" data-color="border" ${e?"":"disabled"} /></label>
        <label>${m("color4")}<input type="color" value="${t.text}" data-color="text" ${e?"":"disabled"} /></label>
        <label>${m("color5")}<input type="color" value="${t.accent}" data-color="accent" ${e?"":"disabled"} /></label>
      </div>
      ${n}
      <div class="settings-actions">
        <button type="button" id="btn-export-sheet">${m("exportSheet")}</button>
        <button type="button" id="btn-import-sheet">${m("importSheet")}</button>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
      </div>
    </div>
  `}function so(){switch(l.activeTab){case"bio":return bt();case"stats":return Xs();case"spells":return Zs();case"inventory":return Qs();case"chat":return eo();case"notes":return to();case"settings":return no();default:return bt()}}function Kt(){const t=document.documentElement;t.style.setProperty("--bg",l.colors.bg),t.style.setProperty("--surface",l.colors.surface),t.style.setProperty("--border",l.colors.border),t.style.setProperty("--text",l.colors.text),t.style.setProperty("--accent",l.colors.accent)}function R(){const t=document.getElementById(qt);t&&(t.innerHTML=`
    ${zs()}
    ${Js()}
    <main class="tab-content">${so()}</main>
  `,Kt(),oo())}function oo(){var o,i,r,u,d,c,a,f,v,E,O,b,N;const t=document.getElementById(qt);if(!t)return;(o=t.querySelector("#sheet-select"))==null||o.addEventListener("change",async h=>{const p=h.target.value||null;await re(p),B(),R()}),(i=t.querySelector("#btn-new-sheet"))==null||i.addEventListener("click",async()=>{const h=Ht();l.roomId=l.roomId||await Vt(),de(l.roomId,h),await je(h.id,ve(h)),l.sheetIds=await Fe(),l.sheetNames={...l.sheetNames,[h.id]:ve(h)},await re(h.id),R()}),t.querySelectorAll(".flag[data-lang]").forEach(h=>{h.addEventListener("click",async()=>{const p=h.dataset.lang;Dt(p),l.locale=p,localStorage.setItem("foxyverse_locale",p),await Be({locale:p}),R()})}),t.querySelectorAll(".tab[data-tab]").forEach(h=>{h.addEventListener("click",()=>{l.activeTab=h.dataset.tab,R()})}),t.querySelectorAll("[data-field]").forEach(h=>{h.addEventListener("change",p=>{if(!l.sheet)return;const y=p.target.dataset.field;let g=p.target.value;if(y==="bio.level"&&(g=parseInt(g,10)||1),y.startsWith("bio.")){const _=y.split(".")[1];l.sheet.bio||(l.sheet.bio={}),l.sheet.bio[_]=g}else l.sheet[y]=isNaN(Number(g))?g:Number(g);B()})}),t.querySelectorAll("[data-stat]").forEach(h=>{h.addEventListener("change",p=>{if(!l.sheet)return;const[y,g]=p.target.dataset.stat.split(".");l.sheet.stats[y]||(l.sheet.stats[y]={}),l.sheet.stats[y][g]=parseInt(p.target.value,10)||0,B(),l.activeTab==="stats"&&R()})}),(r=t.querySelector("#btn-add-knowledge"))==null||r.addEventListener("click",()=>{l.sheet&&(l.sheet.knowledge||(l.sheet.knowledge=[]),l.sheet.knowledge.push({id:crypto.randomUUID(),name:"",tier:1,enabled:!0}),B(),R())}),t.querySelectorAll("[data-remove-knowledge]").forEach(h=>{h.addEventListener("click",()=>{const p=parseInt(h.dataset.removeKnowledge,10);l.sheet.knowledge.splice(p,1),B(),R()})}),t.querySelectorAll("[data-knowledge-name], [data-knowledge-tier], [data-knowledge-enabled]").forEach(h=>{h.addEventListener("change",p=>{const y=p.target.dataset,g=parseInt(y.knowledgeName??y.knowledgeTier??y.knowledgeEnabled,10);if(isNaN(g)||!l.sheet.knowledge[g])return;const _=l.sheet.knowledge[g];y.knowledgeName!==void 0&&(_.name=p.target.value),y.knowledgeTier!==void 0&&(_.tier=parseInt(p.target.value,10)),y.knowledgeEnabled!==void 0&&(_.enabled=p.target.checked),B()})}),t.querySelectorAll(".btn-roll-stat").forEach(h=>{h.addEventListener("click",()=>{var p;l._rollStat=h.dataset.stat,l._rollDc=parseInt(h.dataset.dc,10),(p=document.getElementById("stat-roll-modal"))==null||p.classList.remove("hidden")})}),(u=t.querySelector("#stat-roll-do"))==null||u.addEventListener("click",()=>{var y,g,_;const h=((y=document.getElementById("stat-roll-modifier"))==null?void 0:y.value)||"",p=jt(l._rollDc,h);l.lastRoll={kind:"stat",stat:l._rollStat,...p},l.lastRollPayload={type:"stat",stat:(g=l._rollStat)==null?void 0:g.replace("strength","str").replace("constitution","con").replace("intelligence","int").replace("perception","per").replace("social","soc").replace("agility","agi").replace("focus","foc"),expr:h},(_=document.getElementById("stat-roll-modal"))==null||_.classList.add("hidden"),e(l.lastRoll),C.notification.show(p.nat20?m("nat20"):p.nat1?m("nat1"):p.success?m("success"):m("failure"))}),(d=t.querySelector("#stat-roll-cancel"))==null||d.addEventListener("click",()=>{var h;(h=document.getElementById("stat-roll-modal"))==null||h.classList.add("hidden")}),t.querySelectorAll(".quick-mods button").forEach(h=>{h.addEventListener("click",p=>{const y=p.target.closest(".quick-mods").dataset.stat,g=p.target.dataset.mod,_={type:"stat",stat:y.replace("strength","str").replace("constitution","con").replace("intelligence","int").replace("perception","per").replace("social","soc").replace("agility","agi").replace("focus","foc"),expr:g},T=pe(_,l.sheet);l.lastRoll=T,l.lastRollPayload=_,e(T)})});function e(h){var T,x,G,se,ot,it;const p=document.getElementById("roll-modal"),y=document.getElementById("roll-result-text"),g=document.getElementById("roll-reroll-btn"),_=document.getElementById("roll-apply-buttons");!p||!y||(p.classList.remove("hidden"),h.kind==="stat"?y.textContent=`${m("dc")} ${h.dc}, ${m("result")}: ${h.roll}${h.mod?(h.mod>=0?"+":"")+h.mod:""} = ${h.total}. ${h.nat1?m("nat1"):h.nat20?m("nat20"):h.success?m("success"):m("failure")}`:y.textContent=`${m("result")}: ${h.value}${(T=h.rolls)!=null&&T.length?" ("+h.rolls.join(", ")+")":""}`,g.classList.toggle("hidden",!l.sheet||l.sheet.currentFavor<1||!Ws(h)),_&&(_.innerHTML="",_.classList.add("hidden"),l.sheet&&h.value!=null&&(h.kind==="pdmg"?(_.innerHTML=`<button type="button" id="roll-apply-pdmg">${m("applyDamage")} (${m("physicalDamage")})</button>`,_.classList.remove("hidden")):h.kind==="mdmg"?(_.innerHTML=`<button type="button" id="roll-apply-mdmg">${m("applyDamage")} (${m("magicDamage")})</button>`,_.classList.remove("hidden")):h.kind==="tdmg"?(_.innerHTML=`<button type="button" id="roll-apply-tdmg">${m("applyDamage")} (${m("trueDamage")})</button>`,_.classList.remove("hidden")):h.kind==="heal"?(_.innerHTML=`<button type="button" id="roll-apply-heal">${m("applyHeal")}</button>`,_.classList.remove("hidden")):h.kind==="theal"&&(_.innerHTML=`<button type="button" id="roll-apply-theal">${m("applyOverHeal")}</button>`,_.classList.remove("hidden"))),(x=_.querySelector("#roll-apply-pdmg"))==null||x.addEventListener("click",()=>{const j=Hs(l.sheet,l.lastRoll.value);Object.assign(l.sheet,j),B(),R(),p.classList.add("hidden")}),(G=_.querySelector("#roll-apply-mdmg"))==null||G.addEventListener("click",()=>{const j=Gs(l.sheet,l.lastRoll.value);Object.assign(l.sheet,j),B(),R(),p.classList.add("hidden")}),(se=_.querySelector("#roll-apply-tdmg"))==null||se.addEventListener("click",()=>{const j=Us(l.sheet,l.lastRoll.value);Object.assign(l.sheet,j),B(),R(),p.classList.add("hidden")}),(ot=_.querySelector("#roll-apply-heal"))==null||ot.addEventListener("click",()=>{const j=Gt(l.sheet),zt=js(l.sheet,l.lastRoll.value,j);Object.assign(l.sheet,zt),B(),R(),p.classList.add("hidden")}),(it=_.querySelector("#roll-apply-theal"))==null||it.addEventListener("click",()=>{const j=qs(l.sheet,l.lastRoll.value);Object.assign(l.sheet,j),B(),R(),p.classList.add("hidden")})))}(c=t.querySelector("#roll-close-btn"))==null||c.addEventListener("click",()=>{var h;return(h=document.getElementById("roll-modal"))==null?void 0:h.classList.add("hidden")}),(a=t.querySelector("#roll-reroll-btn"))==null||a.addEventListener("click",()=>{if(!l.sheet||l.sheet.currentFavor<1)return;l.sheet.currentFavor--,B();const h=pe(l.lastRollPayload,l.sheet);l.lastRoll=h,e(h),R()}),(f=t.querySelector("#btn-add-spell"))==null||f.addEventListener("click",()=>{l.sheet&&(l.sheet.spells||(l.sheet.spells=[]),l.sheet.spells.push({id:crypto.randomUUID(),name:"",effect:"",cost:0,costType:"mp"}),B(),R())}),t.querySelectorAll("[data-remove-spell]").forEach(h=>{h.addEventListener("click",()=>{const p=parseInt(h.dataset.removeSpell,10);l.sheet.spells.splice(p,1),B(),R()})}),t.querySelectorAll("[data-spell-name], [data-spell-effect], [data-spell-cost]").forEach(h=>{h.addEventListener("change",p=>{const y=parseInt(h.dataset.spellName??h.dataset.spellEffect??h.dataset.spellCost,10),g=l.sheet.spells[y];h.dataset.spellName!==void 0&&(g.name=p.target.value),h.dataset.spellEffect!==void 0&&(g.effect=p.target.value),h.dataset.spellCost!==void 0&&(g.cost=parseInt(p.target.value,10)||0),B()})}),t.querySelectorAll("[name^='costType-']").forEach(h=>{h.addEventListener("change",p=>{const y=parseInt(p.target.name.replace("costType-",""),10);l.sheet.spells[y].costType=p.target.value,B()})}),t.querySelectorAll(".btn-deduct-cost").forEach(h=>{h.addEventListener("click",()=>{const p=parseInt(h.dataset.idx,10),y=l.sheet.spells[p],g=y.cost||0;if((y.costType||"mp")==="mp"){const T=l.sheet.currentMP||0;if(T>=g)l.sheet.currentMP=T-g;else{const x=g-T;if(!confirm(m("confirmUseHP")))return;l.sheet.currentMP=0,l.sheet.currentHP=Math.max(0,(l.sheet.currentHP||0)-x)}}else l.sheet.currentHP=Math.max(0,(l.sheet.currentHP||0)-g);B(),R()})}),t.querySelectorAll("[data-toggle-item]").forEach(h=>{h.addEventListener("click",()=>{const p=h.dataset.toggleItem,y=document.getElementById("item-detail-"+p);y&&y.classList.toggle("hidden")})}),t.querySelectorAll("[data-item-name], [data-item-count]").forEach(h=>{h.addEventListener("change",p=>{var G,se;const y=h.dataset.itemName??h.dataset.itemCount,g=y.lastIndexOf("-"),_=y.slice(0,g),T=parseInt(y.slice(g+1),10);if(!((se=(G=l.sheet)==null?void 0:G[_])!=null&&se[T]))return;const x=l.sheet[_][T];h.dataset.itemName!==void 0&&(x.name=p.target.value),h.dataset.itemCount!==void 0&&(x.count=parseInt(p.target.value,10)||0),B()})}),t.querySelectorAll("[data-item-desc]").forEach(h=>{h.addEventListener("change",p=>{var x,G;const y=h.dataset.itemDesc,g=y.lastIndexOf("-"),_=y.slice(0,g),T=parseInt(y.slice(g+1),10);(G=(x=l.sheet)==null?void 0:x[_])!=null&&G[T]&&(l.sheet[_][T].description=p.target.value,B())})}),t.querySelectorAll("[data-remove-item]").forEach(h=>{h.addEventListener("click",()=>{const p=h.dataset.removeItem,y=p.lastIndexOf("-"),g=p.slice(0,y),_=parseInt(p.slice(y+1),10);l.sheet[g]&&l.sheet[g].splice(_,1),B(),R()})}),t.querySelectorAll(".btn-add-item").forEach(h=>{h.addEventListener("click",()=>{const p=h.dataset.section;l.sheet[p]||(l.sheet[p]=[]),l.sheet[p].push({id:crypto.randomUUID(),type:p==="weapons"?"weapon":p==="armor"?"armor":p==="consumables"?"consumable":p==="bags"?"bag":"other",name:"",count:1,description:""}),B(),R()})}),(v=t.querySelector("#notes-area"))==null||v.addEventListener("change",h=>{l.sheet&&(l.sheet.notes=h.target.value,B())});const n=t.querySelector("#chat-input");(E=t.querySelector("#chat-send"))==null||E.addEventListener("click",s),n==null||n.addEventListener("keydown",h=>{h.key==="Enter"&&s()});function s(){var _;const h=(_=n==null?void 0:n.value)==null?void 0:_.trim();if(!h)return;const p=Ds(h);if(p&&l.sheet){const T=pe(p,l.sheet);l.lastRoll=T,l.lastRollPayload=p,C.notification.show(String(T.value??T.roll??T.total??"")),C.broadcast.sendMessage("foxyverse",{type:"chat",from:l.playerName||"Player",body:h,result:T}).catch(()=>{})}else C.broadcast.sendMessage("foxyverse",{type:"chat",from:l.playerName||"Player",body:h}).catch(()=>{});n.value="",l.chatMessages.push({from:l.playerName||"Player",body:h});const y=l.chatHistoryKey+l.roomId;try{localStorage.setItem(y,JSON.stringify(l.chatMessages.slice(-200)))}catch{}const g=document.getElementById("chat-messages");g&&(g.innerHTML+=`<div class="chat-msg"><strong>${S(l.playerName||"You")}:</strong> <span class="chat-body">${Yt(h)}</span></div>`)}t.querySelectorAll("[data-color]").forEach(h=>{h.addEventListener("input",p=>{l.colors[p.target.dataset.color]=p.target.value,Kt(),localStorage.setItem("foxyverse_colors",JSON.stringify(l.colors))})}),t.querySelectorAll("[data-perm-view], [data-perm-edit]").forEach(h=>{h.addEventListener("change",async p=>{if(!l.isGM)return;const y=h.dataset.player,g=h.dataset.permView??h.dataset.permEdit,_=h.dataset.permView!==void 0?"view":"edit",T=JSON.parse(JSON.stringify(l.permissions));T[y]||(T[y]={view:[],edit:[]});const x=T[y][_]||[];p.target.checked?x.includes(g)||(T[y][_]=[...x,g]):T[y][_]=x.filter(G=>G!==g),await As(T),l.permissions=T})}),(O=t.querySelector("#btn-export-sheet"))==null||O.addEventListener("click",()=>{if(!l.sheet)return;const h=new Blob([JSON.stringify(l.sheet,null,2)],{type:"application/json"}),p=document.createElement("a");p.href=URL.createObjectURL(h),p.download=`foxyverse-${l.sheet.id}.json`,p.click(),URL.revokeObjectURL(p.href)}),(b=t.querySelector("#btn-import-sheet"))==null||b.addEventListener("click",()=>{var h;return(h=document.getElementById("import-file-input"))==null?void 0:h.click()}),t.addEventListener("click",h=>{const p=h.target.closest(".inline-roll-btn");if(!p||!l.sheet)return;const y={type:p.dataset.type,expr:p.dataset.expr||"",stat:p.dataset.stat||void 0},g=pe(y,l.sheet);l.lastRoll=g,l.lastRollPayload=y,C.notification.show(g.value!=null?String(g.value):g.roll!=null?`${g.roll} (${g.success?m("success"):m("failure")})`:"")}),(N=t.querySelector("#import-file-input"))==null||N.addEventListener("change",async h=>{var g;const p=(g=h.target.files)==null?void 0:g[0];if(!p||!l.roomId)return;const y=await p.text();try{const _=JSON.parse(y);_.id||(_.id=crypto.randomUUID()),de(l.roomId,_),await je(_.id,ve(_)),l.sheetIds=await Fe();const T=await be();l.sheetNames=T.sheetNames||{},await re(_.id),R()}catch{C.notification.show("Invalid file")}h.target.value=""})}async function io(){await At();const t=localStorage.getItem("foxyverse_colors");if(t)try{l.colors={...l.colors,...JSON.parse(t)}}catch{}l.playerName=await Is();try{l.partyPlayers=await C.party.getPlayers()}catch{l.partyPlayers=[]}const e=l.chatHistoryKey+l.roomId;try{const n=localStorage.getItem(e);n&&(l.chatMessages=JSON.parse(n))}catch{}l.sheetIds.length&&!l.activeSheetId?await re(Wt()[0]||null):l.activeSheetId&&await re(l.activeSheetId),R(),Rs(n=>{var s,o;if(((s=n.data)==null?void 0:s.type)==="sheet_full"&&n.data.roomId===l.roomId&&n.data.sheet&&(de(l.roomId,n.data.sheet),n.data.sheet.id===l.activeSheetId&&(l.sheet=n.data.sheet,R())),((o=n.data)==null?void 0:o.type)==="chat"){l.chatMessages.push({from:n.data.from,body:n.data.body});const i=document.getElementById("chat-messages");i&&l.activeTab==="chat"&&(i.innerHTML+=`<div class="chat-msg"><strong>${S(n.data.from)}:</strong> ${S(n.data.body)}</div>`)}}),C.room.onMetadataChange(async()=>{await At(),R()})}C.onReady(()=>{io()});
