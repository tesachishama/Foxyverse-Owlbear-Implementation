(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();var D=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class en{constructor(e){this.messageBus=e}get id(){if(!this.messageBus.userId)throw Error("Unable to get user ID: not ready");return this.messageBus.userId}getSelection(){return D(this,void 0,void 0,function*(){const{selection:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SELECTION",{});return e})}select(e,n){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:e,replace:n})})}deselect(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_DESELECT",{items:e})})}getName(){return D(this,void 0,void 0,function*(){const{name:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_NAME",{});return e})}setName(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_NAME",{name:e})})}getColor(){return D(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_COLOR",{});return e})}setColor(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_COLOR",{color:e})})}getSyncView(){return D(this,void 0,void 0,function*(){const{syncView:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SYNC_VIEW",{});return e})}setSyncView(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_SYNC_VIEW",{syncView:e})})}getId(){return D(this,void 0,void 0,function*(){const{id:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ID",{});return e})}getRole(){return D(this,void 0,void 0,function*(){const{role:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ROLE",{});return e})}getMetadata(){return D(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_METADATA",{});return e})}setMetadata(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_METADATA",{update:e})})}hasPermission(e){return D(this,void 0,void 0,function*(){if((yield this.getRole())==="GM")return!0;const{permissions:s}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return s.indexOf(e)>-1})}getConnectionId(){return D(this,void 0,void 0,function*(){const{connectionId:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_CONNECTION_ID",{});return e})}onChange(e){const n=s=>{e(s.player)};return this.messageBus.send("OBR_PLAYER_SUBSCRIBE",{}),this.messageBus.on("OBR_PLAYER_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PLAYER_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PLAYER_EVENT_CHANGE",n)}}}var F=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class tn{constructor(e){this.messageBus=e}reset(){return F(this,void 0,void 0,function*(){const{transform:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_RESET",{});return e})}animateTo(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO",{transform:e})})}animateToBounds(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO_BOUNDS",{bounds:e})})}getPosition(){return F(this,void 0,void 0,function*(){const{position:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_POSITION",{});return e})}setPosition(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_POSITION",{position:e})})}getScale(){return F(this,void 0,void 0,function*(){const{scale:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_SCALE",{});return e})}setScale(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_SCALE",{scale:e})})}getWidth(){return F(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_WIDTH",{});return e})}getHeight(){return F(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_HEIGHT",{});return e})}transformPoint(e){return F(this,void 0,void 0,function*(){const{point:n}=yield this.messageBus.sendAsync("OBR_VIEWPORT_TRANSFORM_POINT",{point:e});return n})}inverseTransformPoint(e){return F(this,void 0,void 0,function*(){const{point:n}=yield this.messageBus.sendAsync("OBR_VIEWPORT_INVERSE_TRANSFORM_POINT",{point:e});return n})}}function nn(t){return typeof t.id=="string"}var ze={exports:{}},ie=typeof Reflect=="object"?Reflect:null,ct=ie&&typeof ie.apply=="function"?ie.apply:function(e,n,s){return Function.prototype.apply.call(e,n,s)},Ee;ie&&typeof ie.ownKeys=="function"?Ee=ie.ownKeys:Object.getOwnPropertySymbols?Ee=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Ee=function(e){return Object.getOwnPropertyNames(e)};function sn(t){console&&console.warn&&console.warn(t)}var wt=Number.isNaN||function(e){return e!==e};function A(){A.init.call(this)}ze.exports=A;ze.exports.once=ln;A.EventEmitter=A;A.prototype._events=void 0;A.prototype._eventsCount=0;A.prototype._maxListeners=void 0;var dt=10;function Re(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(A,"defaultMaxListeners",{enumerable:!0,get:function(){return dt},set:function(t){if(typeof t!="number"||t<0||wt(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");dt=t}});A.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};A.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||wt(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Ct(t){return t._maxListeners===void 0?A.defaultMaxListeners:t._maxListeners}A.prototype.getMaxListeners=function(){return Ct(this)};A.prototype.emit=function(e){for(var n=[],s=1;s<arguments.length;s++)n.push(arguments[s]);var o=e==="error",i=this._events;if(i!==void 0)o=o&&i.error===void 0;else if(!o)return!1;if(o){var a;if(n.length>0&&(a=n[0]),a instanceof Error)throw a;var h=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw h.context=a,h}var u=i[e];if(u===void 0)return!1;if(typeof u=="function")ct(u,this,n);else for(var c=u.length,r=Pt(u,c),s=0;s<c;++s)ct(r[s],this,n);return!0};function Nt(t,e,n,s){var o,i,a;if(Re(n),i=t._events,i===void 0?(i=t._events=Object.create(null),t._eventsCount=0):(i.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),i=t._events),a=i[e]),a===void 0)a=i[e]=n,++t._eventsCount;else if(typeof a=="function"?a=i[e]=s?[n,a]:[a,n]:s?a.unshift(n):a.push(n),o=Ct(t),o>0&&a.length>o&&!a.warned){a.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=t,h.type=e,h.count=a.length,sn(h)}return t}A.prototype.addListener=function(e,n){return Nt(this,e,n,!1)};A.prototype.on=A.prototype.addListener;A.prototype.prependListener=function(e,n){return Nt(this,e,n,!0)};function on(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Mt(t,e,n){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},o=on.bind(s);return o.listener=n,s.wrapFn=o,o}A.prototype.once=function(e,n){return Re(n),this.on(e,Mt(this,e,n)),this};A.prototype.prependOnceListener=function(e,n){return Re(n),this.prependListener(e,Mt(this,e,n)),this};A.prototype.removeListener=function(e,n){var s,o,i,a,h;if(Re(n),o=this._events,o===void 0)return this;if(s=o[e],s===void 0)return this;if(s===n||s.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,s.listener||n));else if(typeof s!="function"){for(i=-1,a=s.length-1;a>=0;a--)if(s[a]===n||s[a].listener===n){h=s[a].listener,i=a;break}if(i<0)return this;i===0?s.shift():an(s,i),s.length===1&&(o[e]=s[0]),o.removeListener!==void 0&&this.emit("removeListener",e,h||n)}return this};A.prototype.off=A.prototype.removeListener;A.prototype.removeAllListeners=function(e){var n,s,o;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var i=Object.keys(s),a;for(o=0;o<i.length;++o)a=i[o],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=s[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(o=n.length-1;o>=0;o--)this.removeListener(e,n[o]);return this};function Lt(t,e,n){var s=t._events;if(s===void 0)return[];var o=s[e];return o===void 0?[]:typeof o=="function"?n?[o.listener||o]:[o]:n?rn(o):Pt(o,o.length)}A.prototype.listeners=function(e){return Lt(this,e,!0)};A.prototype.rawListeners=function(e){return Lt(this,e,!1)};A.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):$t.call(t,e)};A.prototype.listenerCount=$t;function $t(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}A.prototype.eventNames=function(){return this._eventsCount>0?Ee(this._events):[]};function Pt(t,e){for(var n=new Array(e),s=0;s<e;++s)n[s]=t[s];return n}function an(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function rn(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function ln(t,e){return new Promise(function(n,s){function o(a){t.removeListener(e,i),s(a)}function i(){typeof t.removeListener=="function"&&t.removeListener("error",o),n([].slice.call(arguments))}xt(t,e,i,{once:!0}),e!=="error"&&cn(t,o,{once:!0})})}function cn(t,e,n){typeof t.on=="function"&&xt(t,"error",e,n)}function xt(t,e,n,s){if(typeof t.on=="function")s.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function o(i){s.once&&t.removeEventListener(e,o),n(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}var dn=ze.exports;let ye;const un=new Uint8Array(16);function fn(){if(!ye&&(ye=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ye))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ye(un)}const N=[];for(let t=0;t<256;++t)N.push((t+256).toString(16).slice(1));function hn(t,e=0){return N[t[e+0]]+N[t[e+1]]+N[t[e+2]]+N[t[e+3]]+"-"+N[t[e+4]]+N[t[e+5]]+"-"+N[t[e+6]]+N[t[e+7]]+"-"+N[t[e+8]]+N[t[e+9]]+"-"+N[t[e+10]]+N[t[e+11]]+N[t[e+12]]+N[t[e+13]]+N[t[e+14]]+N[t[e+15]]}const pn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ut={randomUUID:pn};function mn(t,e,n){if(ut.randomUUID&&!t)return ut.randomUUID();t=t||{};const s=t.random||(t.rng||fn)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,hn(s)}class yn extends dn.EventEmitter{constructor(e,n){super(),this.ready=!1,this.userId=null,this.ref=null,this.handleMessage=s=>{const o=s.data;if(s.origin===this.targetOrigin&&nn(o)){if(o.id==="OBR_READY"){this.ready=!0;const i=o.data;this.ref=i.ref,this.userId=i.userId}this.emit(o.id,o.data)}},this.send=(s,o,i)=>{var a;if(!this.ref)throw Error("Unable to send message: not ready");(a=window.parent)===null||a===void 0||a.postMessage({id:s,data:o,ref:this.ref,nonce:i},this.targetOrigin)},this.sendAsync=(s,o,i=5e3)=>{const a=`_${mn()}`;return this.send(s,o,a),Promise.race([new Promise((h,u)=>{const c=this;function r(_){c.off(`${s}_RESPONSE${a}`,r),c.off(`${s}_ERROR${a}`,f),h(_)}function f(_){c.off(`${s}_RESPONSE${a}`,r),c.off(`${s}_ERROR${a}`,f),u(_)}this.on(`${s}_RESPONSE${a}`,r),this.on(`${s}_ERROR${a}`,f)}),new Promise((h,u)=>window.setTimeout(()=>u(new Error(`Message ${s} took longer than ${i}ms to get a result`)),i))])},this.roomId=n,this.targetOrigin=e,window.addEventListener("message",this.handleMessage),this.setMaxListeners(100)}destroy(){window.removeEventListener("message",this.handleMessage)}}var ft=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class vn{constructor(e){this.messageBus=e}show(e,n){return ft(this,void 0,void 0,function*(){const{id:s}=yield this.messageBus.sendAsync("OBR_NOTIFICATION_SHOW",{message:e,variant:n});return s})}close(e){return ft(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_NOTIFICATION_CLOSE",{id:e})})}}var te=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class gn{constructor(e){this.messageBus=e}getColor(){return te(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_COLOR",{});return e})}setColor(e){return te(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_COLOR",{color:e})})}getStrokeWidth(){return te(this,void 0,void 0,function*(){const{strokeWidth:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_STROKE_WIDTH",{});return e})}setStrokeWidth(e){return te(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_STROKE_WIDTH",{strokeWidth:e})})}getFilled(){return te(this,void 0,void 0,function*(){const{filled:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_FILLED",{});return e})}setFilled(e){return te(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_FILLED",{filled:e})})}onChange(e){const n=s=>{e(s.fog)};return this.messageBus.send("OBR_SCENE_FOG_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_FOG_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_FOG_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_FOG_EVENT_CHANGE",n)}}}var k=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class _n{constructor(e){this.messageBus=e}getDpi(){return k(this,void 0,void 0,function*(){const{dpi:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DPI",{});return e})}getScale(){return k(this,void 0,void 0,function*(){return yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_SCALE",{})})}setScale(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_SCALE",{scale:e})})}getColor(){return k(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_COLOR",{});return e})}setColor(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_COLOR",{color:e})})}getOpacity(){return k(this,void 0,void 0,function*(){const{opacity:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_OPACITY",{});return e})}setOpacity(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_OPACITY",{opacity:e})})}getType(){return k(this,void 0,void 0,function*(){const{type:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_TYPE",{});return e})}setType(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_TYPE",{type:e})})}getLineType(){return k(this,void 0,void 0,function*(){const{lineType:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_LINE_TYPE",{});return e})}setLineType(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_LINE_TYPE",{lineType:e})})}getMeasurement(){return k(this,void 0,void 0,function*(){const{measurement:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_MEASUREMENT",{});return e})}setMeasurement(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_MEASUREMENT",{measurement:e})})}snapPosition(e,n,s){return k(this,void 0,void 0,function*(){const{position:o}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_SNAP_POSITION",{position:e,snappingSensitivity:n,useCorners:s});return o})}getDistance(e,n){return k(this,void 0,void 0,function*(){const{distance:s}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DISTANCE",{from:e,to:n});return s})}onChange(e){const n=s=>{e(s.grid)};return this.messageBus.send("OBR_SCENE_GRID_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_GRID_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_GRID_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_GRID_EVENT_CHANGE",n)}}}var ve=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class En{constructor(e){this.messageBus=e}undo(){return ve(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_UNDO",{})})}redo(){return ve(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_REDO",{})})}canUndo(){return ve(this,void 0,void 0,function*(){const{canUndo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_UNDO",{});return e})}canRedo(){return ve(this,void 0,void 0,function*(){const{canRedo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_REDO",{});return e})}}function P(t){for(var e=arguments.length,n=Array(e>1?e-1:0),s=1;s<e;s++)n[s-1]=arguments[s];throw Error("[Immer] minified error nr: "+t+(n.length?" "+n.map(function(o){return"'"+o+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function ee(t){return!!t&&!!t[G]}function z(t){var e;return!!t&&(function(n){if(!n||typeof n!="object")return!1;var s=Object.getPrototypeOf(n);if(s===null)return!0;var o=Object.hasOwnProperty.call(s,"constructor")&&s.constructor;return o===Object||typeof o=="function"&&Function.toString.call(o)===In}(t)||Array.isArray(t)||!!t[le]||!!(!((e=t.constructor)===null||e===void 0)&&e[le])||Be(t)||Ie(t))}function ae(t,e,n){n===void 0&&(n=!1),J(t)===0?(n?Object.keys:nt)(t).forEach(function(s){n&&typeof s=="symbol"||e(s,t[s],t)}):t.forEach(function(s,o){return e(o,s,t)})}function J(t){var e=t[G];return e?e.i>3?e.i-4:e.i:Array.isArray(t)?1:Be(t)?2:Ie(t)?3:0}function ue(t,e){return J(t)===2?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function Oe(t,e){return J(t)===2?t.get(e):t[e]}function Dt(t,e,n){var s=J(t);s===2?t.set(e,n):s===3?t.add(n):t[e]=n}function On(t,e){return t===e?t!==0||1/t==1/e:t!=t&&e!=e}function Be(t){return Rn&&t instanceof Map}function Ie(t){return Bn&&t instanceof Set}function X(t){return t.o||t.t}function Je(t){if(Array.isArray(t))return Array.prototype.slice.call(t);var e=wn(t);delete e[G];for(var n=nt(e),s=0;s<n.length;s++){var o=n[s],i=e[o];i.writable===!1&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(e[o]={configurable:!0,writable:!0,enumerable:i.enumerable,value:t[o]})}return Object.create(Object.getPrototypeOf(t),e)}function Xe(t,e){return e===void 0&&(e=!1),Ze(t)||ee(t)||!z(t)||(J(t)>1&&(t.set=t.add=t.clear=t.delete=Tn),Object.freeze(t),e&&ae(t,function(n,s){return Xe(s,!0)},!0)),t}function Tn(){P(2)}function Ze(t){return t==null||typeof t!="object"||Object.isFrozen(t)}function W(t){var e=Ge[t];return e||P(18,t),e}function bn(t,e){Ge[t]||(Ge[t]=e)}function ht(){return fe}function we(t,e){e&&(W("Patches"),t.u=[],t.s=[],t.v=e)}function be(t){De(t),t.p.forEach(An),t.p=null}function De(t){t===fe&&(fe=t.l)}function pt(t){return fe={p:[],l:fe,h:t,m:!0,_:0}}function An(t){var e=t[G];e.i===0||e.i===1?e.j():e.g=!0}function Ce(t,e){e._=e.p.length;var n=e.p[0],s=t!==void 0&&t!==n;return e.h.O||W("ES5").S(e,t,s),s?(n[G].P&&(be(e),P(4)),z(t)&&(t=Ae(e,t),e.l||Se(e,t)),e.u&&W("Patches").M(n[G].t,t,e.u,e.s)):t=Ae(e,n,[]),be(e),e.u&&e.v(e.u,e.s),t!==tt?t:void 0}function Ae(t,e,n){if(Ze(e))return e;var s=e[G];if(!s)return ae(e,function(h,u){return mt(t,s,e,h,u,n)},!0),e;if(s.A!==t)return e;if(!s.P)return Se(t,s.t,!0),s.t;if(!s.I){s.I=!0,s.A._--;var o=s.i===4||s.i===5?s.o=Je(s.k):s.o,i=o,a=!1;s.i===3&&(i=new Set(o),o.clear(),a=!0),ae(i,function(h,u){return mt(t,s,o,h,u,n,a)}),Se(t,o,!1),n&&t.u&&W("Patches").N(s,n,t.u,t.s)}return s.o}function mt(t,e,n,s,o,i,a){if(ee(o)){var h=Ae(t,o,i&&e&&e.i!==3&&!ue(e.R,s)?i.concat(s):void 0);if(Dt(n,s,h),!ee(h))return;t.m=!1}else a&&n.add(o);if(z(o)&&!Ze(o)){if(!t.h.D&&t._<1)return;Ae(t,o),e&&e.A.l||Se(t,o)}}function Se(t,e,n){n===void 0&&(n=!1),!t.l&&t.h.D&&t.m&&Xe(e,n)}function Ne(t,e){var n=t[G];return(n?X(n):t)[e]}function yt(t,e){if(e in t)for(var n=Object.getPrototypeOf(t);n;){var s=Object.getOwnPropertyDescriptor(n,e);if(s)return s;n=Object.getPrototypeOf(n)}}function ke(t){t.P||(t.P=!0,t.l&&ke(t.l))}function Me(t){t.o||(t.o=Je(t.t))}function He(t,e,n){var s=Be(e)?W("MapSet").F(e,n):Ie(e)?W("MapSet").T(e,n):t.O?function(o,i){var a=Array.isArray(o),h={i:a?1:0,A:i?i.A:ht(),P:!1,I:!1,R:{},l:i,t:o,k:null,o:null,j:null,C:!1},u=h,c=Ue;a&&(u=[h],c=re);var r=Proxy.revocable(u,c),f=r.revoke,_=r.proxy;return h.k=_,h.j=f,_}(e,n):W("ES5").J(e,n);return(n?n.A:ht()).p.push(s),s}function Sn(t){return ee(t)||P(22,t),function e(n){if(!z(n))return n;var s,o=n[G],i=J(n);if(o){if(!o.P&&(o.i<4||!W("ES5").K(o)))return o.t;o.I=!0,s=vt(n,i),o.I=!1}else s=vt(n,i);return ae(s,function(a,h){o&&Oe(o.t,a)===h||Dt(s,a,e(h))}),i===3?new Set(s):s}(t)}function vt(t,e){switch(e){case 2:return new Map(t);case 3:return Array.from(t)}return Je(t)}function Qe(){function t(s){if(!z(s))return s;if(Array.isArray(s))return s.map(t);if(Be(s))return new Map(Array.from(s.entries()).map(function(a){return[a[0],t(a[1])]}));if(Ie(s))return new Set(Array.from(s).map(t));var o=Object.create(Object.getPrototypeOf(s));for(var i in s)o[i]=t(s[i]);return ue(s,le)&&(o[le]=s[le]),o}function e(s){return ee(s)?t(s):s}var n="add";bn("Patches",{$:function(s,o){return o.forEach(function(i){for(var a=i.path,h=i.op,u=s,c=0;c<a.length-1;c++){var r=J(u),f=a[c];typeof f!="string"&&typeof f!="number"&&(f=""+f),r!==0&&r!==1||f!=="__proto__"&&f!=="constructor"||P(24),typeof u=="function"&&f==="prototype"&&P(24),typeof(u=Oe(u,f))!="object"&&P(15,a.join("/"))}var _=J(u),E=t(i.value),T=a[a.length-1];switch(h){case"replace":switch(_){case 2:return u.set(T,E);case 3:P(16);default:return u[T]=E}case n:switch(_){case 1:return T==="-"?u.push(E):u.splice(T,0,E);case 2:return u.set(T,E);case 3:return u.add(E);default:return u[T]=E}case"remove":switch(_){case 1:return u.splice(T,1);case 2:return u.delete(T);case 3:return u.delete(i.value);default:return delete u[T]}default:P(17,h)}}),s},N:function(s,o,i,a){switch(s.i){case 0:case 4:case 2:return function(h,u,c,r){var f=h.t,_=h.o;ae(h.R,function(E,T){var I=Oe(f,E),M=Oe(_,E),L=T?ue(f,E)?"replace":n:"remove";if(I!==M||L!=="replace"){var $=u.concat(E);c.push(L==="remove"?{op:L,path:$}:{op:L,path:$,value:M}),r.push(L===n?{op:"remove",path:$}:L==="remove"?{op:n,path:$,value:e(I)}:{op:"replace",path:$,value:e(I)})}})}(s,o,i,a);case 5:case 1:return function(h,u,c,r){var f=h.t,_=h.R,E=h.o;if(E.length<f.length){var T=[E,f];f=T[0],E=T[1];var I=[r,c];c=I[0],r=I[1]}for(var M=0;M<f.length;M++)if(_[M]&&E[M]!==f[M]){var L=u.concat([M]);c.push({op:"replace",path:L,value:e(E[M])}),r.push({op:"replace",path:L,value:e(f[M])})}for(var $=f.length;$<E.length;$++){var d=u.concat([$]);c.push({op:n,path:d,value:e(E[$])})}f.length<E.length&&r.push({op:"replace",path:u.concat(["length"]),value:f.length})}(s,o,i,a);case 3:return function(h,u,c,r){var f=h.t,_=h.o,E=0;f.forEach(function(T){if(!_.has(T)){var I=u.concat([E]);c.push({op:"remove",path:I,value:T}),r.unshift({op:n,path:I,value:T})}E++}),E=0,_.forEach(function(T){if(!f.has(T)){var I=u.concat([E]);c.push({op:n,path:I,value:T}),r.unshift({op:"remove",path:I,value:T})}E++})}(s,o,i,a)}},M:function(s,o,i,a){i.push({op:"replace",path:[],value:o===tt?void 0:o}),a.push({op:"replace",path:[],value:s})}})}var gt,fe,et=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",Rn=typeof Map<"u",Bn=typeof Set<"u",_t=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",tt=et?Symbol.for("immer-nothing"):((gt={})["immer-nothing"]=!0,gt),le=et?Symbol.for("immer-draftable"):"__$immer_draftable",G=et?Symbol.for("immer-state"):"__$immer_state",In=""+Object.prototype.constructor,nt=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Object.getOwnPropertyNames,wn=Object.getOwnPropertyDescriptors||function(t){var e={};return nt(t).forEach(function(n){e[n]=Object.getOwnPropertyDescriptor(t,n)}),e},Ge={},Ue={get:function(t,e){if(e===G)return t;var n=X(t);if(!ue(n,e))return function(o,i,a){var h,u=yt(i,a);return u?"value"in u?u.value:(h=u.get)===null||h===void 0?void 0:h.call(o.k):void 0}(t,n,e);var s=n[e];return t.I||!z(s)?s:s===Ne(t.t,e)?(Me(t),t.o[e]=He(t.A.h,s,t)):s},has:function(t,e){return e in X(t)},ownKeys:function(t){return Reflect.ownKeys(X(t))},set:function(t,e,n){var s=yt(X(t),e);if(s!=null&&s.set)return s.set.call(t.k,n),!0;if(!t.P){var o=Ne(X(t),e),i=o==null?void 0:o[G];if(i&&i.t===n)return t.o[e]=n,t.R[e]=!1,!0;if(On(n,o)&&(n!==void 0||ue(t.t,e)))return!0;Me(t),ke(t)}return t.o[e]===n&&(n!==void 0||e in t.o)||Number.isNaN(n)&&Number.isNaN(t.o[e])||(t.o[e]=n,t.R[e]=!0),!0},deleteProperty:function(t,e){return Ne(t.t,e)!==void 0||e in t.t?(t.R[e]=!1,Me(t),ke(t)):delete t.R[e],t.o&&delete t.o[e],!0},getOwnPropertyDescriptor:function(t,e){var n=X(t),s=Reflect.getOwnPropertyDescriptor(n,e);return s&&{writable:!0,configurable:t.i!==1||e!=="length",enumerable:s.enumerable,value:n[e]}},defineProperty:function(){P(11)},getPrototypeOf:function(t){return Object.getPrototypeOf(t.t)},setPrototypeOf:function(){P(12)}},re={};ae(Ue,function(t,e){re[t]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),re.deleteProperty=function(t,e){return re.set.call(this,t,e,void 0)},re.set=function(t,e,n){return Ue.set.call(this,t[0],e,n,t[0])};var Cn=function(){function t(n){var s=this;this.O=_t,this.D=!0,this.produce=function(o,i,a){if(typeof o=="function"&&typeof i!="function"){var h=i;i=o;var u=s;return function(I){var M=this;I===void 0&&(I=h);for(var L=arguments.length,$=Array(L>1?L-1:0),d=1;d<L;d++)$[d-1]=arguments[d];return u.produce(I,function(m){var y;return(y=i).call.apply(y,[M,m].concat($))})}}var c;if(typeof i!="function"&&P(6),a!==void 0&&typeof a!="function"&&P(7),z(o)){var r=pt(s),f=He(s,o,void 0),_=!0;try{c=i(f),_=!1}finally{_?be(r):De(r)}return typeof Promise<"u"&&c instanceof Promise?c.then(function(I){return we(r,a),Ce(I,r)},function(I){throw be(r),I}):(we(r,a),Ce(c,r))}if(!o||typeof o!="object"){if((c=i(o))===void 0&&(c=o),c===tt&&(c=void 0),s.D&&Xe(c,!0),a){var E=[],T=[];W("Patches").M(o,c,E,T),a(E,T)}return c}P(21,o)},this.produceWithPatches=function(o,i){if(typeof o=="function")return function(c){for(var r=arguments.length,f=Array(r>1?r-1:0),_=1;_<r;_++)f[_-1]=arguments[_];return s.produceWithPatches(c,function(E){return o.apply(void 0,[E].concat(f))})};var a,h,u=s.produce(o,i,function(c,r){a=c,h=r});return typeof Promise<"u"&&u instanceof Promise?u.then(function(c){return[c,a,h]}):[u,a,h]},typeof(n==null?void 0:n.useProxies)=="boolean"&&this.setUseProxies(n.useProxies),typeof(n==null?void 0:n.autoFreeze)=="boolean"&&this.setAutoFreeze(n.autoFreeze)}var e=t.prototype;return e.createDraft=function(n){z(n)||P(8),ee(n)&&(n=Sn(n));var s=pt(this),o=He(this,n,void 0);return o[G].C=!0,De(s),o},e.finishDraft=function(n,s){var o=n&&n[G],i=o.A;return we(i,s),Ce(void 0,i)},e.setAutoFreeze=function(n){this.D=n},e.setUseProxies=function(n){n&&!_t&&P(20),this.O=n},e.applyPatches=function(n,s){var o;for(o=s.length-1;o>=0;o--){var i=s[o];if(i.path.length===0&&i.op==="replace"){n=i.value;break}}o>-1&&(s=s.slice(o+1));var a=W("Patches").$;return ee(n)?a(n,s):this.produce(n,function(h){return a(h,s)})},t}(),U=new Cn;U.produce;var st=U.produceWithPatches.bind(U);U.setAutoFreeze.bind(U);U.setUseProxies.bind(U);U.applyPatches.bind(U);U.createDraft.bind(U);U.finishDraft.bind(U);var ne=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};Qe();class Nn{constructor(e){this.messageBus=e}getItems(e){return ne(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEMS",{ids:e});return n}else if(e){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return n.filter(e)}else{const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return n}})}isItemArray(e){return Array.isArray(e)&&e.every(n=>typeof n!="string")}updateItems(e,n){return ne(this,void 0,void 0,function*(){let s;this.isItemArray(e)?s=e:s=yield this.getItems(e);const[o,i]=st(s,n),a=o.map(h=>({id:h.id,type:h.type}));for(const h of i){const[u,c]=h.path;typeof u=="number"&&typeof c=="string"&&(a[u][c]=o[u][c])}yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_UPDATE_ITEMS",{updates:a})})}addItems(e){return ne(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_ADD_ITEMS",{items:e})})}deleteItems(e){return ne(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return ne(this,void 0,void 0,function*(){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_ATTACHMENTS",{ids:e});return n})}getItemBounds(e){return ne(this,void 0,void 0,function*(){const{bounds:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_BOUNDS",{ids:e});return n})}onChange(e){const n=s=>{e(s.items)};return this.messageBus.send("OBR_SCENE_ITEMS_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_ITEMS_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_ITEMS_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_ITEMS_EVENT_CHANGE",n)}}}var se=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};Qe();class Mn{constructor(e){this.messageBus=e}getItems(e){return se(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEMS",{ids:e});return n}else if(e){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return n.filter(e)}else{const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return n}})}updateItems(e,n,s){return se(this,void 0,void 0,function*(){const o=yield this.getItems(e),[i,a]=st(o,n),h=i.map(u=>({id:u.id,type:u.type}));for(const u of a){const[c,r]=u.path;typeof c=="number"&&typeof r=="string"&&(h[c][r]=i[c][r])}yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_UPDATE_ITEMS",{updates:h,fastUpdate:s})})}addItems(e){return se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_ADD_ITEMS",{items:e})})}deleteItems(e){return se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return se(this,void 0,void 0,function*(){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_ATTACHMENTS",{ids:e});return n})}getItemBounds(e){return se(this,void 0,void 0,function*(){const{bounds:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_BOUNDS",{ids:e});return n})}onChange(e){const n=s=>{e(s.items)};return this.messageBus.send("OBR_SCENE_LOCAL_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_LOCAL_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_LOCAL_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_LOCAL_EVENT_CHANGE",n)}}}var Le=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class Ln{constructor(e){this.messageBus=e,this.grid=new _n(e),this.fog=new gn(e),this.history=new En(e),this.items=new Nn(e),this.local=new Mn(e)}isReady(){return Le(this,void 0,void 0,function*(){const{ready:e}=yield this.messageBus.sendAsync("OBR_SCENE_IS_READY",{});return e})}onReadyChange(e){const n=s=>{e(s.ready)};return this.messageBus.send("OBR_SCENE_READY_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_EVENT_READY_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_READY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_EVENT_READY_CHANGE",n)}}getMetadata(){return Le(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_SCENE_GET_METADATA",{});return e})}setMetadata(e){return Le(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_SET_METADATA",{update:e})})}onMetadataChange(e){const n=s=>{e(s.metadata)};return this.messageBus.send("OBR_SCENE_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_METADATA_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_METADATA_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_METADATA_EVENT_CHANGE",n)}}}function ce(t){return t.map(e=>Object.assign(Object.assign({},e),{icon:e.icon.startsWith("http")?e.icon:`${window.location.origin}${e.icon}`}))}function kt(t){return Object.assign(Object.assign({},t),{url:t.url.startsWith("http")?t.url:`${window.location.origin}${t.url}`})}var Et=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class $n{constructor(e){this.contextMenus={},this.handleClick=n=>{const s=this.contextMenus[n.id];s&&s.onClick(n.context,n.elementId)},this.messageBus=e,e.on("OBR_CONTEXT_MENU_EVENT_CLICK",this.handleClick)}create(e){return Et(this,void 0,void 0,function*(){this.messageBus.sendAsync("OBR_CONTEXT_MENU_CREATE",{id:e.id,shortcut:e.shortcut,icons:ce(e.icons)}),this.contextMenus[e.id]=e})}remove(e){return Et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_CONTEXT_MENU_REMOVE",{id:e}),delete this.contextMenus[e]})}}var q=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class Pn{constructor(e){this.tools={},this.toolActions={},this.toolModes={},this.handleToolClick=n=>{const s=this.tools[n.id];if(s)if(s.onClick){const o=s.onClick(n.context,n.elementId);Promise.resolve(o).then(i=>{i&&this.messageBus.send("OBR_TOOL_ACTIVATE",{id:n.id})})}else this.messageBus.send("OBR_TOOL_ACTIVATE",{id:n.id})},this.handleToolActionClick=n=>{var s;const o=this.toolActions[n.id];o&&((s=o.onClick)===null||s===void 0||s.call(o,n.context,n.elementId))},this.handleToolModeClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onClick){const o=s.onClick(n.context,n.elementId);Promise.resolve(o).then(i=>{i&&this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:n.context.activeTool,modeId:n.id})})}else this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:n.context.activeTool,modeId:n.id})},this.handleToolModeToolClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onToolClick){const o=s.onToolClick(n.context,n.event);Promise.resolve(o).then(i=>{i&&n.event.target&&!n.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})})}else n.event.target&&!n.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})},this.handleToolModeToolDoubleClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onToolDoubleClick){const o=s.onToolDoubleClick(n.context,n.event);Promise.resolve(o).then(i=>{i&&n.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})})}else n.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})},this.handleToolModeToolDown=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDown)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolMove=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolMove)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolUp=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolUp)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragStart=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragStart)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragMove=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragMove)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragEnd=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragEnd)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeToolDragCancel=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onToolDragCancel)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeKeyDown=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onKeyDown)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeKeyUp=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onKeyUp)===null||s===void 0||s.call(o,n.context,n.event))},this.handleToolModeActivate=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onActivate)===null||s===void 0||s.call(o,n.context))},this.handleToolModeDeactivate=n=>{var s;const o=this.toolModes[n.id];o&&((s=o.onDeactivate)===null||s===void 0||s.call(o,n.context))},this.messageBus=e,e.on("OBR_TOOL_EVENT_CLICK",this.handleToolClick),e.on("OBR_TOOL_ACTION_EVENT_CLICK",this.handleToolActionClick),e.on("OBR_TOOL_MODE_EVENT_CLICK",this.handleToolModeClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_CLICK",this.handleToolModeToolClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOUBLE_CLICK",this.handleToolModeToolDoubleClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOWN",this.handleToolModeToolDown),e.on("OBR_TOOL_MODE_EVENT_TOOL_MOVE",this.handleToolModeToolMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_UP",this.handleToolModeToolUp),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_START",this.handleToolModeToolDragStart),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_MOVE",this.handleToolModeToolDragMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_END",this.handleToolModeToolDragEnd),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_CANCEL",this.handleToolModeToolDragCancel),e.on("OBR_TOOL_MODE_EVENT_KEY_DOWN",this.handleToolModeKeyDown),e.on("OBR_TOOL_MODE_EVENT_KEY_UP",this.handleToolModeKeyUp),e.on("OBR_TOOL_MODE_EVENT_ACTIVATE",this.handleToolModeActivate),e.on("OBR_TOOL_MODE_EVENT_DEACTIVATE",this.handleToolModeDeactivate)}create(e){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_CREATE",{id:e.id,shortcut:e.shortcut,defaultMode:e.defaultMode,defaultMetadata:e.defaultMetadata,icons:ce(e.icons),disabled:e.disabled}),this.tools[e.id]=e})}remove(e){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_REMOVE",{id:e}),delete this.tools[e]})}activateTool(e){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTIVATE",{id:e})})}getMetadata(e){return q(this,void 0,void 0,function*(){const{metadata:n}=yield this.messageBus.sendAsync("OBR_TOOL_GET_METADATA",{id:e});return n})}setMetadata(e,n){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_SET_METADATA",{toolId:e,update:n})})}createAction(e){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_CREATE",{id:e.id,shortcut:e.shortcut,icons:ce(e.icons),disabled:e.disabled}),this.toolActions[e.id]=e})}removeAction(e){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_REMOVE",{id:e}),delete this.tools[e]})}createMode(e){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_CREATE",{id:e.id,shortcut:e.shortcut,icons:ce(e.icons),preventDrag:e.preventDrag,disabled:e.disabled,cursors:e.cursors}),this.toolModes[e.id]=e})}removeMode(e){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_REMOVE",{id:e}),delete this.tools[e]})}activateMode(e,n){return q(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_ACTIVATE",{toolId:e,modeId:n})})}}var oe=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class xn{constructor(e){this.messageBus=e}open(e){return oe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_OPEN",Object.assign({},kt(e)))})}close(e){return oe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_CLOSE",{id:e})})}getWidth(e){return oe(this,void 0,void 0,function*(){const{width:n}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_WIDTH",{id:e});return n})}setWidth(e,n){return oe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_WIDTH",{id:e,width:n})})}getHeight(e){return oe(this,void 0,void 0,function*(){const{height:n}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_HEIGHT",{id:e});return n})}setHeight(e,n){return oe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_HEIGHT",{id:e,height:n})})}}var Ot=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class Dn{constructor(e){this.messageBus=e}open(e){return Ot(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_OPEN",Object.assign({},kt(e)))})}close(e){return Ot(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_CLOSE",{id:e})})}}var H=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class kn{constructor(e){this.messageBus=e}getWidth(){return H(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_WIDTH",{});return e})}setWidth(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_WIDTH",{width:e})})}getHeight(){return H(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_HEIGHT",{});return e})}setHeight(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_HEIGHT",{height:e})})}getBadgeText(){return H(this,void 0,void 0,function*(){const{badgeText:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_TEXT",{});return e})}setBadgeText(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_TEXT",{badgeText:e})})}getBadgeBackgroundColor(){return H(this,void 0,void 0,function*(){const{badgeBackgroundColor:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_BACKGROUND_COLOR",{});return e})}setBadgeBackgroundColor(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_BACKGROUND_COLOR",{badgeBackgroundColor:e})})}getIcon(){return H(this,void 0,void 0,function*(){const{icon:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_ICON",{});return e})}setIcon(e){return H(this,void 0,void 0,function*(){const n=ce([{icon:e}]);yield this.messageBus.sendAsync("OBR_ACTION_SET_ICON",{icon:n[0].icon})})}getTitle(){return H(this,void 0,void 0,function*(){const{title:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_TITLE",{});return e})}setTitle(e){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_TITLE",{title:e})})}isOpen(){return H(this,void 0,void 0,function*(){const{isOpen:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_IS_OPEN",{});return e})}open(){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_OPEN",{})})}close(){return H(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_CLOSE",{})})}onOpenChange(e){const n=s=>{e(s.isOpen)};return this.messageBus.send("OBR_ACTION_IS_OPEN_SUBSCRIBE",{}),this.messageBus.on("OBR_ACTION_IS_OPEN_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_IS_OPEN_ACTION_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ACTION_IS_OPEN_EVENT_CHANGE",n)}}}var Hn=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};Qe();class Gn{constructor(e){this.messageBus=e}startItemInteraction(e){return Hn(this,void 0,void 0,function*(){const{id:n}=yield this.messageBus.sendAsync("OBR_INTERACTION_START_ITEM_INTERACTION",{baseState:e});let s=e;return[a=>{const[h,u]=st(s,a);return s=h,this.messageBus.send("OBR_INTERACTION_UPDATE_ITEM_INTERACTION",{id:n,patches:u}),h},()=>{this.messageBus.send("OBR_INTERACTION_STOP_ITEM_INTERACTION",{id:n})}]})}}var Un=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class Vn{constructor(e){this.messageBus=e}getPlayers(){return Un(this,void 0,void 0,function*(){const{players:e}=yield this.messageBus.sendAsync("OBR_PARTY_GET_PLAYERS",{});return e})}onChange(e){const n=s=>{e(s.players)};return this.messageBus.send("OBR_PARTY_SUBSCRIBE",{}),this.messageBus.on("OBR_PARTY_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PARTY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PARTY_EVENT_CHANGE",n)}}}var $e=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class Fn{constructor(e){this.messageBus=e}get id(){return this.messageBus.roomId}getPermissions(){return $e(this,void 0,void 0,function*(){const{permissions:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return e})}getMetadata(){return $e(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_METADATA",{});return e})}setMetadata(e){return $e(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ROOM_SET_METADATA",{update:e})})}onMetadataChange(e){const n=s=>{e(s.metadata)};return this.messageBus.send("OBR_ROOM_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_METADATA_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_METADATA_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_METADATA_EVENT_CHANGE",n)}}onPermissionsChange(e){const n=s=>{e(s.permissions)};return this.messageBus.send("OBR_ROOM_PERMISSIONS_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PERMISSIONS_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",n)}}}var qn=function(t,e,n,s){function o(i){return i instanceof n?i:new n(function(a){a(i)})}return new(n||(n=Promise))(function(i,a){function h(r){try{c(s.next(r))}catch(f){a(f)}}function u(r){try{c(s.throw(r))}catch(f){a(f)}}function c(r){r.done?i(r.value):o(r.value).then(h,u)}c((s=s.apply(t,e||[])).next())})};class jn{constructor(e){this.messageBus=e}getTheme(){return qn(this,void 0,void 0,function*(){const{theme:e}=yield this.messageBus.sendAsync("OBR_THEME_GET_THEME",{});return e})}onChange(e){const n=s=>{e(s.theme)};return this.messageBus.send("OBR_THEME_SUBSCRIBE",{}),this.messageBus.on("OBR_THEME_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_THEME_UNSUBSCRIBE",{}),this.messageBus.off("OBR_THEME_EVENT_CHANGE",n)}}}const ot=typeof Buffer=="function",Tt=typeof TextDecoder=="function"?new TextDecoder:void 0;typeof TextEncoder=="function"&&new TextEncoder;const Wn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Yn=Array.prototype.slice.call(Wn),ge=(t=>{let e={};return t.forEach((n,s)=>e[n]=s),e})(Yn),Kn=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,Z=String.fromCharCode.bind(String),bt=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),Ht=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),zn=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Jn=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),n=e-65536;return Z((n>>>10)+55296)+Z((n&1023)+56320);case 3:return Z((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return Z((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},Xn=t=>t.replace(zn,Jn),Zn=t=>{if(t=t.replace(/\s+/g,""),!Kn.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,n,s,o=[];for(let i=0;i<t.length;)e=ge[t.charAt(i++)]<<18|ge[t.charAt(i++)]<<12|(n=ge[t.charAt(i++)])<<6|(s=ge[t.charAt(i++)]),n===64?o.push(Z(e>>16&255)):s===64?o.push(Z(e>>16&255,e>>8&255)):o.push(Z(e>>16&255,e>>8&255,e&255));return o.join("")},Gt=typeof atob=="function"?t=>atob(Ht(t)):ot?t=>Buffer.from(t,"base64").toString("binary"):Zn,Qn=ot?t=>bt(Buffer.from(t,"base64")):t=>bt(Gt(t).split("").map(e=>e.charCodeAt(0))),es=ot?t=>Buffer.from(t,"base64").toString("utf8"):Tt?t=>Tt.decode(Qn(t)):t=>Xn(Gt(t)),ts=t=>Ht(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),ns=t=>es(ts(t));function ss(){const e=new URLSearchParams(window.location.search).get("obrref");let n="",s="";if(e){const i=ns(e).split(" ");i.length===2&&(n=i[0],s=i[1])}return{origin:n,roomId:s}}var At;(function(t){t[t.MOVE=0]="MOVE",t[t.LINE=1]="LINE",t[t.QUAD=2]="QUAD",t[t.CONIC=3]="CONIC",t[t.CUBIC=4]="CUBIC",t[t.CLOSE=5]="CLOSE"})(At||(At={}));const Ve=ss(),x=new yn(Ve.origin,Ve.roomId),os=new tn(x),is=new en(x),as=new Vn(x),rs=new vn(x),ls=new Ln(x),cs=new $n(x),ds=new Pn(x),us=new xn(x),fs=new Dn(x),hs=new kn(x),ps=new Gn(x),ms=new Fn(x),ys=new jn(x),C={onReady:t=>{x.ready?t():x.once("OBR_READY",()=>t())},get isReady(){return x.ready},viewport:os,player:is,party:as,notification:rs,scene:ls,contextMenu:cs,tool:ds,popover:us,modal:fs,action:hs,interaction:ps,room:ms,theme:ys,isAvailable:!!Ve.origin},Fe={en:{appTitle:"Foxyverse TTRPG",appSubtitle:"Homebrew system",selectSheet:"Select character sheet",newSheet:"New sheet",noSheet:"No sheet selected",settings:"Settings",permissions:"Permissions",view:"View",edit:"Edit",linkToken:"Link to token",gmOnly:"GM only",tabBio:"Bio",tabStats:"Stats",tabSpells:"Spells",tabInventory:"Inventory",tabChat:"Chat",tabNotes:"Notes",tabSettings:"Settings",name:"Name",surname:"Surname",element:"Element",class:"Class",level:"Level",tempHP:"Temp HP",currentHP:"Current HP",maxHP:"Max HP",currentMP:"Current MP",maxMP:"Max MP",currentFavor:"Current Favor",maxFavor:"Max Favor",action:"Action",actionModifier:"Action modifier",speed:"Speed",speedModifier:"Speed modifier",baseStat:"Base",xpBonus:"XP Bonus",itemBonus:"Item",passiveBonus:"Passive",total:"Total",roll:"Roll",modifier:"Modifier",quickMods:"Quick modifiers",knowledge:"Knowledge",addKnowledge:"Add knowledge",tier:"Tier",tier1:"Tier 1 (+1)",tier2:"Tier 2 (+3)",tier3:"Tier 3 (+5)",tier4:"Tier 4 (+10)",constitution:"Constitution",strength:"Strength",intelligence:"Intelligence",perception:"Perception",social:"Social",agility:"Agility",focus:"Focus",statRoll:"Stat roll",nat1:"Nat 1",nat20:"Nat 20",success:"Success",failure:"Failure",dc:"DC",result:"Result",reroll:"Reroll",rerollCost:"Uses 1 Favor",rollSpeed:"Roll Speed",linkTokenToSheet:"Link selected token",linkedTokens:"Linked tokens",unlink:"Unlink",noTokenSelected:"Select a token on the map first",physicalDamage:"Physical damage",magicDamage:"Magic damage",trueDamage:"True damage",heal:"Heal",overHeal:"Over heal (Temp HP)",otherRoll:"Other roll",applyDamage:"Apply damage",applyHeal:"Apply heal",applyOverHeal:"Apply temp HP",spellName:"Spell name",spellEffect:"Effect",spellCost:"Cost",costHP:"HP",costMP:"MP",deductCost:"Deduct cost",notEnoughMP:"Not enough MP  use HP?",confirmUseHP:"Using HP for MP will drain life. Continue?",equipped:"Equipped",consumables:"Consumables",others:"Others",weapons:"Weapons",armor:"Armor",bags:"Bags",itemName:"Item name",itemType:"Type",itemDescription:"Description",numberOwned:"Qty",weaponSlots:"Weapon slots",defense:"Defense",magicalDefense:"Magical Defense",equippableSlots:"Equippable slots",slotWeapon1:"Weapon 1",slotWeapon2:"Weapon 2",slotWeapon3:"Weapon 3",slotHat:"Hat",slotFace:"Face",slotNecklace:"Necklace",slotPendant1:"Pendant 1",slotPendant2:"Pendant 2",slotPendant3:"Pendant 3",slotTorso:"Torso",slotRightShoulder:"Right shoulder",slotLeftShoulder:"Left shoulder",slotLeftArm:"Left arm",slotRightArm:"Right arm",slotLeftWrist:"Left wrist",slotRightWrist:"Right wrist",slotBelt:"Belt",slotLeftLeg:"Left leg",slotRightLeg:"Right leg",slotLeftAnkle:"Left ankle",slotRightAnkle:"Right ankle",slotLeftFoot:"Left foot",slotRightFoot:"Right foot",slotOther:"Other",fingers:"Fingers",slotLeftThumb:"L. thumb",slotLeftIndex:"L. index",slotLeftMiddle:"L. middle",slotLeftRing:"L. ring",slotLeftPinky:"L. pinky",slotRightThumb:"R. thumb",slotRightIndex:"R. index",slotRightMiddle:"R. middle",slotRightRing:"R. ring",slotRightPinky:"R. pinky",leftThumb:"L. thumb",leftIndex:"L. index",leftMiddle:"L. middle",leftRing:"L. ring",leftPinky:"L. pinky",rightThumb:"R. thumb",rightIndex:"R. index",rightMiddle:"R. middle",rightRing:"R. ring",rightPinky:"R. pinky",chatPlaceholder:"Message or /str +5, /pdmg 2d6...",send:"Send",notesPlaceholder:"Notes...",uiColors:"UI colors",color1:"Background",color2:"Surface",color3:"Border",color4:"Text",color5:"Accent",exportSheet:"Export sheet",importSheet:"Import sheet",importFile:"Import from file",add:"Add",remove:"Remove",save:"Save",cancel:"Cancel",close:"Close",confirm:"Confirm",ok:"OK"},fr:{appTitle:"Foxyverse TTRPG",appSubtitle:"Systme homebrew",selectSheet:"Choisir la fiche",newSheet:"Nouvelle fiche",noSheet:"Aucune fiche",settings:"Paramtres",permissions:"Permissions",view:"Voir",edit:"Modifier",linkToken:"Lier au token",gmOnly:"MJ uniquement",tabBio:"Bio",tabStats:"Stats",tabSpells:"Sorts",tabInventory:"Inventaire",tabChat:"Chat",tabNotes:"Notes",tabSettings:"Paramtres",name:"Prnom",surname:"Nom",element:"lment",class:"Classe",level:"Niveau",tempHP:"PV temp",currentHP:"PV actuels",maxHP:"PV max",currentMP:"PM actuels",maxMP:"PM max",currentFavor:"Faveur actuelle",maxFavor:"Faveur max",action:"Action",actionModifier:"Mod. action",speed:"Vitesse",speedModifier:"Mod. vitesse",baseStat:"Base",xpBonus:"Bonus XP",itemBonus:"Objet",passiveBonus:"Passif",total:"Total",roll:"Lancer",modifier:"Modificateur",quickMods:"Mod. rapides",knowledge:"Connaissances",addKnowledge:"Ajouter connaissance",tier:"Niveau",tier1:"Niveau 1 (+1)",tier2:"Niveau 2 (+3)",tier3:"Niveau 3 (+5)",tier4:"Niveau 4 (+10)",constitution:"Constitution",strength:"Force",intelligence:"Intelligence",perception:"Perception",social:"Social",agility:"Agilit",focus:"Focus",statRoll:"Jet de stat",nat1:"Crit 1",nat20:"Crit 20",success:"Russi",failure:"chec",dc:"DD",result:"Rsultat",reroll:"Relancer",rerollCost:"Cote 1 Faveur",rollSpeed:"Lancer Vitesse",linkTokenToSheet:"Lier le token slectionn",linkedTokens:"Tokens lis",unlink:"Dlier",noTokenSelected:"Slectionnez un token sur la carte d'abord",physicalDamage:"Dgts physiques",magicDamage:"Dgts magiques",trueDamage:"Dgts bruts",heal:"Soin",overHeal:"Sur-soin (PV temp)",otherRoll:"Autre jet",applyDamage:"Appliquer dgts",applyHeal:"Appliquer soin",applyOverHeal:"Appliquer PV temp",spellName:"Nom du sort",spellEffect:"Effet",spellCost:"Cot",costHP:"PV",costMP:"PM",deductCost:"Dduire cot",notEnoughMP:"Pas assez de PM  utiliser les PV ?",confirmUseHP:"Utiliser les PV  la place des PM va vous blesser. Continuer ?",equipped:"quip",consumables:"Consommables",others:"Autres",weapons:"Armes",armor:"Armure",bags:"Sacs",itemName:"Nom",itemType:"Type",itemDescription:"Description",numberOwned:"Qt",weaponSlots:"Emplacements arme",defense:"Dfense",magicalDefense:"Dfense magique",equippableSlots:"Emplacements quipables",slotWeapon1:"Arme 1",slotWeapon2:"Arme 2",slotWeapon3:"Arme 3",slotHat:"Chapeau",slotFace:"Visage",slotNecklace:"Collier",slotPendant1:"Pendentif 1",slotPendant2:"Pendentif 2",slotPendant3:"Pendentif 3",slotTorso:"Torse",slotRightShoulder:"paule droite",slotLeftShoulder:"paule gauche",slotLeftArm:"Bras gauche",slotRightArm:"Bras droit",slotLeftWrist:"Poignet gauche",slotRightWrist:"Poignet droit",slotBelt:"Ceinture",slotLeftLeg:"Jambe gauche",slotRightLeg:"Jambe droite",slotLeftAnkle:"Cheville gauche",slotRightAnkle:"Cheville droite",slotLeftFoot:"Pied gauche",slotRightFoot:"Pied droit",slotOther:"Autre",fingers:"Doigts",slotLeftThumb:"Pouce G",slotLeftIndex:"Index G",slotLeftMiddle:"Majeur G",slotLeftRing:"Annulaire G",slotLeftPinky:"Auriculaire G",slotRightThumb:"Pouce D",slotRightIndex:"Index D",slotRightMiddle:"Majeur D",slotRightRing:"Annulaire D",slotRightPinky:"Auriculaire D",leftThumb:"Pouce G",leftIndex:"Index G",leftMiddle:"Majeur G",leftRing:"Annulaire G",leftPinky:"Auriculaire G",rightThumb:"Pouce D",rightIndex:"Index D",rightMiddle:"Majeur D",rightRing:"Annulaire D",rightPinky:"Auriculaire D",chatPlaceholder:"Message ou /str +5, /pdmg 2d6...",send:"Envoyer",notesPlaceholder:"Notes...",uiColors:"Couleurs de l'interface",color1:"Fond",color2:"Surface",color3:"Bordure",color4:"Texte",color5:"Accent",exportSheet:"Exporter la fiche",importSheet:"Importer la fiche",importFile:"Importer un fichier",add:"Ajouter",remove:"Retirer",save:"Enregistrer",cancel:"Annuler",close:"Fermer",confirm:"Confirmer",ok:"OK"}};let qe="en";function Ut(t){return Fe[t]&&(qe=t),qe}function p(t){var e;return((e=Fe[qe])==null?void 0:e[t])??Fe.en[t]??t}const Vt=["constitution","strength","intelligence","perception","social","agility","focus"],vs=["Weapon1","Weapon2","Weapon3","Hat","Face","Necklace","Pendant1","Pendant2","Pendant3","Torso","RightShoulder","LeftShoulder","LeftArm","RightArm","LeftWrist","RightWrist","LeftThumb","LeftIndex","LeftMiddle","LeftRing","LeftPinky","RightThumb","RightIndex","RightMiddle","RightRing","RightPinky","Belt","LeftLeg","RightLeg","LeftAnkle","RightAnkle","LeftFoot","RightFoot","Other"];function gs(){return{base:0,xpBonus:0,itemBonus:0,passiveBonus:0}}function _s(){const t={};return Vt.forEach(e=>{t[e]=gs()}),t}function Ft(t=crypto.randomUUID()){return{id:t,bio:{name:"",surname:"",element:"",class:"",level:1},stats:_s(),knowledge:[],tempHP:0,currentHP:0,currentMP:0,currentFavor:0,actionFormula:"",actionModifier:"",speedModifier:"",spells:[],equipped:{},consumables:[],others:[],weapons:[],armor:[],bags:[],notes:"",createdAt:Date.now(),updatedAt:Date.now()}}function qt(t){const e=K(t,"constitution");return Math.max(0,e*2)}function Es(t){const e=K(t,"intelligence"),n=K(t,"focus");return Math.round((e+n)*.75)}function Os(t){var n;const e=Number((n=t.bio)==null?void 0:n.level)||1;return Math.ceil((e+1)/3)}function jt(t){const e=(t||"").trim();if(!e)return 0;const n=e.match(/^([+\-])\s*(\d+)$/);return n?n[1]==="-"?-parseInt(n[2],10):parseInt(n[2],10):0}function Ts(t){var o;const e=K(t,"agility"),n=Number((o=t.bio)==null?void 0:o.level)||1;return Math.floor(e/10)+Math.floor(n/5)+jt(t.actionModifier)}function bs(t){const e=K(t,"agility"),n=(t.speedModifier||"").trim();return n?`(${e}/4 + 1d6) ${n}`:`${e}/4 + 1d6`}function As(t){return jt(t)}function K(t,e){var h;const n=(h=t.stats)==null?void 0:h[e];if(!n)return 0;const s=Number(n.base)||0,o=Number(n.xpBonus)||0,i=Number(n.itemBonus)||0,a=Number(n.passiveBonus)||0;return s+o+i+a}function Te(t){var s,o;const e=((s=t.bio)==null?void 0:s.name)??"",n=((o=t.bio)==null?void 0:o.surname)??"";return e&&n?`${e} ${n}`:e||n||"Unnamed"}function it(t,e){const n=[t.weapons,t.armor,t.consumables,t.others,t.bags].filter(Boolean);for(const s of n){const o=s.find(i=>i.id===e);if(o)return o}return null}function Ss(t){let e=0;const n=t.equipped||{},s=new Set;for(const o of Object.values(n)){if(s.has(o))continue;s.add(o);const i=it(t,o);i&&i.defense!=null&&(e+=Number(i.defense)||0)}return e}function Rs(t){let e=0;const n=t.equipped||{},s=new Set;for(const o of Object.values(n)){if(s.has(o))continue;s.add(o);const i=it(t,o);i&&i.magicalDefense!=null&&(e+=Number(i.magicalDefense)||0)}return e}const je="foxyverse",Bs="foxyverse_sheet_",Pe=14e3;async function Q(){return(await C.room.getMetadata())[je]||{}}async function pe(t){const e=await C.room.getMetadata();await C.room.setMetadata({...e,[je]:{...e[je]||{},...t}})}async function We(){return(await Q()).sheetIds||[]}async function Ye(t,e){const n=await Q(),s=n.sheetIds||[];s.includes(t)||await pe({sheetIds:[...s,t],sheetNames:{...n.sheetNames||{},[t]:e||"Unnamed"}})}async function Is(t){await pe({permissions:t})}async function St(t,e){const s={...(await Q()).tokenToSheet||{}};e?s[t]=e:delete s[t],await pe({tokenToSheet:s})}async function Wt(){return C.room.id}function Yt(t,e){return`${Bs}${t}_${e}`}function ws(t,e){try{const n=localStorage.getItem(Yt(t,e));return n?JSON.parse(n):null}catch{return null}}function he(t,e){const n=Yt(t,e.id);e.updatedAt=Date.now(),localStorage.setItem(n,JSON.stringify(e))}const Ke="foxyverse",Rt={SHEET_FULL:"sheet_full",SHEET_PART:"sheet_part"};async function Cs(t,e){const n=JSON.stringify(e);if(n.length<=Pe){await C.broadcast.sendMessage(Ke,{type:Rt.SHEET_FULL,roomId:t,sheet:e});return}const s=[];for(let o=0;o<n.length;o+=Pe)s.push(n.slice(o,o+Pe));for(let o=0;o<s.length;o++)await C.broadcast.sendMessage(Ke,{type:Rt.SHEET_PART,roomId:t,sheetId:e.id,partIndex:o,totalParts:s.length,data:s[o]})}function Ns(t){return C.broadcast.onMessage(Ke,t)}async function Ms(){return C.player.id}async function Ls(){return C.player.getRole()}async function $s(){return C.player.getName()}const Ps={str:"strength",con:"constitution",int:"intelligence",per:"perception",soc:"social",agi:"agility",foc:"focus"};function xs(t){const e=(t||"").replace(/\s/g,""),n=[];let s=0;for(;s<e.length;){if(/[0-9]/.test(e[s])){let o="";for(;s<e.length&&/[0-9]/.test(e[s]);)o+=e[s++];n.push({type:"num",value:parseInt(o,10)});continue}if(e[s]==="d"&&s+1<e.length){s++;const i=e.slice(s).match(/^(str|con|int|per|soc|agi|foc)/i);if(i){const h=i[1].toLowerCase();s+=h.length,n.push({type:"diceStat",stat:h});continue}let a="";for(;s<e.length&&/[0-9]/.test(e[s]);)a+=e[s++];n.push({type:"dice",faces:a?parseInt(a,10):20});continue}if(/[a-zA-Z]/.test(e[s])){const i=e.slice(s).match(/^(str|con|int|per|soc|agi|foc)/i);if(i){const a=i[1].toLowerCase();s+=a.length,n.push({type:"stat",value:a});continue}s++;continue}if(e[s]==="("){n.push({type:"("}),s++;continue}if(e[s]===")"){n.push({type:")"}),s++;continue}if(e[s]==="+"){n.push({type:"+"}),s++;continue}if(e[s]==="-"){n.push({type:"-"}),s++;continue}if(e[s]==="*"){n.push({type:"*"}),s++;continue}if(e[s]==="/"){n.push({type:"/"}),s++;continue}s++}return n}function xe(t,e){const n=Ps[t];return e[n]!=null?Number(e[n]):0}function Ds(t,e,n){const s=(h,u)=>{let c=0;const r=[];for(let f=0;f<h;f++){const _=n?n(u):Math.floor(Math.random()*u)+1;r.push(_),c+=_}return{sum:c,rolls:r}};function o(h){var c;if(h>=t.length)return{value:0,next:h,rolls:[]};const u=t[h];if(u.type==="num"){const r=t[h+1];if((r==null?void 0:r.type)==="dice"){const{sum:f,rolls:_}=s(u.value,r.faces);return{value:f,next:h+2,rolls:_}}if((r==null?void 0:r.type)==="diceStat"){const f=Math.max(1,xe(r.stat,e)),{sum:_,rolls:E}=s(u.value,f);return{value:_,next:h+2,rolls:E}}return{value:u.value,next:h+1,rolls:[]}}if(u.type==="stat")return{value:xe(u.value,e),next:h+1,rolls:[]};if(u.type==="dice"){const{sum:r,rolls:f}=s(1,u.faces);return{value:r,next:h+1,rolls:f}}if(u.type==="diceStat"){const r=Math.max(1,xe(u.stat,e)),{sum:f,rolls:_}=s(1,r);return{value:f,next:h+1,rolls:_}}if(u.type==="("){const r=i(h+1),f=((c=t[r.next])==null?void 0:c.type)===")"?r.next+1:r.next;return{value:r.value,next:f,rolls:r.rolls||[]}}return{value:0,next:h+1,rolls:[]}}function i(h){let u=h,c=o(u);u=c.next;const r=c.rolls||[];for(;u<t.length;){const f=t[u];if(f.type===")"||!["+","-","*","/"].includes(f.type))break;u++;const _=o(u);u=_.next,_.rolls&&r.push(..._.rolls);const E=c.value,T=_.value;f.type==="+"?c={value:E+T,next:u}:f.type==="-"?c={value:E-T,next:u}:f.type==="*"?c={value:E*T,next:u}:f.type==="/"&&(c={value:T===0?0:Math.floor(E/T),next:u})}return{value:c.value,next:u,rolls:r}}const a=i(0);return{value:Math.max(0,Math.floor(a.value)),rolls:a.rolls||[]}}function ks(t,e){const n={};return["constitution","strength","intelligence","perception","social","agility","focus"].forEach(o=>{n[o]=e(t,o)}),n}function Hs(t,e={},n=null){const s=xs(t);return Ds(s,e,n)}function Gs(t){const e=(t||"").trim();if(!e)return 0;const n=e.match(/^([+\-*/])\s*(\d+)$/);if(!n)return 0;const s=n[1],o=parseInt(n[2],10);return s==="+"?o:s==="-"?-o:0}function Kt(t,e,n=null){const s=n?n(20):Math.floor(Math.random()*20)+1,o=Gs(e),i=s+o,a=s===20?!0:s===1?!1:i<=t;return{roll:s,mod:o,total:i,dc:t,success:a,nat1:s===1,nat20:s===20}}const at={str:"strength",int:"intelligence",con:"constitution",per:"perception",soc:"social",agi:"agility",foc:"focus"};function Us(t){const e=/\[([^\]:]+):([^\]]*)\]/gi,n=[];let s;for(;(s=e.exec(t))!==null;){const o=(s[1]||"").trim().toLowerCase(),i=(s[2]||"").trim();at[o]||o==="statroll"?n.push({type:"stat",stat:o==="statroll"?null:o,expr:i,raw:s[0]}):o==="pdmg"?n.push({type:"pdmg",expr:i,raw:s[0]}):o==="mdmg"?n.push({type:"mdmg",expr:i,raw:s[0]}):o==="tdmg"||o==="tdmg"?n.push({type:"tdmg",expr:i,raw:s[0]}):o==="heal"?n.push({type:"heal",expr:i,raw:s[0]}):o==="theal"||o==="theal"?n.push({type:"theal",expr:i,raw:s[0]}):o==="roll"&&n.push({type:"roll",expr:i,raw:s[0]})}return n}function Vs(t){const e=(t||"").trim();if(!e.startsWith("/"))return null;const n=e.slice(1).trim(),s=n.indexOf(" "),o=s>=0?n.slice(0,s).toLowerCase():n,i=s>=0?n.slice(s+1).trim():"";return at[o]?{type:"stat",stat:o,expr:i||""}:["pdmg","mdmg","tdmg","heal","theal","roll"].includes(o)?{type:o,expr:i}:null}function Fs(t){return Us(t||"")}function _e(t,e,n){const s=ks(e,K),{type:o,stat:i,expr:a}=t;if(o==="stat"){const r=i?at[i]:null,f=r?K(e,r):0,_=Kt(f,a);return{kind:"stat",stat:r,dc:_.dc,roll:_.roll,mod:_.mod,total:_.total,success:_.success,nat1:_.nat1,nat20:_.nat20,result:_}}const h=Hs(a,s),u=h.value,c=h.rolls||[];return o==="pdmg"?{kind:"pdmg",value:u,rolls:c,canApply:!0}:o==="mdmg"?{kind:"mdmg",value:u,rolls:c,canApply:!0}:o==="tdmg"?{kind:"tdmg",value:u,rolls:c,canApply:!0}:o==="heal"?{kind:"heal",value:u,rolls:c,canApply:!0}:o==="theal"?{kind:"theal",value:u,rolls:c,canApply:!0}:o==="roll"?{kind:"roll",value:u,rolls:c,canApply:!1}:null}function qs(t,e){const n=Ys(t),s=Math.max(0,(e||0)-n);return rt(t,s)}function js(t,e){const n=Ks(t),s=Math.max(0,(e||0)-n);return rt(t,s)}function Ws(t,e){return rt(t,e||0)}function Ys(t){return Ss(t)}function Ks(t){return Rs(t)}function rt(t,e){let n=Math.max(0,Number(t.tempHP)||0),s=Math.max(0,Number(t.currentHP)||0),o=e;if(o>0&&n>0){const i=Math.min(n,o);n-=i,o-=i}return o>0&&(s=Math.max(0,s-o)),{tempHP:n,currentHP:s}}function zs(t,e,n){const s=Math.max(0,Number(t.currentHP)||0),o=Math.max(0,Number(n)||0);return{currentHP:Math.min(o,s+(e||0))}}function Js(t,e){return{tempHP:Math.max(0,Number(t.tempHP)||0)+(e||0)}}function Xs(t){return t&&["stat","pdmg","mdmg","tdmg","heal","theal","roll"].includes(t.kind)}const zt="app",Zs=["bio","stats","spells","inventory","chat","notes","settings"],l={locale:"en",roomId:null,sheetIds:[],sheetNames:{},permissions:{},tokenToSheet:{},activeSheetId:null,sheet:null,isGM:!1,playerId:null,activeTab:"bio",chatMessages:[],chatHistoryKey:"foxyverse_chat_",lastRoll:null,lastRollPayload:null,colors:{bg:"#1a1b1e",surface:"#25262b",border:"#373a40",text:"#e8e9ed",accent:"#7950f2"}};function Qs(t){if(l.isGM)return!0;const e=l.permissions[l.playerId];return!e||!e.view||e.view.length===0?!0:e.view.includes(t)}function j(t){if(l.isGM)return!0;const e=l.permissions[l.playerId];return!e||!e.edit||e.edit.length===0?!0:e.edit.includes(t)}function Jt(){return l.sheetIds.filter(Qs)}async function Bt(){l.roomId=await Wt(),l.sheetIds=await We();const t=await Q();l.sheetNames=t.sheetNames||{},l.permissions=t.permissions||{},l.tokenToSheet=t.tokenToSheet||{},l.isGM=await Ls()==="GM",l.playerId=await Ms();const e=t.locale||localStorage.getItem("foxyverse_locale")||"en";l.locale=e,Ut(e),await pe({locale:l.locale})}async function de(t){if(!t||!l.roomId){l.sheet=null,l.activeSheetId=t;return}let e=ws(l.roomId,t);e||(e=Ft(t),he(l.roomId,e),await Ye(t,Te(e))),l.sheet=e,l.activeSheetId=t}function S(){!l.sheet||!l.roomId||(he(l.roomId,l.sheet),Cs(l.roomId,l.sheet).catch(()=>{}))}function eo(){const t=Jt(),e=t.map(o=>`<option value="${o}" ${o===l.activeSheetId?"selected":""}>${l.sheetNames[o]||o.slice(0,8)}</option>`).join(""),n=l.isGM||t.length===0,s=l.activeSheetId?Object.entries(l.tokenToSheet||{}).filter(([,o])=>o===l.activeSheetId):[];return`
    <header class="app-header">
      <div class="header-row">
        <select id="sheet-select" class="sheet-select" aria-label="${p("selectSheet")}">
          <option value="">${p("noSheet")}</option>
          ${e}
        </select>
        ${n?`<button type="button" id="btn-new-sheet" class="btn-icon" title="${p("newSheet")}">+</button>`:""}
        ${l.activeSheetId?`<button type="button" id="btn-link-token" class="btn-sm" title="${p("linkTokenToSheet")}">${p("linkToken")}</button>`:""}
        <div class="lang-flags">
          <button type="button" class="flag ${l.locale==="en"?"active":""}" data-lang="en" title="English" aria-label="English">EN</button>
          <button type="button" class="flag ${l.locale==="fr"?"active":""}" data-lang="fr" title="Franais" aria-label="Franais">FR</button>
        </div>
      </div>
      ${s.length>0?`
        <div class="linked-tokens">
          <span class="label">${p("linkedTokens")}:</span>
          ${s.map(([o])=>`<span class="linked-token-id">${o.slice(0,8)}</span> <button type="button" class="btn-sm btn-unlink" data-token-id="${o}">${p("unlink")}</button>`).join(" ")}
        </div>
      `:""}
    </header>
  `}function to(){return`<nav class="tabs">${Zs.map(e=>`<button type="button" class="tab ${l.activeTab===e?"active":""}" data-tab="${e}">${p("tab"+e.charAt(0).toUpperCase()+e.slice(1))}</button>`).join("")}</nav>`}function It(){const t=l.sheet;if(!t)return`<div class="card"><p>${p("noSheet")}</p></div>`;const e=t.bio||{};return`
    <div class="card">
      <h2>${p("tabBio")}</h2>
      <div class="form-group">
        <label class="label">${p("name")}</label>
        <input type="text" id="bio-name" value="${w(e.name)}" data-field="bio.name" ${j(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${p("surname")}</label>
        <input type="text" id="bio-surname" value="${w(e.surname)}" data-field="bio.surname" ${j(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${p("element")}</label>
        <input type="text" id="bio-element" value="${w(e.element)}" data-field="bio.element" ${j(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${p("class")}</label>
        <input type="text" id="bio-class" value="${w(e.class)}" data-field="bio.class" ${j(t.id)?"":"readonly"} />
      </div>
      <div class="form-group">
        <label class="label">${p("level")}</label>
        <input type="number" min="1" id="bio-level" value="${Number(e.level)||1}" data-field="bio.level" ${j(t.id)?"":"readonly"} />
      </div>
    </div>
  `}function w(t){return t==null?"":String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}function no(){const t=l.sheet;if(!t)return`<div class="card"><p>${p("noSheet")}</p></div>`;const e=qt(t),n=Es(t),s=Os(t),o=Ts(t),i=bs(t),a=j(t.id);let h=`
    <div class="stat-row">
      <span class="label">${p("tempHP")}</span>
      <input type="number" min="0" value="${t.tempHP??0}" data-field="tempHP" ${a?"":"readonly"} />
    </div>
    <div class="stat-row">
      <span class="label">${p("currentHP")}</span>
      <input type="number" min="0" max="${e}" value="${t.currentHP??0}" data-field="currentHP" ${a?"":"readonly"} />
      <span class="muted">/ ${e}</span>
    </div>
    <div class="stat-row">
      <span class="label">${p("currentMP")}</span>
      <input type="number" min="0" max="${n}" value="${t.currentMP??0}" data-field="currentMP" ${a?"":"readonly"} />
      <span class="muted">/ ${n}</span>
    </div>
    <div class="stat-row">
      <span class="label">${p("currentFavor")}</span>
      <input type="number" min="0" max="${s}" value="${t.currentFavor??0}" data-field="currentFavor" ${a?"":"readonly"} />
      <span class="muted">/ ${s}</span>
    </div>
    <div class="stat-row">
      <span class="label">${p("action")}</span>
      <span>${o}</span>
      ${a?`<input type="text" placeholder="${p("actionModifier")}" value="${w(t.actionModifier)}" data-field="actionModifier" class="short-input" />`:""}
    </div>
    <div class="stat-row">
      <span class="label">${p("speed")}</span>
      <span class="formula">${i}</span>
      ${a?`<input type="text" placeholder="${p("speedModifier")}" value="${w(t.speedModifier)}" data-field="speedModifier" class="short-input" />`:""}
      <button type="button" id="btn-roll-speed" class="btn-sm">${p("rollSpeed")}</button>
    </div>
  `;const u=(t.knowledge||[]).map((r,f)=>`
    <div class="knowledge-item" data-idx="${f}">
      <input type="text" value="${w(r.name)}" data-knowledge-name="${f}" ${a?"":"readonly"} />
      <select data-knowledge-tier="${f}" ${a?"":"disabled"}>
        ${[1,2,3,4].map(_=>`<option value="${_}" ${r.tier===_?"selected":""}>${p("tier"+_)}</option>`).join("")}
      </select>
      <label><input type="checkbox" data-knowledge-enabled="${f}" ${r.enabled?"checked":""} ${a?"":"disabled"} /> On</label>
      ${a?`<button type="button" class="btn-sm" data-remove-knowledge="${f}">${p("remove")}</button>`:""}
    </div>
  `).join("");let c="";return Vt.forEach(r=>{const f=t.stats[r]||{},_=K(t,r);r.charAt(0).toUpperCase()+r.slice(1);const E=p(r);c+=`
      <tr>
        <td>${E}</td>
        <td><input type="number" data-stat="${r}.base" value="${f.base??0}" ${a?"":"readonly"} /></td>
        <td><input type="number" data-stat="${r}.xpBonus" value="${f.xpBonus??0}" ${a?"":"readonly"} /></td>
        <td><input type="number" data-stat="${r}.itemBonus" value="${f.itemBonus??0}" readonly /></td>
        <td><input type="number" data-stat="${r}.passiveBonus" value="${f.passiveBonus??0}" ${a?"":"readonly"} /></td>
        <td class="total">${_}</td>
        <td>
          <button type="button" class="btn-roll-stat" data-stat="${r}" data-dc="${_}">${p("roll")}</button>
          <div class="quick-mods" data-stat="${r}">
            <button type="button" data-mod="-10">-10</button>
            <button type="button" data-mod="-5">-5</button>
            <button type="button" data-mod="-3">-3</button>
            <button type="button" data-mod="-1">-1</button>
            <button type="button" data-mod="+1">+1</button>
            <button type="button" data-mod="+3">+3</button>
            <button type="button" data-mod="+5">+5</button>
            <button type="button" data-mod="+10">+10</button>
          </div>
        </td>
      </tr>
    `}),`
    <div class="card">
      <h2>${p("tabStats")}</h2>
      <div class="hp-mp-block">${h}</div>
      <h3>${p("knowledge")}</h3>
      <div class="knowledge-list">${u}</div>
      ${a?`<button type="button" id="btn-add-knowledge" class="btn-sm">${p("addKnowledge")}</button>`:""}
      <table class="stats-table">
        <thead><tr><th></th><th>${p("baseStat")}</th><th>${p("xpBonus")}</th><th>${p("itemBonus")}</th><th>${p("passiveBonus")}</th><th>${p("total")}</th><th>${p("roll")}</th></tr></thead>
        <tbody>${c}</tbody>
      </table>
    </div>
    <div id="roll-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="roll-result-title">${p("result")}</h3>
        <p id="roll-result-text"></p>
        <div id="roll-apply-buttons" class="roll-apply-buttons hidden"></div>
        <button type="button" id="roll-reroll-btn" class="hidden">${p("reroll")} (${p("rerollCost")})</button>
        <button type="button" id="roll-close-btn">${p("close")}</button>
      </div>
    </div>
    <div id="stat-roll-modal" class="modal hidden">
      <div class="modal-content">
        <label>${p("modifier")}</label>
        <input type="text" id="stat-roll-modifier" placeholder="+5 or -3" />
        <button type="button" id="stat-roll-do">${p("roll")}</button>
        <button type="button" id="stat-roll-cancel">${p("cancel")}</button>
      </div>
    </div>
  `}function so(){const t=l.sheet;if(!t)return`<div class="card"><p>${p("noSheet")}</p></div>`;const e=j(t.id),s=(t.spells||[]).map((o,i)=>`
    <div class="spell-item card" data-idx="${i}">
      <input type="text" class="spell-name" value="${w(o.name)}" data-spell-name="${i}" placeholder="${p("spellName")}" ${e?"":"readonly"} />
      <textarea class="spell-effect" data-spell-effect="${i}" placeholder="${p("spellEffect")}" ${e?"":"readonly"} rows="2">${w(o.effect)}</textarea>
      <div class="spell-cost">
        <input type="number" min="0" value="${o.cost??0}" data-spell-cost="${i}" ${e?"":"readonly"} />
        <label><input type="radio" name="costType-${i}" value="mp" ${(o.costType||"mp")==="mp"?"checked":""} ${e?"":"disabled"} /> ${p("costMP")}</label>
        <label><input type="radio" name="costType-${i}" value="hp" ${o.costType==="hp"?"checked":""} ${e?"":"disabled"} /> ${p("costHP")}</label>
        ${e?`<button type="button" class="btn-deduct-cost" data-idx="${i}">${p("deductCost")}</button>`:""}
      </div>
      ${e?`<button type="button" class="btn-sm" data-remove-spell="${i}">${p("remove")}</button>`:""}
    </div>
  `).join("");return`
    <div class="card">
      <h2>${p("tabSpells")}</h2>
      <div class="spell-list">${s}</div>
      ${e?`<button type="button" id="btn-add-spell">${p("add")}</button>`:""}
    </div>
  `}function oo(t){const e="slot"+t;return p(e)||t}function io(t,e){if(["Weapon1","Weapon2","Weapon3"].includes(e))return(t.weapons||[]).map(s=>{var o;return{id:s.id,name:s.name||((o=s.id)==null?void 0:o.slice(0,8))}});if(e==="Other"){const s=[];return(t.weapons||[]).forEach(o=>{var i;return s.push({id:o.id,name:(o.name||((i=o.id)==null?void 0:i.slice(0,8)))+" (W)"})}),(t.armor||[]).forEach(o=>{var i;return s.push({id:o.id,name:(o.name||((i=o.id)==null?void 0:i.slice(0,8)))+" (A)"})}),(t.others||[]).forEach(o=>{var i;return s.push({id:o.id,name:(o.name||((i=o.id)==null?void 0:i.slice(0,8)))+" (O)"})}),s}return(t.armor||[]).filter(s=>{const o=s.equippableSlots||[];return o.length===0||o.includes(e)}).map(s=>{var o;return{id:s.id,name:s.name||((o=s.id)==null?void 0:o.slice(0,8))}})}function ao(){const t=l.sheet;if(!t)return`<div class="card"><p>${p("noSheet")}</p></div>`;const e=j(t.id),n=t.equipped||{},s=vs.map(a=>{const h=n[a],u=io(t,a);return`<div class="equip-row"><span class="equip-slot-label">${oo(a)}</span><select class="equip-select" data-slot="${a}" ${e?"":"disabled"}><option value=""></option>${u.map(c=>`<option value="${c.id}" ${h===c.id?"selected":""}>${w(c.name)}</option>`).join("")}</select></div>`}).join("");let o=`
    <div class="card"><h2>${p("tabInventory")}</h2>
    <h3>${p("equipped")}</h3>
    <div class="equipped-grid">${s}</div>
  `;return[{key:"consumables",label:p("consumables")},{key:"others",label:p("others")},{key:"weapons",label:p("weapons")},{key:"armor",label:p("armor")},{key:"bags",label:p("bags")}].forEach(({key:a,label:h})=>{const u=t[a]||[];o+=`
      <h3>${h}</h3>
      <ul class="item-list" data-section="${a}">
        ${u.map((c,r)=>`
          <li class="item-line" data-section="${a}" data-idx="${r}">
            <input type="text" class="item-name-inp" value="${w(c.name||"")}" data-item-name="${a}-${r}" placeholder="${p("itemName")}" ${e?"":"readonly"} />
            <input type="number" min="0" class="item-count-inp" value="${c.count!=null?c.count:1}" data-item-count="${a}-${r}" ${e?"":"readonly"} />
            <span class="item-toggle" data-toggle-item="${a}-${r}" title="${p("itemDescription")}"></span>
            <div class="item-detail hidden" id="item-detail-${a}-${r}">
              <textarea data-item-desc="${a}-${r}" ${e?"":"readonly"} placeholder="${p("itemDescription")}">${w(c.description)}</textarea>
              ${a==="weapons"?`<label>${p("weaponSlots")}: <input type="number" min="1" data-item-weapon-slots="${a}-${r}" value="${c.weaponSlots??1}" ${e?"":"readonly"} /></label>`:""}
              ${a==="armor"?`<label>${p("defense")}: <input type="number" data-item-defense="${a}-${r}" value="${c.defense??""}" ${e?"":"readonly"} /></label><label>${p("magicalDefense")}: <input type="number" data-item-magdef="${a}-${r}" value="${c.magicalDefense??""}" ${e?"":"readonly"} /></label><label>${p("equippableSlots")}: <input type="text" data-item-equip-slots="${a}-${r}" value="${Array.isArray(c.equippableSlots)?c.equippableSlots.join(", "):c.equippableSlots||""}" placeholder="Hat, Face" ${e?"":"readonly"} /></label>`:""}
              ${c.defense!=null&&a!=="armor"?`<span>${p("defense")}: ${c.defense}</span>`:""}
              ${c.magicalDefense!=null&&a!=="armor"?`<span> ${p("magicalDefense")}: ${c.magicalDefense}</span>`:""}
            </div>
            ${e?`<button type="button" class="btn-sm" data-remove-item="${a}-${r}">${p("remove")}</button>`:""}
          </li>
        `).join("")}
      </ul>
      ${e?`<button type="button" class="btn-add-item" data-section="${a}">${p("add")}</button>`:""}
    `}),o+="</div>",o}function ro(){const e=(l.chatMessages||[]).map(n=>`<div class="chat-msg"><strong>${w(n.from)}:</strong> <span class="chat-body">${Xt(n.body)}</span></div>`).join("");return`
    <div class="card chat-card">
      <h2>${p("tabChat")}</h2>
      <div class="chat-messages" id="chat-messages">${e}</div>
      <div class="chat-input-row">
        <input type="text" id="chat-input" placeholder="${p("chatPlaceholder")}" />
        <button type="button" id="chat-send">${p("send")}</button>
      </div>
    </div>
  `}function Xt(t){if(!t)return"";const e=Fs(t);let n=w(t);return e.forEach(s=>{const o=(s.stat||"").toString();n=n.replace(s.raw,`<button type="button" class="inline-roll-btn" data-type="${s.type}" data-expr="${w(s.expr)}" data-stat="${w(o)}">${w(s.raw)}</button>`)}),n}function lo(){const t=l.sheet,e=(t==null?void 0:t.notes)??"",n=j(l.activeSheetId);return`
    <div class="card">
      <h2>${p("tabNotes")}</h2>
      <textarea id="notes-area" rows="12" placeholder="${p("notesPlaceholder")}" ${n?"":"readonly"}>${w(e)}</textarea>
    </div>
  `}function co(){var s;const t=l.colors,e=j(l.activeSheetId),n=l.isGM&&((s=l.partyPlayers)!=null&&s.length)?`
      <h3>${p("permissions")}</h3>
      <p class="muted small">${p("gmOnly")}</p>
      <div class="permissions-grid" id="permissions-grid">
        ${l.sheetIds.map(o=>`
          <div class="perm-sheet">
            <strong>${w(l.sheetNames[o]||o.slice(0,8))}</strong>
            ${l.partyPlayers.map(i=>{var a,h;return`
              <label><input type="checkbox" data-perm-view="${o}" data-player="${i.id}" ${(((a=l.permissions[i.id])==null?void 0:a.view)||[]).includes(o)?"checked":""} /> ${w(i.name||i.id)} ${p("view")}</label>
              <label><input type="checkbox" data-perm-edit="${o}" data-player="${i.id}" ${(((h=l.permissions[i.id])==null?void 0:h.edit)||[]).includes(o)?"checked":""} /> ${p("edit")}</label>
            `}).join("")}
          </div>
        `).join("")}
      </div>
    `:"";return`
    <div class="card">
      <h2>${p("tabSettings")}</h2>
      <h3>${p("uiColors")}</h3>
      <div class="color-grid">
        <label>${p("color1")}<input type="color" value="${t.bg}" data-color="bg" ${e?"":"disabled"} /></label>
        <label>${p("color2")}<input type="color" value="${t.surface}" data-color="surface" ${e?"":"disabled"} /></label>
        <label>${p("color3")}<input type="color" value="${t.border}" data-color="border" ${e?"":"disabled"} /></label>
        <label>${p("color4")}<input type="color" value="${t.text}" data-color="text" ${e?"":"disabled"} /></label>
        <label>${p("color5")}<input type="color" value="${t.accent}" data-color="accent" ${e?"":"disabled"} /></label>
      </div>
      ${n}
      <div class="settings-actions">
        <button type="button" id="btn-export-sheet">${p("exportSheet")}</button>
        <button type="button" id="btn-import-sheet">${p("importSheet")}</button>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
      </div>
    </div>
  `}function uo(){switch(l.activeTab){case"bio":return It();case"stats":return no();case"spells":return so();case"inventory":return ao();case"chat":return ro();case"notes":return lo();case"settings":return co();default:return It()}}function Zt(){const t=document.documentElement;t.style.setProperty("--bg",l.colors.bg),t.style.setProperty("--surface",l.colors.surface),t.style.setProperty("--border",l.colors.border),t.style.setProperty("--text",l.colors.text),t.style.setProperty("--accent",l.colors.accent)}function R(){const t=document.getElementById(zt);t&&(t.innerHTML=`
    ${eo()}
    ${to()}
    <main class="tab-content">${uo()}</main>
  `,Zt(),fo())}function fo(){var o,i,a,h,u,c,r,f,_,E,T,I,M,L,$;const t=document.getElementById(zt);if(!t)return;(o=t.querySelector("#sheet-select"))==null||o.addEventListener("change",async d=>{const m=d.target.value||null;await de(m),S(),R()}),(i=t.querySelector("#btn-new-sheet"))==null||i.addEventListener("click",async()=>{const d=Ft();l.roomId=l.roomId||await Wt(),he(l.roomId,d),await Ye(d.id,Te(d)),l.sheetIds=await We(),l.sheetNames={...l.sheetNames,[d.id]:Te(d)},await de(d.id),R()}),(a=t.querySelector("#btn-link-token"))==null||a.addEventListener("click",async()=>{const d=await C.player.getSelection();if(!(d!=null&&d.length)){C.notification.show(p("noTokenSelected"));return}await St(d[0],l.activeSheetId);const m=await Q();l.tokenToSheet=m.tokenToSheet||{},R()}),t.querySelectorAll(".btn-unlink[data-token-id]").forEach(d=>{d.addEventListener("click",async()=>{await St(d.dataset.tokenId,null);const m=await Q();l.tokenToSheet=m.tokenToSheet||{},R()})}),t.querySelectorAll(".flag[data-lang]").forEach(d=>{d.addEventListener("click",async()=>{const m=d.dataset.lang;Ut(m),l.locale=m,localStorage.setItem("foxyverse_locale",m),await pe({locale:m}),R()})}),t.querySelectorAll(".tab[data-tab]").forEach(d=>{d.addEventListener("click",()=>{l.activeTab=d.dataset.tab,R()})}),t.querySelectorAll("[data-field]").forEach(d=>{d.addEventListener("change",m=>{if(!l.sheet)return;const y=m.target.dataset.field;let g=m.target.value;if(y==="bio.level"&&(g=parseInt(g,10)||1),y.startsWith("bio.")){const v=y.split(".")[1];l.sheet.bio||(l.sheet.bio={}),l.sheet.bio[v]=g}else l.sheet[y]=isNaN(Number(g))?g:Number(g);S()})}),t.querySelectorAll("[data-stat]").forEach(d=>{d.addEventListener("change",m=>{if(!l.sheet)return;const[y,g]=m.target.dataset.stat.split(".");l.sheet.stats[y]||(l.sheet.stats[y]={}),l.sheet.stats[y][g]=parseInt(m.target.value,10)||0,S(),l.activeTab==="stats"&&R()})}),(h=t.querySelector("#btn-add-knowledge"))==null||h.addEventListener("click",()=>{l.sheet&&(l.sheet.knowledge||(l.sheet.knowledge=[]),l.sheet.knowledge.push({id:crypto.randomUUID(),name:"",tier:1,enabled:!0}),S(),R())}),t.querySelectorAll("[data-remove-knowledge]").forEach(d=>{d.addEventListener("click",()=>{const m=parseInt(d.dataset.removeKnowledge,10);l.sheet.knowledge.splice(m,1),S(),R()})}),t.querySelectorAll("[data-knowledge-name], [data-knowledge-tier], [data-knowledge-enabled]").forEach(d=>{d.addEventListener("change",m=>{const y=m.target.dataset,g=parseInt(y.knowledgeName??y.knowledgeTier??y.knowledgeEnabled,10);if(isNaN(g)||!l.sheet.knowledge[g])return;const v=l.sheet.knowledge[g];y.knowledgeName!==void 0&&(v.name=m.target.value),y.knowledgeTier!==void 0&&(v.tier=parseInt(m.target.value,10)),y.knowledgeEnabled!==void 0&&(v.enabled=m.target.checked),S()})}),t.querySelectorAll(".btn-roll-stat").forEach(d=>{d.addEventListener("click",()=>{var m;l._rollStat=d.dataset.stat,l._rollDc=parseInt(d.dataset.dc,10),(m=document.getElementById("stat-roll-modal"))==null||m.classList.remove("hidden")})}),(u=t.querySelector("#stat-roll-do"))==null||u.addEventListener("click",()=>{var y,g,v;const d=((y=document.getElementById("stat-roll-modifier"))==null?void 0:y.value)||"",m=Kt(l._rollDc,d);l.lastRoll={kind:"stat",stat:l._rollStat,...m},l.lastRollPayload={type:"stat",stat:(g=l._rollStat)==null?void 0:g.replace("strength","str").replace("constitution","con").replace("intelligence","int").replace("perception","per").replace("social","soc").replace("agility","agi").replace("focus","foc"),expr:d},(v=document.getElementById("stat-roll-modal"))==null||v.classList.add("hidden"),e(l.lastRoll),C.notification.show(m.nat20?p("nat20"):m.nat1?p("nat1"):m.success?p("success"):p("failure"))}),(c=t.querySelector("#stat-roll-cancel"))==null||c.addEventListener("click",()=>{var d;(d=document.getElementById("stat-roll-modal"))==null||d.classList.add("hidden")}),(r=t.querySelector("#btn-roll-speed"))==null||r.addEventListener("click",()=>{if(!l.sheet)return;const d=K(l.sheet,"agility"),m=Math.floor(Math.random()*6)+1,y=As(l.sheet.speedModifier||""),g=Math.floor(d/4)+m+y;l.lastRoll={kind:"roll",value:g,rolls:[m]},l.lastRollPayload=null,e(l.lastRoll)}),t.querySelectorAll(".quick-mods button").forEach(d=>{d.addEventListener("click",m=>{const y=m.target.closest(".quick-mods").dataset.stat,g=m.target.dataset.mod,v={type:"stat",stat:y.replace("strength","str").replace("constitution","con").replace("intelligence","int").replace("perception","per").replace("social","soc").replace("agility","agi").replace("focus","foc"),expr:g},O=_e(v,l.sheet);l.lastRoll=O,l.lastRollPayload=v,e(O)})});function e(d){var O,b,B,V,me,lt;const m=document.getElementById("roll-modal"),y=document.getElementById("roll-result-text"),g=document.getElementById("roll-reroll-btn"),v=document.getElementById("roll-apply-buttons");!m||!y||(m.classList.remove("hidden"),d.kind==="stat"?y.textContent=`${p("dc")} ${d.dc}, ${p("result")}: ${d.roll}${d.mod?(d.mod>=0?"+":"")+d.mod:""} = ${d.total}. ${d.nat1?p("nat1"):d.nat20?p("nat20"):d.success?p("success"):p("failure")}`:y.textContent=`${p("result")}: ${d.value}${(O=d.rolls)!=null&&O.length?" ("+d.rolls.join(", ")+")":""}`,g.classList.toggle("hidden",!l.sheet||l.sheet.currentFavor<1||!Xs(d)),v&&(v.innerHTML="",v.classList.add("hidden"),l.sheet&&d.value!=null&&(d.kind==="pdmg"?(v.innerHTML=`<button type="button" id="roll-apply-pdmg">${p("applyDamage")} (${p("physicalDamage")})</button>`,v.classList.remove("hidden")):d.kind==="mdmg"?(v.innerHTML=`<button type="button" id="roll-apply-mdmg">${p("applyDamage")} (${p("magicDamage")})</button>`,v.classList.remove("hidden")):d.kind==="tdmg"?(v.innerHTML=`<button type="button" id="roll-apply-tdmg">${p("applyDamage")} (${p("trueDamage")})</button>`,v.classList.remove("hidden")):d.kind==="heal"?(v.innerHTML=`<button type="button" id="roll-apply-heal">${p("applyHeal")}</button>`,v.classList.remove("hidden")):d.kind==="theal"&&(v.innerHTML=`<button type="button" id="roll-apply-theal">${p("applyOverHeal")}</button>`,v.classList.remove("hidden"))),(b=v.querySelector("#roll-apply-pdmg"))==null||b.addEventListener("click",()=>{const Y=qs(l.sheet,l.lastRoll.value);Object.assign(l.sheet,Y),S(),R(),m.classList.add("hidden")}),(B=v.querySelector("#roll-apply-mdmg"))==null||B.addEventListener("click",()=>{const Y=js(l.sheet,l.lastRoll.value);Object.assign(l.sheet,Y),S(),R(),m.classList.add("hidden")}),(V=v.querySelector("#roll-apply-tdmg"))==null||V.addEventListener("click",()=>{const Y=Ws(l.sheet,l.lastRoll.value);Object.assign(l.sheet,Y),S(),R(),m.classList.add("hidden")}),(me=v.querySelector("#roll-apply-heal"))==null||me.addEventListener("click",()=>{const Y=qt(l.sheet),Qt=zs(l.sheet,l.lastRoll.value,Y);Object.assign(l.sheet,Qt),S(),R(),m.classList.add("hidden")}),(lt=v.querySelector("#roll-apply-theal"))==null||lt.addEventListener("click",()=>{const Y=Js(l.sheet,l.lastRoll.value);Object.assign(l.sheet,Y),S(),R(),m.classList.add("hidden")})))}(f=t.querySelector("#roll-close-btn"))==null||f.addEventListener("click",()=>{var d;return(d=document.getElementById("roll-modal"))==null?void 0:d.classList.add("hidden")}),(_=t.querySelector("#roll-reroll-btn"))==null||_.addEventListener("click",()=>{if(!l.sheet||l.sheet.currentFavor<1)return;l.sheet.currentFavor--,S();const d=_e(l.lastRollPayload,l.sheet);l.lastRoll=d,e(d),R()}),(E=t.querySelector("#btn-add-spell"))==null||E.addEventListener("click",()=>{l.sheet&&(l.sheet.spells||(l.sheet.spells=[]),l.sheet.spells.push({id:crypto.randomUUID(),name:"",effect:"",cost:0,costType:"mp"}),S(),R())}),t.querySelectorAll("[data-remove-spell]").forEach(d=>{d.addEventListener("click",()=>{const m=parseInt(d.dataset.removeSpell,10);l.sheet.spells.splice(m,1),S(),R()})}),t.querySelectorAll("[data-spell-name], [data-spell-effect], [data-spell-cost]").forEach(d=>{d.addEventListener("change",m=>{const y=parseInt(d.dataset.spellName??d.dataset.spellEffect??d.dataset.spellCost,10),g=l.sheet.spells[y];d.dataset.spellName!==void 0&&(g.name=m.target.value),d.dataset.spellEffect!==void 0&&(g.effect=m.target.value),d.dataset.spellCost!==void 0&&(g.cost=parseInt(m.target.value,10)||0),S()})}),t.querySelectorAll("[name^='costType-']").forEach(d=>{d.addEventListener("change",m=>{const y=parseInt(m.target.name.replace("costType-",""),10);l.sheet.spells[y].costType=m.target.value,S()})}),t.querySelectorAll(".btn-deduct-cost").forEach(d=>{d.addEventListener("click",()=>{const m=parseInt(d.dataset.idx,10),y=l.sheet.spells[m],g=y.cost||0;if((y.costType||"mp")==="mp"){const O=l.sheet.currentMP||0;if(O>=g)l.sheet.currentMP=O-g;else{const b=g-O;if(!confirm(p("confirmUseHP")))return;l.sheet.currentMP=0,l.sheet.currentHP=Math.max(0,(l.sheet.currentHP||0)-b)}}else l.sheet.currentHP=Math.max(0,(l.sheet.currentHP||0)-g);S(),R()})}),t.querySelectorAll(".equip-select").forEach(d=>{d.addEventListener("change",m=>{var O;const y=d.dataset.slot,g=m.target.value||null;if(!l.sheet)return;const v={...l.sheet.equipped||{}};if(g){Object.keys(v).forEach(B=>{v[B]===g&&delete v[B]}),v[y]=g;const b=it(l.sheet,g);(O=b==null?void 0:b.equippableSlots)!=null&&O.length&&b.equippableSlots.forEach(B=>{v[B]=g})}else{const b=v[y];delete v[y],b&&Object.keys(v).forEach(B=>{v[B]===b&&delete v[B]})}l.sheet.equipped=v,S(),R()})}),t.querySelectorAll("[data-toggle-item]").forEach(d=>{d.addEventListener("click",()=>{const m=d.dataset.toggleItem,y=document.getElementById("item-detail-"+m);y&&y.classList.toggle("hidden")})}),t.querySelectorAll("[data-item-name], [data-item-count]").forEach(d=>{d.addEventListener("change",m=>{var B,V;const y=d.dataset.itemName??d.dataset.itemCount,g=y.lastIndexOf("-"),v=y.slice(0,g),O=parseInt(y.slice(g+1),10);if(!((V=(B=l.sheet)==null?void 0:B[v])!=null&&V[O]))return;const b=l.sheet[v][O];d.dataset.itemName!==void 0&&(b.name=m.target.value),d.dataset.itemCount!==void 0&&(b.count=parseInt(m.target.value,10)||0),S()})}),t.querySelectorAll("[data-item-desc]").forEach(d=>{d.addEventListener("change",m=>{var b,B;const y=d.dataset.itemDesc,g=y.lastIndexOf("-"),v=y.slice(0,g),O=parseInt(y.slice(g+1),10);(B=(b=l.sheet)==null?void 0:b[v])!=null&&B[O]&&(l.sheet[v][O].description=m.target.value,S())})}),t.querySelectorAll("[data-item-weapon-slots], [data-item-defense], [data-item-magdef]").forEach(d=>{d.addEventListener("change",m=>{var B,V;const y=d.dataset.itemWeaponSlots||d.dataset.itemDefense||d.dataset.itemMagdef||"",g=y.lastIndexOf("-"),v=y.slice(0,g),O=parseInt(y.slice(g+1),10);if(!((V=(B=l.sheet)==null?void 0:B[v])!=null&&V[O]))return;const b=l.sheet[v][O];d.dataset.itemWeaponSlots!==void 0&&(b.weaponSlots=parseInt(m.target.value,10)||1),d.dataset.itemDefense!==void 0&&(b.defense=m.target.value===""?void 0:parseInt(m.target.value,10)),d.dataset.itemMagdef!==void 0&&(b.magicalDefense=m.target.value===""?void 0:parseInt(m.target.value,10)),S()})}),t.querySelectorAll("[data-item-equip-slots]").forEach(d=>{d.addEventListener("change",m=>{var B,V;const y=d.dataset.itemEquipSlots,g=y.lastIndexOf("-"),v=y.slice(0,g),O=parseInt(y.slice(g+1),10);if(!((V=(B=l.sheet)==null?void 0:B[v])!=null&&V[O]))return;const b=(m.target.value||"").split(",").map(me=>me.trim()).filter(Boolean);l.sheet[v][O].equippableSlots=b,S()})}),t.querySelectorAll("[data-remove-item]").forEach(d=>{d.addEventListener("click",()=>{const m=d.dataset.removeItem,y=m.lastIndexOf("-"),g=m.slice(0,y),v=parseInt(m.slice(y+1),10);l.sheet[g]&&l.sheet[g].splice(v,1),S(),R()})}),t.querySelectorAll(".btn-add-item").forEach(d=>{d.addEventListener("click",()=>{const m=d.dataset.section;l.sheet[m]||(l.sheet[m]=[]),l.sheet[m].push({id:crypto.randomUUID(),type:m==="weapons"?"weapon":m==="armor"?"armor":m==="consumables"?"consumable":m==="bags"?"bag":"other",name:"",count:1,description:""}),S(),R()})}),(T=t.querySelector("#notes-area"))==null||T.addEventListener("change",d=>{l.sheet&&(l.sheet.notes=d.target.value,S())});const n=t.querySelector("#chat-input");(I=t.querySelector("#chat-send"))==null||I.addEventListener("click",s),n==null||n.addEventListener("keydown",d=>{d.key==="Enter"&&s()});function s(){var v;const d=(v=n==null?void 0:n.value)==null?void 0:v.trim();if(!d)return;const m=Vs(d);if(m&&l.sheet){const O=_e(m,l.sheet);l.lastRoll=O,l.lastRollPayload=m,C.notification.show(String(O.value??O.roll??O.total??"")),C.broadcast.sendMessage("foxyverse",{type:"chat",from:l.playerName||"Player",body:d,result:O}).catch(()=>{})}else C.broadcast.sendMessage("foxyverse",{type:"chat",from:l.playerName||"Player",body:d}).catch(()=>{});n.value="",l.chatMessages.push({from:l.playerName||"Player",body:d});const y=l.chatHistoryKey+l.roomId;try{localStorage.setItem(y,JSON.stringify(l.chatMessages.slice(-200)))}catch{}const g=document.getElementById("chat-messages");g&&(g.innerHTML+=`<div class="chat-msg"><strong>${w(l.playerName||"You")}:</strong> <span class="chat-body">${Xt(d)}</span></div>`)}t.querySelectorAll("[data-color]").forEach(d=>{d.addEventListener("input",m=>{l.colors[m.target.dataset.color]=m.target.value,Zt(),localStorage.setItem("foxyverse_colors",JSON.stringify(l.colors))})}),t.querySelectorAll("[data-perm-view], [data-perm-edit]").forEach(d=>{d.addEventListener("change",async m=>{if(!l.isGM)return;const y=d.dataset.player,g=d.dataset.permView??d.dataset.permEdit,v=d.dataset.permView!==void 0?"view":"edit",O=JSON.parse(JSON.stringify(l.permissions));O[y]||(O[y]={view:[],edit:[]});const b=O[y][v]||[];m.target.checked?b.includes(g)||(O[y][v]=[...b,g]):O[y][v]=b.filter(B=>B!==g),await Is(O),l.permissions=O})}),(M=t.querySelector("#btn-export-sheet"))==null||M.addEventListener("click",()=>{if(!l.sheet)return;const d=new Blob([JSON.stringify(l.sheet,null,2)],{type:"application/json"}),m=document.createElement("a");m.href=URL.createObjectURL(d),m.download=`foxyverse-${l.sheet.id}.json`,m.click(),URL.revokeObjectURL(m.href)}),(L=t.querySelector("#btn-import-sheet"))==null||L.addEventListener("click",()=>{var d;return(d=document.getElementById("import-file-input"))==null?void 0:d.click()}),t.addEventListener("click",d=>{const m=d.target.closest(".inline-roll-btn");if(!m||!l.sheet)return;const y={type:m.dataset.type,expr:m.dataset.expr||"",stat:m.dataset.stat||void 0},g=_e(y,l.sheet);l.lastRoll=g,l.lastRollPayload=y,C.notification.show(g.value!=null?String(g.value):g.roll!=null?`${g.roll} (${g.success?p("success"):p("failure")})`:"")}),($=t.querySelector("#import-file-input"))==null||$.addEventListener("change",async d=>{var g;const m=(g=d.target.files)==null?void 0:g[0];if(!m||!l.roomId)return;const y=await m.text();try{const v=JSON.parse(y);v.id||(v.id=crypto.randomUUID()),he(l.roomId,v),await Ye(v.id,Te(v)),l.sheetIds=await We();const O=await Q();l.sheetNames=O.sheetNames||{},await de(v.id),R()}catch{C.notification.show("Invalid file")}d.target.value=""})}async function ho(){await Bt();const t=localStorage.getItem("foxyverse_colors");if(t)try{l.colors={...l.colors,...JSON.parse(t)}}catch{}l.playerName=await $s();try{l.partyPlayers=await C.party.getPlayers()}catch{l.partyPlayers=[]}const e=l.chatHistoryKey+l.roomId;try{const n=localStorage.getItem(e);n&&(l.chatMessages=JSON.parse(n))}catch{}l.sheetIds.length&&!l.activeSheetId?await de(Jt()[0]||null):l.activeSheetId&&await de(l.activeSheetId),R(),Ns(n=>{var s,o;if(((s=n.data)==null?void 0:s.type)==="sheet_full"&&n.data.roomId===l.roomId&&n.data.sheet&&(he(l.roomId,n.data.sheet),n.data.sheet.id===l.activeSheetId&&(l.sheet=n.data.sheet,R())),((o=n.data)==null?void 0:o.type)==="chat"){l.chatMessages.push({from:n.data.from,body:n.data.body});const i=document.getElementById("chat-messages");i&&l.activeTab==="chat"&&(i.innerHTML+=`<div class="chat-msg"><strong>${w(n.data.from)}:</strong> ${w(n.data.body)}</div>`)}}),C.room.onMetadataChange(async()=>{await Bt(),R()})}C.onReady(()=>{ho()});
